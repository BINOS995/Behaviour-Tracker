<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Performance Tracker</title>
    
    <!-- Prevent caching to ensure auth checks work on back button -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, getDoc, deleteDoc, onSnapshot, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBNGdPWISw803XD8xVo0RyCGoGpNX8o_jM",
            authDomain: "dpointslogin.firebaseapp.com",
            projectId: "dpointslogin",
            storageBucket: "dpointslogin.firebasestorage.app",
            messagingSenderId: "486203348613",
            appId: "1:486203348613:web:a22083bc80b9326bc73bec"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Make Firebase services globally available
        window.firebaseApp = app;
        window.firebaseAuth = auth;
        window.firebaseDB = db;
        window.firebaseFirestore = {
            collection,
            doc,
            setDoc,
            getDoc,
            deleteDoc,
            onSnapshot,
            getDocs
        };

        // Initialize admin status
        window.isAdmin = false;
        let adminListener = null;
        
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                try {
                    // Check admin status
                    const adminDoc = await getDoc(doc(db, 'admins', user.uid));
                    window.isAdmin = adminDoc.exists();
                    
                    // Show/hide admin button based on admin status
                    const adminBtn = document.getElementById('adminBtn');
                    if (adminBtn) {
                        adminBtn.style.display = window.isAdmin ? 'flex' : 'none';
                    }
                    
                    // Load admin list if current user is admin
                    if (window.isAdmin) {
                        loadAdminList();
                        
                        // Set up real-time listener for admin changes
                        if (adminListener) {
                            adminListener();
                        }
                        
                        adminListener = onSnapshot(collection(db, 'admins'), (snapshot) => {
                            // Reload admin list when changes occur
                            if (window.isAdmin) {
                                loadAdminList();
                            }
                        });
                    }
                } catch (error) {
                    console.error('Error checking admin status:', error);
                    window.isAdmin = false;
                }
            } else {
                // Clean up listener when user logs out
                if (adminListener) {
                    adminListener();
                    adminListener = null;
                }
            }
        });
    </script>
    
    <style>
        .class-content-blur {
            filter: blur(12px);
            pointer-events: none;
            user-select: none;
            transition: filter 0.3s;
        }
        .class-content-unblur {
            filter: none;
            pointer-events: auto;
            user-select: auto;
            transition: filter 0.3s;
        }
    </style>
</head>
<body class="bg-gray-50 font-sans">
<div class="flex min-h-screen">
    <!-- Sidebar -->
    <aside class="w-64 bg-white shadow-lg">
        <div class="p-6">
            <h1 class="text-2xl font-bold text-gray-800">Behaviour Tracker</h1>
        </div>
        
        <nav class="px-4">
            <button class="flex items-center gap-3 w-full px-4 py-3 mb-2 text-white bg-purple-500 rounded-lg hover:bg-purple-600" data-content="Dashboard">
                <i class="fas fa-home"></i> Dashboard
            </button>
            
            <button id="adminBtn" class="flex items-center gap-3 w-full px-4 py-3 mb-2 text-white bg-green-500 rounded-lg hover:bg-green-600" style="display:none;" data-content="Admin">
                <i class="fas fa-user-shield"></i> Admin
            </button>
            
            <div class="mb-4">
                <button id="classesDropdownBtn" class="flex items-center justify-between w-full px-4 py-3 text-gray-700 hover:bg-gray-100 rounded-lg">
                    <span><i class="fas fa-chalkboard-teacher mr-2"></i>Classes</span>
                    <i class="fas fa-chevron-down"></i>
                </button>
                <div id="classesDropdownMenu" class="hidden mt-2 ml-4">
                    <!-- Classes will be loaded here -->
                </div>
            </div>
            
            <button class="flex items-center gap-3 w-full px-4 py-3 text-gray-700 hover:bg-gray-100 rounded-lg" data-content="Logout">
                <i class="fas fa-sign-out-alt"></i> Logout
            </button>
        </nav>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 p-8">
        <div id="content" class="max-w-7xl mx-auto">
            <!-- Content will be dynamically loaded here -->
        </div>
    </main>
</div>

<!-- Password Modal -->
<div id="passwordModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
    <div class="bg-white p-8 rounded-xl max-w-md w-full mx-4">
        <h3 class="text-xl font-bold mb-4">Enter Class Password</h3>
        <input type="password" id="classPasswordInput" class="w-full px-3 py-2 border border-gray-300 rounded-lg mb-4" placeholder="Enter password">
        <div class="flex gap-4">
            <button id="submitPassword" class="flex-1 bg-purple-500 text-white py-2 rounded-lg hover:bg-purple-600">Submit</button>
            <button id="cancelPassword" class="flex-1 bg-gray-300 text-gray-700 py-2 rounded-lg hover:bg-gray-400">Cancel</button>
        </div>
        <p id="passwordError" class="text-red-500 mt-2 hidden">Incorrect password. Please try again.</p>
    </div>
</div>

<script>
    // Global variables
    let currentClass = '';
    let adminClassPasswords = {};
    
    // Tab content management
    const tabContent = {
        "Dashboard": `
            <div class="bg-white rounded-xl shadow-sm p-6 mb-6">
                <h1 class="text-3xl font-bold text-gray-800 mb-2">Welcome back!</h1>
                <p class="text-gray-600">Track student behavior and performance across different classes.</p>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
                <div class="bg-gradient-to-r from-purple-500 to-pink-500 rounded-xl p-6 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-purple-100 text-sm">Total Classes</p>
                            <p class="text-3xl font-bold" id="totalClasses">0</p>
                        </div>
                        <i class="fas fa-chalkboard-teacher text-3xl opacity-75"></i>
                    </div>
                </div>
                
                <div class="bg-gradient-to-r from-blue-500 to-cyan-500 rounded-xl p-6 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-blue-100 text-sm">Active Students</p>
                            <p class="text-3xl font-bold" id="totalStudents">0</p>
                        </div>
                        <i class="fas fa-users text-3xl opacity-75"></i>
                    </div>
                </div>
                
                <div class="bg-gradient-to-r from-green-500 to-emerald-500 rounded-xl p-6 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-green-100 text-sm">Positive Points</p>
                            <p class="text-3xl font-bold" id="totalPoints">0</p>
                        </div>
                        <i class="fas fa-star text-3xl opacity-75"></i>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-sm p-6">
                <h2 class="text-xl font-bold text-gray-800 mb-4">Quick Actions</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <button class="bg-purple-500 text-white py-3 rounded-lg hover:bg-purple-600 transition-colors">
                        <i class="fas fa-plus mr-2"></i>Add New Student
                    </button>
                    <button class="bg-blue-500 text-white py-3 rounded-lg hover:bg-blue-600 transition-colors">
                        <i class="fas fa-chart-bar mr-2"></i>View Reports
                    </button>
                </div>
            </div>
        `,
        "Admin": `
            <div class="bg-white rounded-xl shadow-sm p-6">
                <h1 class="text-2xl font-bold text-gray-800 mb-6">Admin Panel</h1>
                
                <!-- Admin Management Section -->
                <div class="mb-8">
                    <h2 class="text-lg font-semibold text-gray-700 mb-4">Admin Management</h2>
                    <div class="bg-gray-50 rounded-lg p-4 mb-4">
                        <h3 class="text-md font-medium text-gray-800 mb-3">Grant Admin Privileges</h3>
                        <div class="flex gap-2">
                            <input type="email" id="adminEmailInput" class="flex-1 px-3 py-2 border border-gray-300 rounded-lg" placeholder="Enter user email">
                            <button onclick="grantAdminPrivileges()" class="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600">
                                <i class="fas fa-user-plus mr-1"></i>Grant Admin
                            </button>
                        </div>
                    </div>
                    
                    <div class="bg-gray-50 rounded-lg p-4">
                        <h3 class="text-md font-medium text-gray-800 mb-3">Current Admins</h3>
                        <div id="adminList" class="space-y-2">
                            <!-- Admins will be loaded here -->
                        </div>
                    </div>
                </div>
                
                <div class="mb-6">
                    <h2 class="text-lg font-semibold text-gray-700 mb-4">Manage Classes</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Class Name</label>
                            <input type="text" id="newClassName" class="w-full px-3 py-2 border border-gray-300 rounded-lg" placeholder="Enter class name">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Password</label>
                            <input type="password" id="newClassPassword" class="w-full px-3 py-2 border border-gray-300 rounded-lg" placeholder="Enter password">
                        </div>
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Google Sheet URL</label>
                        <input type="url" id="newClassSheet" class="w-full px-3 py-2 border border-gray-300 rounded-lg" placeholder="https://docs.google.com/spreadsheets/d/...">
                        <p class="text-xs text-gray-500 mt-1">Paste the Google Sheets URL for behavior tracking</p>
                    </div>
                    <button id="addClassBtn" class="bg-purple-500 text-white px-4 py-2 rounded-lg hover:bg-purple-600">
                        <i class="fas fa-plus mr-2"></i>Add Class
                    </button>
                </div>

                <div>
                    <h3 class="text-lg font-semibold text-gray-700 mb-4">Existing Classes</h3>
                    <div id="classesList" class="space-y-3">
                        <p class="text-gray-500">Loading classes...</p>
                    </div>
                </div>
            </div>
        `,
        "Logout": `
            <div class="bg-white rounded-xl shadow-sm p-6 text-center">
                <h1 class="text-2xl font-bold text-gray-800 mb-4">Logging Out...</h1>
                <p class="text-gray-600">You will be redirected to the login page.</p>
            </div>
        `
    };

    // Load classes from Firestore
    async function loadClasses() {
        try {
            console.log('Loading classes from Firestore...');
            const classesRef = window.firebaseFirestore.collection(window.firebaseDB, 'classes');
            const snapshot = await window.firebaseFirestore.getDocs(classesRef);
            adminClassPasswords = {};
            
            console.log(`Found ${snapshot.size} classes`);
            
            if (snapshot.empty) {
                console.log('No classes found in Firestore');
                adminClassPasswords = {};
            } else {
                snapshot.forEach(doc => {
                    const classData = doc.data();
                    adminClassPasswords[doc.id] = {
                        password: classData.password,
                        sheetUrl: classData.sheetUrl
                    };
                    console.log(`Loaded class: ${doc.id}`);
                });
            }
            
            updateClassesList();
            updateTabContentWithClasses();
        } catch (error) {
            console.error('Error loading classes:', error);
            // Show error in the classes list
            const classesList = document.getElementById('classesList');
            if (classesList) {
                classesList.innerHTML = `
                    <div class="text-red-500 p-4 bg-red-50 rounded-lg">
                        <strong>Error loading classes:</strong><br>
                        ${error.message}<br><br>
                        <small>Check console for details</small>
                    </div>
                `;
            }
        }
    }

    // Update classes list in admin panel
    function updateClassesList() {
        const classesList = document.getElementById('classesList');
        if (!classesList) return;

        classesList.innerHTML = '';
        
        const classes = Object.keys(adminClassPasswords);
        if (classes.length === 0) {
            classesList.innerHTML = '<p class="text-gray-500">No classes created yet. Add a class above to get started.</p>';
            return;
        }
        
        classes.forEach(className => {
            const classData = adminClassPasswords[className];
            const classItem = document.createElement('div');
            classItem.className = 'flex items-center justify-between p-4 bg-gray-50 rounded-lg';
            classItem.innerHTML = `
                <div class="flex-1">
                    <div class="flex items-center mb-2">
                        <span class="font-medium text-lg">${className}</span>
                        <span class="text-sm text-gray-500 ml-2">(Password protected)</span>
                    </div>
                    <div class="text-sm text-gray-600 mb-2">
                        <strong>Password:</strong>
                        <span class="password-display ml-2 font-mono text-xs bg-gray-200 px-2 py-1 rounded" data-password="${classData.password}">
                            ${'*'.repeat(classData.password.length)}
                        </span>
                        <button class="show-password-btn ml-2 text-blue-500 hover:text-blue-700" onclick="togglePasswordVisibility(this)">
                            <i class="fas fa-eye"></i>
                        </button>
                    </div>
                    <div class="text-sm text-gray-600">
                        <strong>Sheet URL:</strong>
                        ${classData.sheetUrl ? `
                        <a href="${classData.sheetUrl}" target="_blank" class="text-blue-600 hover:underline ml-1">
                            ${classData.sheetUrl.length > 50 ? classData.sheetUrl.substring(0, 50) + '...' : classData.sheetUrl}
                        </a>
                        ` : '<span class="text-gray-400 ml-1">No sheet URL provided</span>'}
                    </div>
                </div>
                <div class="ml-4">
                    <button class="text-red-500 hover:text-red-700 p-2" onclick="removeClass('${className}')">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            `;
            classesList.appendChild(classItem);
        });
    }

    // Add new class
    async function addNewClass() {
        const className = document.getElementById('newClassName').value.trim();
        const password = document.getElementById('newClassPassword').value.trim();
        const sheetUrl = document.getElementById('newClassSheet').value.trim();

        if (!className || !password) {
            alert('Please enter both class name and password');
            return;
        }

        if (!sheetUrl) {
            alert('Please enter a Google Sheet URL');
            return;
        }

        // Validate Google Sheets URL
        if (!sheetUrl.includes('docs.google.com/spreadsheets')) {
            alert('Please enter a valid Google Sheets URL');
            return;
        }

        try {
            // Show loading state
            const addBtn = document.getElementById('addClassBtn');
            const originalText = addBtn.innerHTML;
            addBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Adding...';
            addBtn.disabled = true;

            const classRef = window.firebaseFirestore.doc(window.firebaseDB, 'classes', className);
            await window.firebaseFirestore.setDoc(classRef, {
                password: password,
                sheetUrl: sheetUrl,
                createdAt: new Date().toISOString()
            });

            // Clear fields
            document.getElementById('newClassName').value = '';
            document.getElementById('newClassPassword').value = '';
            document.getElementById('newClassSheet').value = '';
            
            // Success prompt
            alert(`✅ Class "${className}" has been successfully created!`);
            
            // Restore button state
            addBtn.innerHTML = originalText;
            addBtn.disabled = false;
            
        } catch (error) {
            console.error('Error adding class:', error);
            alert('Error adding class. Please try again.');
            
            // Restore button state on error
            const addBtn = document.getElementById('addClassBtn');
            addBtn.innerHTML = '<i class="fas fa-plus mr-2"></i>Add Class';
            addBtn.disabled = false;
        }
    }

    // Remove class
    async function removeClass(className) {
        if (!confirm(`Are you sure you want to remove ${className}?`)) return;

        try {
            await window.firebaseFirestore.deleteDoc(window.firebaseFirestore.doc(window.firebaseDB, 'classes', className));
            loadClasses(); // Reload classes
        } catch (error) {
            console.error('Error removing class:', error);
            alert('Error removing class. Please try again.');
        }
    }

    // Update tab content with dynamic classes
    function updateTabContentWithClasses() {
        // Remove old class entries from tabContent
        Object.keys(tabContent).forEach(key => {
            if (key !== 'Dashboard' && key !== 'Admin' && key !== 'Logout') {
                delete tabContent[key];
            }
        });

        // Add new classes from Firestore
        Object.keys(adminClassPasswords).forEach(className => {
            tabContent[className] = createClassContent(className);
        });

        // Update sidebar navigation
        updateSidebarNavigation();
    }

    // Create content for a specific class
    function createClassContent(className) {
        const classData = adminClassPasswords[className];
        const sheetUrl = classData?.sheetUrl || '';
        
        // Convert Google Sheets URL to embed format
        let embedUrl = '';
        if (sheetUrl) {
            const match = sheetUrl.match(/\/spreadsheets\/d\/([a-zA-Z0-9-_]+)/);
            if (match) {
                embedUrl = `https://docs.google.com/spreadsheets/d/${match[1]}/edit?usp=sharing&rm=minimal`;
            }
        }

        return `
            <div class="bg-white rounded-xl shadow-sm p-6">
                <div class="flex items-center justify-between mb-6">
                    <h1 class="text-2xl font-bold text-gray-800">${className}</h1>
                    <button onclick="showAddStudentModal('${className}')" class="bg-purple-500 text-white px-4 py-2 rounded-lg hover:bg-purple-600">
                        <i class="fas fa-plus mr-2"></i>Add Student
                    </button>
                </div>

                <div class="class-content-blur" id="${className}-content">
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div class="lg:col-span-2">
                            <div class="bg-gray-50 rounded-xl p-4 mb-6">
                                <h3 class="text-lg font-semibold text-gray-700 mb-4">Behavior Tracker</h3>
                                ${embedUrl ? `
                                <div class="border border-gray-300 rounded-lg overflow-hidden" style="height: 600px;">
                                    <iframe 
                                        src="${embedUrl}" 
                                        width="100%" 
                                        height="100%" 
                                        frameborder="0"
                                        style="border:0;"
                                        allowfullscreen>
                                    </iframe>
                                </div>
                                ` : '<p class="text-gray-500">No Google Sheet configured for this class.</p>'}
                            </div>
                            
                            <div class="bg-gray-50 rounded-xl p-4">
                                <h3 class="text-lg font-semibold text-gray-700 mb-4">Students</h3>
                                <div id="${className}-students" class="space-y-3">
                                    <p class="text-gray-500">No students added yet.</p>
                                </div>
                            </div>
                        </div>
                        
                        <div>
                            <div class="bg-gray-50 rounded-xl p-4 mb-4">
                                <h3 class="text-lg font-semibold text-gray-700 mb-4">Class Stats</h3>
                                <div class="space-y-2">
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">Total Students:</span>
                                        <span class="font-semibold" id="${className}-count">0</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">Average Points:</span>
                                        <span class="font-semibold" id="${className}-avg">0</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="bg-gray-50 rounded-xl p-4">
                                <h3 class="text-lg font-semibold text-gray-700 mb-4">Performance Chart</h3>
                                <canvas id="${className}-chart" width="300" height="200"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }

    // Update sidebar navigation with dynamic classes
    function updateSidebarNavigation() {
        const classesDropdownMenu = document.getElementById('classesDropdownMenu');
        if (!classesDropdownMenu) return;

        classesDropdownMenu.innerHTML = '';
        
        Object.keys(adminClassPasswords).forEach(className => {
            const classButton = document.createElement('button');
            classButton.className = 'class-btn flex items-center gap-2 w-full px-4 py-2 text-gray-700 hover:bg-gray-100 rounded-lg text-left';
            classButton.setAttribute('data-content', className);
            classButton.innerHTML = `<i class="fas fa-book"></i> ${className}`;
            classesDropdownMenu.appendChild(classButton);
        });

        setupClassButtons();
    }

    // Setup event listeners for class buttons
    function setupClassButtons() {
        document.querySelectorAll('[data-content]').forEach(button => {
            button.addEventListener('click', (e) => {
                const content = e.currentTarget.getAttribute('data-content');
                
                if (content === 'Logout') {
                    window.firebaseAuth.signOut(window.firebaseAuth).then(() => {
                        window.location.href = 'index.html';
                    });
                } else if (content === 'Classes') {
                    document.getElementById('classesDropdownMenu').classList.toggle('hidden');
                } else {
                    loadContent(content);
                }
            });
        });
    }

    // Show password modal
    function showPasswordModal(className) {
        currentClass = className;
        document.getElementById('passwordModal').classList.remove('hidden');
        document.getElementById('passwordModal').classList.add('flex');
        document.getElementById('classPasswordInput').value = '';
        document.getElementById('passwordError').classList.add('hidden');
        document.getElementById('classPasswordInput').focus();
    }

    // Hide password modal
    function hidePasswordModal() {
        document.getElementById('passwordModal').classList.add('hidden');
        document.getElementById('passwordModal').classList.remove('flex');
    }

    // Check password
    function checkPassword() {
        const enteredPassword = document.getElementById('classPasswordInput').value;
        const correctPassword = adminClassPasswords[currentClass]?.password;
        
        if (enteredPassword === correctPassword) {
            hidePasswordModal();
            const contentDiv = document.getElementById(`${currentClass}-content`);
            if (contentDiv) {
                contentDiv.classList.remove('class-content-blur');
                contentDiv.classList.add('class-content-unblur');
            }
        } else {
            document.getElementById('passwordError').classList.remove('hidden');
        }
    }

    // Load content
    function loadContent(content) {
        const contentDiv = document.getElementById('content');
        
        if (tabContent[content]) {
            contentDiv.innerHTML = tabContent[content];
            
            if (content !== 'Dashboard' && content !== 'Admin' && content !== 'Logout') {
                showPasswordModal(content);
            } else if (content === 'Dashboard') {
                updateDashboardStats();
            } else if (content === 'Admin') {
                // Ensure classes are loaded when admin panel is opened
                setTimeout(() => {
                    loadClasses();
                    // Attach event listener for Add Class button
                    const addClassBtn = document.getElementById('addClassBtn');
                    if (addClassBtn) {
                        // Remove any existing listener to prevent duplicates
                        addClassBtn.removeEventListener('click', addNewClass);
                        addClassBtn.addEventListener('click', addNewClass);
                    }
                    
                    // Load admin list when admin panel is opened
                    loadAdminList();
                }, 100);
            }
        }
    }

    // Update dashboard stats and welcome message
    async function updateDashboardStats() {
        document.getElementById('totalClasses').textContent = Object.keys(adminClassPasswords).length;
        document.getElementById('totalStudents').textContent = '0';
        document.getElementById('totalPoints').textContent = '0';
        
        // Update welcome message with user's first name
        const user = window.firebaseAuth.currentUser;
        if (user) {
            try {
                const userDoc = await window.firebaseFirestore.getDoc(
                    window.firebaseFirestore.doc(window.firebaseDB, 'users', user.uid)
                );
                if (userDoc.exists()) {
                    const userData = userDoc.data();
                    const welcomeElement = document.querySelector('#content h1');
                    if (welcomeElement) {
                        welcomeElement.textContent = `Welcome back, ${userData.firstName}!`;
                    }
                }
            } catch (error) {
                console.error('Error fetching user data:', error);
            }
        }
    }

    // Toggle password visibility
    function togglePasswordVisibility(button) {
        const passwordSpan = button.previousElementSibling;
        const password = passwordSpan.getAttribute('data-password');
        const icon = button.querySelector('i');
        
        if (passwordSpan.textContent.includes('*')) {
            passwordSpan.textContent = password;
            icon.className = 'fas fa-eye-slash';
        } else {
            passwordSpan.textContent = '*'.repeat(password.length);
            icon.className = 'fas fa-eye';
        }
    }

    // Update welcome message with user's first name
    async function updateWelcomeMessage() {
        const user = window.firebaseAuth.currentUser;
        if (user) {
            try {
                const userDoc = await window.firebaseFirestore.getDoc(
                    window.firebaseFirestore.doc(window.firebaseDB, 'users', user.uid)
                );
                if (userDoc.exists()) {
                    const userData = userDoc.data();
                    const welcomeElement = document.querySelector('#content h1');
                    if (welcomeElement) {
                        welcomeElement.textContent = `Welcome back, ${userData.firstName}!`;
                    }
                }
            } catch (error) {
                console.error('Error fetching user data:', error);
            }
        }
    }

    // Admin Management Functions
    async function grantAdminPrivileges() {
        const emailInput = document.getElementById('adminEmailInput');
        const email = emailInput.value.trim();
        
        if (!email) {
            alert('Please enter an email address');
            return;
        }
        
        if (!confirm(`Are you sure you want to grant admin privileges to ${email}?`)) {
            return;
        }
        
        try {
            // Find user by email
            const usersRef = window.firebaseFirestore.collection(window.firebaseDB, 'users');
            const usersSnapshot = await window.firebaseFirestore.getDocs(usersRef);
            let targetUser = null;
            
            usersSnapshot.forEach((doc) => {
                const userData = doc.data();
                if (userData.email === email) {
                    targetUser = { uid: doc.id, ...userData };
                }
            });
            
            if (!targetUser) {
                alert('User not found with this email address');
                return;
            }
            
            // Grant admin privileges
            await window.firebaseFirestore.setDoc(
                window.firebaseFirestore.doc(window.firebaseDB, 'admins', targetUser.uid),
                {
                    email: targetUser.email,
                    firstName: targetUser.firstName,
                    lastName: targetUser.lastName,
                    grantedBy: window.firebaseAuth.currentUser.uid,
                    grantedAt: new Date().toISOString()
                }
            );
            
            alert(`Admin privileges granted to ${targetUser.firstName} ${targetUser.lastName}`);
            emailInput.value = '';
            loadAdminList();
            
        } catch (error) {
            console.error('Error granting admin privileges:', error);
            alert('Error granting admin privileges. Please try again.');
        }
    }
    
    async function revokeAdminPrivileges(userId) {
        if (!confirm('Are you sure you want to revoke admin privileges?')) {
            return;
        }
        
        try {
            await window.firebaseFirestore.deleteDoc(
                window.firebaseFirestore.doc(window.firebaseDB, 'admins', userId)
            );
            
            alert('Admin privileges revoked successfully');
            loadAdminList();
            
        } catch (error) {
            console.error('Error revoking admin privileges:', error);
            alert('Error revoking admin privileges. Please try again.');
        }
    }
    
    async function initializeFirstAdmin() {
        try {
            const adminsRef = window.firebaseFirestore.collection(window.firebaseDB, 'admins');
            const adminsSnapshot = await window.firebaseFirestore.getDocs(adminsRef);
            
            if (adminsSnapshot.empty) {
                // Find the initial admin user
                const usersRef = window.firebaseFirestore.collection(window.firebaseDB, 'users');
                const usersSnapshot = await window.firebaseFirestore.getDocs(usersRef);
                let initialAdmin = null;
                
                usersSnapshot.forEach((doc) => {
                    const userData = doc.data();
                    if (userData.email === 'fobiblankson95@gmail.com') {
                        initialAdmin = { uid: doc.id, ...userData };
                    }
                });
                
                if (initialAdmin) {
                    await window.firebaseFirestore.setDoc(
                        window.firebaseFirestore.doc(window.firebaseDB, 'admins', initialAdmin.uid),
                        {
                            email: initialAdmin.email,
                            firstName: initialAdmin.firstName,
                            lastName: initialAdmin.lastName,
                            grantedBy: 'system',
                            grantedAt: new Date().toISOString(),
                            isInitialAdmin: true
                        }
                    );
                    console.log('Initial admin setup complete');
                }
            }
        } catch (error) {
            console.error('Error initializing first admin:', error);
        }
    }
    
    async function loadAdminList() {
        if (!window.isAdmin) return;
        
        try {
            const adminsRef = window.firebaseFirestore.collection(window.firebaseDB, 'admins');
            const adminsSnapshot = await window.firebaseFirestore.getDocs(adminsRef);
            
            const adminList = document.getElementById('adminList');
            adminList.innerHTML = '';
            
            if (adminsSnapshot.empty) {
                adminList.innerHTML = '<p class="text-gray-500">No admins found</p>';
                return;
            }
            
            adminsSnapshot.forEach((doc) => {
                const admin = doc.data();
                const adminDiv = document.createElement('div');
                adminDiv.className = 'flex justify-between items-center p-3 bg-white rounded-lg border';
                adminDiv.innerHTML = `
                    <div>
                        <p class="font-medium">${admin.firstName} ${admin.lastName}</p>
                        <p class="text-sm text-gray-600">${admin.email}</p>
                        <p class="text-xs text-gray-500">Granted: ${new Date(admin.grantedAt).toLocaleDateString()}</p>
                    </div>
                    ${doc.id !== window.firebaseAuth.currentUser.uid && !admin.isInitialAdmin ? 
                        `<button onclick="revokeAdminPrivileges('${doc.id}')" class="bg-red-500 text-white px-3 py-1 rounded text-sm hover:bg-red-600">
                            <i class="fas fa-user-times"></i> Revoke
                        </button>` :
                        '<span class="text-sm text-green-600">' + (admin.isInitialAdmin ? 'System Admin' : 'Current User') + '</span>'
                    }
                `;
                adminList.appendChild(adminDiv);
            });
            
        } catch (error) {
            console.error('Error loading admin list:', error);
        }
    }
    
    // Event listeners
    document.addEventListener('DOMContentLoaded', () => {
        // Check if user is authenticated
        const unsubscribe = window.firebaseAuth.onAuthStateChanged((user) => {
            if (!user) {
                // Redirect to login page if not authenticated
                window.location.href = 'index.html';
                return;
            }
            
            // Ensure Firebase is initialized before proceeding
            const checkFirebase = setInterval(() => {
                if (window.firebaseDB && window.firebaseFirestore) {
                    clearInterval(checkFirebase);
                    loadClasses();
                    
                    // Load dashboard by default
                loadContent('Dashboard');
                
                // Set up event listeners after ensuring elements exist
                setTimeout(() => {
                    setupClassButtons();
                    updateWelcomeMessage();
                    initializeFirstAdmin(); // Initialize first admin if needed
                }, 100);
                }
            }, 100);
            
            // Clean up the auth listener
            setTimeout(() => unsubscribe(), 1000);
        });
        
        const submitPassword = document.getElementById('submitPassword');
        if (submitPassword) submitPassword.addEventListener('click', checkPassword);
        
        const cancelPassword = document.getElementById('cancelPassword');
        if (cancelPassword) cancelPassword.addEventListener('click', hidePasswordModal);
        
        const classPasswordInput = document.getElementById('classPasswordInput');
        if (classPasswordInput) {
            classPasswordInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') checkPassword();
            });
        }
        
        const classesDropdownBtn = document.getElementById('classesDropdownBtn');
        if (classesDropdownBtn) {
            classesDropdownBtn.addEventListener('click', () => {
                document.getElementById('classesDropdownMenu').classList.toggle('hidden');
            });
        }

        // Listen for real-time updates
        if (window.firebaseFirestore) {
            const classesRef = window.firebaseFirestore.collection(window.firebaseDB, 'classes');
            window.firebaseFirestore.onSnapshot(classesRef, (snapshot) => {
                adminClassPasswords = {};
                snapshot.forEach(doc => {
                    const classData = doc.data();
                    adminClassPasswords[doc.id] = {
                        password: classData.password,
                        sheetUrl: classData.sheetUrl
                    };
                });
                updateClassesList();
                updateTabContentWithClasses();
                
                if (document.querySelector('[data-content="Dashboard"]')) {
                    updateDashboardStats();
                }
            });
        }
    });
</script>
</body>
</html>