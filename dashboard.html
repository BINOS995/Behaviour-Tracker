<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Performance Tracker</title>
    
    <!-- Prevent caching to ensure auth checks work on back button -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, getDoc, deleteDoc, onSnapshot, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBNGdPWISw803XD8xVo0RyCGoGpNX8o_jM",
            authDomain: "dpointslogin.firebaseapp.com",
            projectId: "dpointslogin",
            storageBucket: "dpointslogin.firebasestorage.app",
            messagingSenderId: "486203348613",
            appId: "1:486203348613:web:a22083bc80b9326bc73bec"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Make Firebase services globally available
        window.firebaseApp = app;
        window.firebaseAuth = auth;
        window.firebaseDB = db;
        window.firebaseFirestore = {
            collection,
            doc,
            setDoc,
            getDoc,
            deleteDoc,
            onSnapshot,
            getDocs
        };
        
        // Create a collection reference for best learners
        window.bestLearnersCollection = collection(db, 'bestLearners');

        // Initialize admin status
        window.isAdmin = false;
        let adminListener = null;
        
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                try {
                    // Check admin status
                    const adminDoc = await getDoc(doc(db, 'admins', user.uid));
                    window.isAdmin = adminDoc.exists();
                    
                    // Show/hide admin button based on admin status
                    const adminBtn = document.getElementById('adminBtn');
                    if (adminBtn) {
                        adminBtn.style.display = window.isAdmin ? 'flex' : 'none';
                    }
                    
                    // Load admin list if current user is admin
                    if (window.isAdmin) {
                        loadAdminList();
                        
                        // Set up real-time listener for admin changes
                        if (adminListener) {
                            adminListener();
                        }
                        
                        adminListener = onSnapshot(collection(db, 'admins'), (snapshot) => {
                            // Reload admin list when changes occur
                            if (window.isAdmin) {
                                loadAdminList();
                            }
                        });
                    }
                } catch (error) {
                    console.error('Error checking admin status:', error);
                    window.isAdmin = false;
                }
            } else {
                // Clean up listener when user logs out
                if (adminListener) {
                    adminListener();
                    adminListener = null;
                }
            }
        });
    </script>
    
    <!-- Additional diagnostic functions -->
    <script>
    // Comprehensive Firestore structure check
    async function checkFirestoreStructure() {
        try {
            console.log('=== COMPREHENSIVE FIRESTORE CHECK ===');
            
            // Check current authentication state
            const currentUser = window.firebaseAuth.currentUser;
            console.log('Current authenticated user:', currentUser?.email || 'No user logged in');
            
            // Check users collection
            const usersRef = window.firebaseFirestore.collection(window.firebaseDB, 'users');
            const usersSnapshot = await window.firebaseFirestore.getDocs(usersRef);
            
            console.log('=== USERS COLLECTION ANALYSIS ===');
            console.log('Total documents in users collection:', usersSnapshot.size);
            
            if (usersSnapshot.empty) {
                console.log('‚ùå USERS COLLECTION IS EMPTY!');
                alert('‚ùå No users found in Firestore! The users collection is completely empty.');
                return;
            }
            
            const allUsers = [];
            let validUsers = 0;
            let invalidUsers = 0;
            
            usersSnapshot.forEach(doc => {
                const userData = doc.data();
                const docId = doc.id;
                
                const userInfo = {
                    documentId: docId,
                    documentData: userData,
                    hasEmail: !!userData.email,
                    hasFirstName: !!userData.firstName,
                    hasLastName: !!userData.lastName,
                    dataKeys: Object.keys(userData || {}),
                    dataValues: Object.values(userData || {}),
                    isValid: !!(userData.email && userData.firstName && userData.lastName)
                };
                
                allUsers.push(userInfo);
                
                if (userInfo.isValid) {
                    validUsers++;
                } else {
                    invalidUsers++;
                }
                
                console.log(`Document ID: "${docId}"`);
                console.log(`  Email: ${userData.email || 'MISSING'}`);
                console.log(`  First Name: ${userData.firstName || 'MISSING'}`);
                console.log(`  Last Name: ${userData.lastName || 'MISSING'}`);
                console.log(`  Data Keys: [${Object.keys(userData || {}).join(', ')}]`);
                console.log(`  Status: ${userInfo.isValid ? '‚úÖ VALID' : '‚ùå INVALID'}`);
                console.log('---');
            });
            
            // Create detailed report
            const report = {
                totalDocuments: usersSnapshot.size,
                validUsers: validUsers,
                invalidUsers: invalidUsers,
                allUsers: allUsers
            };
            
            console.log('=== FIRESTORE SUMMARY ===');
            console.log('Total documents:', report.totalDocuments);
            console.log('Valid users:', report.validUsers);
            console.log('Invalid users:', report.invalidUsers);
            console.log('Complete data:', JSON.stringify(report, null, 2));
            
            // Display alert with findings
            let alertMessage = `üìä FIRESTORE ANALYSIS RESULTS:

üìà Collection Stats:
‚Ä¢ Total documents: ${report.totalDocuments}
‚Ä¢ Valid users: ${report.validUsers}
‚Ä¢ Invalid users: ${report.invalidUsers}

üîç Document IDs found:
`;
            
            allUsers.forEach(user => {
                alertMessage += `‚Ä¢ "${user.documentId}" (${user.isValid ? '‚úÖ Valid' : '‚ùå Invalid'})
`;
            });
            
            if (invalidUsers > 0) {
                alertMessage += `
‚ö†Ô∏è INVALID USERS FOUND:
These documents are missing required fields (email, firstName, lastName).
Check the console for detailed information about each invalid user.
`;
            }
            
            alertMessage += `
üí° Next Steps:
1. Check the browser console for complete details
2. Verify user creation process
3. Check if new users are being created with correct field names
4. Ensure document IDs match expected format (email addresses)

üîó Firebase Console Link:
https://console.firebase.google.com/project/your-project-id/firestore/data/~2Fusers

Replace 'your-project-id' with your actual Firebase project ID.`;
            
            alert(alertMessage);
            
            // Also check if we can access the authentication data
            try {
                console.log('=== AUTHENTICATION CHECK ===');
                if (currentUser) {
                    console.log('Current user email:', currentUser.email);
                    console.log('Current user UID:', currentUser.uid);
                    
                    // Check if current user exists in the users collection
                    const currentUserDoc = allUsers.find(u => u.documentId === currentUser.email);
                    if (currentUserDoc) {
                        console.log('‚úÖ Current user found in users collection');
                    } else {
                        console.log('‚ùå Current user NOT found in users collection');
                        console.log('Available document IDs:', allUsers.map(u => u.documentId));
                    }
                } else {
                    console.log('‚ùå No user currently logged in');
                }
            } catch (authError) {
                console.error('Error checking authentication:', authError);
            }
            
            console.log('=== FIRESTORE CHECK COMPLETE ===');
            
        } catch (error) {
            console.error('Error checking Firestore structure:', error);
            alert(`‚ùå Error checking Firestore: ${error.message}\n\nCheck the browser console for details.`);
        }
    }
    </script>
    
    <style>
        .class-content-blur {
            filter: blur(12px);
            pointer-events: none;
            user-select: none;
            transition: filter 0.3s;
        }
        .class-content-unblur {
            filter: none;
            pointer-events: auto;
            user-select: auto;
            transition: filter 0.3s;
        }
    </style>
</head>
<body class="bg-gray-50 font-sans">
<div class="flex flex-col md:flex-row min-h-screen">
    <!-- Mobile Header (visible on small screens) -->
    <div class="md:hidden bg-white shadow-sm p-4 flex items-center justify-between">
        <div class="flex items-center">
            <img src="images/logo1.png" alt="Behaviour Tracker" class="w-8 h-8 mr-2 rounded-lg">
            <h1 class="text-xl font-bold text-gray-800">Behaviour Tracker</h1>
        </div>
        <button id="mobileMenuBtn" class="text-gray-700 hover:bg-gray-100 p-2 rounded-lg">
            <i class="fas fa-bars"></i>
        </button>
    </div>

    <!-- Sidebar (hidden on mobile by default) -->
    <aside id="sidebar" class="w-full md:w-64 bg-white shadow-lg md:block hidden transition-all duration-300 ease-in-out">
        <div class="p-4 md:p-6 hidden md:block text-center">
            <img src="images/logo1.png" alt="Behaviour Tracker" class="w-16 h-16 mx-auto mb-2 rounded-lg">
            <h1 class="text-xl md:text-2xl font-bold text-gray-800">Behaviour Tracker</h1>
        </div>
        
        <nav class="px-4 py-2">
            <button class="flex items-center gap-3 w-full px-4 py-3 mb-2 text-white bg-purple-500 rounded-lg hover:bg-purple-600" data-content="Dashboard">
                <i class="fas fa-home"></i> Dashboard
            </button>
            
            <button id="adminBtn" class="flex items-center gap-3 w-full px-4 py-3 mb-2 text-white bg-green-500 rounded-lg hover:bg-green-600" style="display:none;" data-content="Admin">
                <i class="fas fa-user-shield"></i> Admin
            </button>
            
            <div class="mb-4">
                <button id="classesDropdownBtn" class="flex items-center justify-between w-full px-4 py-3 text-gray-700 hover:bg-gray-100 rounded-lg">
                    <span><i class="fas fa-chalkboard-teacher mr-2"></i>Classes</span>
                    <i class="fas fa-chevron-down"></i>
                </button>
                <div id="classesDropdownMenu" class="hidden mt-2 ml-4">
                    <!-- Classes will be loaded here -->
                </div>
            </div>
            
            <button class="flex items-center gap-3 w-full px-4 py-3 text-gray-700 hover:bg-gray-100 rounded-lg" data-content="Logout">
                <i class="fas fa-sign-out-alt"></i> Logout
            </button>
        </nav>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 p-4 md:p-6 lg:p-8">
        <div id="content" class="max-w-7xl mx-auto">
            <!-- Content will be dynamically loaded here -->
        </div>
    </main>
</div>

<!-- Password Modal -->
<div id="passwordModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
    <div class="bg-white p-8 rounded-xl max-w-md w-full mx-4">
        <h3 class="text-xl font-bold mb-4">Enter Class Password</h3>
        <input type="password" id="classPasswordInput" class="w-full px-3 py-2 border border-gray-300 rounded-lg mb-4" placeholder="Enter password">
        <div class="flex gap-4">
            <button id="submitPassword" class="flex-1 bg-purple-500 text-white py-2 rounded-lg hover:bg-purple-600">Submit</button>
            <button id="cancelPassword" class="flex-1 bg-gray-300 text-gray-700 py-2 rounded-lg hover:bg-gray-400">Cancel</button>
        </div>
        <p id="passwordError" class="text-red-500 mt-2 hidden">Incorrect password. Please try again.</p>
    </div>
</div>

<script>
    // Global variables
    let currentClass = '';
    let adminClassPasswords = {};
    
    // Mobile menu toggle
    document.addEventListener('DOMContentLoaded', function() {
        const mobileMenuBtn = document.getElementById('mobileMenuBtn');
        const sidebar = document.getElementById('sidebar');
        
        if (mobileMenuBtn && sidebar) {
            mobileMenuBtn.addEventListener('click', function() {
                sidebar.classList.toggle('hidden');
            });
            
            // Close sidebar when clicking on a menu item (mobile only)
            const menuItems = sidebar.querySelectorAll('button[data-content]');
            menuItems.forEach(item => {
                item.addEventListener('click', function() {
                    if (window.innerWidth < 768) { // md breakpoint
                        sidebar.classList.add('hidden');
                    }
                });
            });
        }
    });
    
    // Tab content management
    const tabContent = {
        "Dashboard": `
            <div class="bg-white rounded-xl shadow-sm p-6 mb-6">
                <div class="flex items-center mb-4">
                    <img src="images/logo1.png" alt="Behaviour Tracker" class="w-12 h-12 mr-3 rounded-lg">
                    <div>
                        <h1 class="text-3xl font-bold text-gray-800 mb-1">Welcome back!</h1>
                        <p class="text-gray-600">Track student behavior and performance across different classes.</p>
                    </div>
                </div>
            </div>
            

            
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 md:gap-6 mb-8">
                <div class="bg-gradient-to-r from-purple-500 to-pink-500 rounded-xl p-4 md:p-6 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-purple-100 text-xs sm:text-sm">Total Classes</p>
                            <p class="text-2xl md:text-3xl font-bold" id="totalClasses">0</p>
                        </div>
                        <i class="fas fa-chalkboard-teacher text-2xl md:text-3xl opacity-75"></i>
                    </div>
                </div>
                
                <div class="bg-gradient-to-r from-blue-500 to-cyan-500 rounded-xl p-4 md:p-6 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-blue-100 text-xs sm:text-sm">Active Students</p>
                            <p class="text-2xl md:text-3xl font-bold" id="totalStudents">0</p>
                        </div>
                        <i class="fas fa-users text-2xl md:text-3xl opacity-75"></i>
                    </div>
                </div>
                
                <div class="bg-gradient-to-r from-green-500 to-emerald-500 rounded-xl p-4 md:p-6 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-green-100 text-xs sm:text-sm">Positive Points</p>
                            <p class="text-2xl md:text-3xl font-bold" id="totalPoints">0</p>
                        </div>
                        <i class="fas fa-star text-2xl md:text-3xl opacity-75"></i>
                    </div>
                </div>
            </div>

            <!-- Top Learners Section -->
            <div class="bg-white rounded-xl shadow-sm p-4 md:p-6 mb-6 md:mb-8">
                <h2 class="text-lg md:text-xl font-bold text-gray-800 mb-3 md:mb-4">
                    <i class="fas fa-trophy text-yellow-500 mr-2"></i> Top Learners By Class
                </h2>
                <div id="topLearnersContainer" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3 md:gap-4">
                    <p class="text-gray-500 italic col-span-full text-center py-4">No top learners data available yet</p>
                </div>
            </div>

            <!-- Quick Actions section removed -->
        `,
        "Admin": `
            <div class="bg-white rounded-xl shadow-sm p-4 md:p-6">
                <div class="flex flex-col md:flex-row items-center md:items-start gap-6 mb-6">
                    <div class="w-32 h-32 bg-gradient-to-br from-purple-500 to-pink-500 rounded-full flex items-center justify-center overflow-hidden">
                        <i class="fas fa-user-shield text-white text-5xl"></i>
                    </div>
                    <div>
                        <h1 class="text-2xl font-bold text-gray-800 mb-2">Admin Panel</h1>
                        <p class="text-gray-600 mb-2">Manage classes, admins, and system settings</p>
                        <div class="flex gap-2">
                            <span class="bg-green-100 text-green-800 text-xs font-medium px-2.5 py-0.5 rounded-full">Admin Access</span>
                            <span class="bg-blue-100 text-blue-800 text-xs font-medium px-2.5 py-0.5 rounded-full">Full Privileges</span>
                        </div>
                    </div>
                </div>
                
                <!-- Admin Management Section -->
                <div class="bg-gray-50 rounded-lg p-4 mb-6">
                    <h3 class="text-lg font-medium text-gray-800 mb-3">Grant Admin Privileges</h3>
                    <div class="flex gap-2">
                        <input type="email" id="adminEmailInput" class="flex-1 px-3 py-2 border border-gray-300 rounded-lg" placeholder="Enter user email">
                        <button onclick="grantAdminPrivileges()" class="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600">
                            <i class="fas fa-user-plus mr-1"></i>Grant Admin
                        </button>
                    </div>
                </div>
                
                <!-- Current Admins Section -->
                <div class="bg-gray-50 rounded-lg p-4 mb-6">
                    <h3 class="text-lg font-medium text-gray-800 mb-3">Current Admins</h3>
                    <div id="adminList" class="space-y-2">
                        <!-- Admins will be loaded here -->
                    </div>
                </div>
                
                <!-- Reset Top Learners Section -->
                <div class="bg-gray-50 rounded-lg p-4 mb-6">
                    <h3 class="text-lg font-medium text-gray-800 mb-3">Reset Top Learners</h3>
                    <p class="text-gray-600 mb-4">Use this button to clear all top learners data when the term or period is over.</p>
                    <button onclick="confirmClearAllTopLearners()" class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600">
                        <i class="fas fa-trash mr-2"></i>Reset All Top Learners
                    </button>
                </div>
                
                <!-- Manage Classes Section -->
                <div class="bg-gray-50 rounded-lg p-4 mb-6">
                    <h3 class="text-lg font-medium text-gray-800 mb-3">Manage Classes</h3>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 md:gap-4 mb-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1 md:mb-2">Class Name</label>
                            <input type="text" id="newClassName" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm md:text-base" placeholder="Enter class name">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1 md:mb-2">Password</label>
                            <input type="password" id="newClassPassword" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm md:text-base" placeholder="Enter password">
                        </div>
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-1 md:mb-2">Google Sheet URL</label>
                        <input type="url" id="newClassSheet" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm md:text-base" placeholder="https://docs.google.com/spreadsheets/d/...">
                        <p class="text-xs text-gray-500 mt-1">Paste the Google Sheets URL for behavior tracking</p>
                    </div>
                    <button id="addClassBtn" class="bg-purple-500 text-white px-3 md:px-4 py-2 rounded-lg hover:bg-purple-600 text-sm md:text-base">
                        <i class="fas fa-plus mr-2"></i>Add Class
                    </button>
                </div>

                <!-- Existing Classes Section -->
                <div class="bg-gray-50 rounded-lg p-4">
                    <h3 class="text-lg font-medium text-gray-800 mb-3">Existing Classes</h3>
                    <div id="classesList" class="space-y-3">
                        <p class="text-gray-500">Loading classes...</p>
                    </div>
                </div>

                <!-- User Class Allocation Section -->
                <div class="bg-gray-50 rounded-lg p-4">
                    <h3 class="text-lg font-medium text-gray-800 mb-3">User Class Allocation</h3>
                    <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-4">
                        <div class="flex">
                            <div class="flex-shrink-0">
                                <i class="fas fa-info-circle text-yellow-400 text-xl"></i>
                            </div>
                            <div class="ml-3">
                                <h4 class="text-sm font-medium text-yellow-800">Feature Coming Soon</h4>
                                <p class="text-sm text-yellow-700 mt-1">
                                    Currently, all new users automatically have access to all classes. 
                                    Advanced user-specific class allocation will be implemented in a future update.
                                </p>
                            </div>
                        </div>
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Select User Email</label>
                        <select id="userEmailSelect" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                            <option value="">Loading users...</option>
                        </select>
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Available Classes (Auto-Assigned)</label>
                        <div id="classCheckboxes" class="space-y-2">
                            <p class="text-gray-500 italic">All users currently have access to all classes by default</p>
                        </div>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="saveUserClassAllocation()" class="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 opacity-50 cursor-not-allowed" disabled>
                            <i class="fas fa-save mr-2"></i>Save Allocation
                        </button>
                        <button onclick="loadUsers()" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600">
                            <i class="fas fa-sync-alt mr-2"></i>Refresh Users
                        </button>
                        <button onclick="diagnosticLoadUsers()" class="bg-purple-500 text-white px-4 py-2 rounded-lg hover:bg-purple-600">
                            <i class="fas fa-search mr-2"></i>Diagnose Users
                        </button>
                        <button onclick="checkFirestoreStructure()" class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600">
                            <i class="fas fa-database mr-2"></i>Check Firestore
                        </button>
                    </div>
                </div>
            </div>
        `,
        "Logout": `
            <div class="bg-white rounded-xl shadow-sm p-6 text-center">
                <h1 class="text-2xl font-bold text-gray-800 mb-4">Logging Out...</h1>
                <p class="text-gray-600">You will be redirected to the login page.</p>
            </div>
        `
    };

    // Load classes from Firestore with user permissions


    async function loadClasses() {
        try {
            console.log('Loading classes from Firestore...');
            const classesRef = window.firebaseFirestore.collection(window.firebaseDB, 'classes');
            const snapshot = await window.firebaseFirestore.getDocs(classesRef);
            adminClassPasswords = {};
            
            console.log(`Found ${snapshot.size} classes`);
            
            if (snapshot.empty) {
                console.log('No classes found in Firestore');
                adminClassPasswords = {};
            } else {
                // TEMPORARY: All users have access to all classes (feature coming soon)
                console.log('TEMPORARY: All users have access to all classes (feature coming soon)');
                
                console.log('Total classes found:', snapshot.size);
            
            snapshot.forEach(doc => {
                const classData = doc.data();
                const className = String(doc.id || '').trim();
                
                // Debug: Log all available classes
                console.log(`Available class: "${className}"`);
                
                // All users see all classes (temporary implementation)
                adminClassPasswords[className] = {
                    password: classData.password,
                    sheetUrl: classData.sheetUrl
                };
                console.log(`‚úì Loaded class: "${className}" for all users (temporary)`);
            });
            }
            
            updateClassesList();
            updateTabContentWithClasses();
            
            // Admin panel will load users separately when opened
        } catch (error) {
            console.error('Error loading classes:', error);
            // Show error in the classes list
            const classesList = document.getElementById('classesList');
            if (classesList) {
                classesList.innerHTML = `
                    <div class="text-red-500 p-4 bg-red-50 rounded-lg">
                        <strong>Error loading classes:</strong><br>
                        ${error.message}<br><br>
                        <small>Check console for details</small>
                    </div>
                `;
            }
        }
    }

    // Load all users for admin panel
    async function loadUsers() {
        try {
            console.log('Loading users from Firestore...');
            const usersRef = window.firebaseFirestore.collection(window.firebaseDB, 'users');
            const snapshot = await window.firebaseFirestore.getDocs(usersRef);
            const userSelect = document.getElementById('userEmailSelect');
            
            if (!userSelect) {
                console.error('userEmailSelect element not found');
                return;
            }
            
            console.log(`Found ${snapshot.size} total documents in 'users' collection`);
            
            userSelect.innerHTML = '<option value="">Select a user...</option>';
            
            if (snapshot.empty) {
                console.log('No users found in Firestore');
                userSelect.innerHTML = '<option value="">No users found</option>';
                return;
            }
            
            let userCount = 0;
            
            snapshot.forEach(doc => {
                const userData = doc.data();
                const userEmail = doc.id; // Document ID is the email
                
                console.log(`Processing user: ${userEmail}`, userData);
                
                // Use the data from the document, but ensure we have the required fields
                const email = userData.email || userEmail;
                const firstName = userData.firstName || '';
                const lastName = userData.lastName || '';
                
                if (email && firstName && lastName) {
                    const option = document.createElement('option');
                    option.value = email;
                    option.textContent = `${firstName} ${lastName} (${email})`;
                    userSelect.appendChild(option);
                    userCount++;
                    console.log(`‚úì Added user: ${firstName} ${lastName} (${email})`);
                } else {
                    console.warn(`Skipping user ${userEmail}: missing required fields`, {
                        email: email,
                        firstName: firstName,
                        lastName: lastName
                    });
                }
            });
            
            console.log(`Successfully loaded ${userCount} users`);
            
            if (userCount === 0) {
                userSelect.innerHTML = '<option value="">No valid users found</option>';
                console.warn('No users with complete data found');
            }
            
            // Remove existing event listener to prevent duplicates
            userSelect.removeEventListener('change', loadUserClassCheckboxes);
            userSelect.addEventListener('change', loadUserClassCheckboxes);
            
        } catch (error) {
            console.error('Error loading users:', error);
            const userSelect = document.getElementById('userEmailSelect');
            if (userSelect) {
                userSelect.innerHTML = '<option value="">Error loading users</option>';
            }
        }
    }
    
    // Diagnostic function for troubleshooting user data
    async function diagnosticLoadUsers() {
        try {
            console.log('=== DIAGNOSTIC: Checking User Data ===');
            const usersRef = window.firebaseFirestore.collection(window.firebaseDB, 'users');
            const snapshot = await window.firebaseFirestore.getDocs(usersRef);
            const userSelect = document.getElementById('userEmailSelect');
            
            if (!userSelect) {
                console.error('userEmailSelect element not found');
                return;
            }
            
            console.log(`Total documents in 'users' collection: ${snapshot.size}`);
            
            // Create diagnostic report
            let diagnosticReport = `=== USER DATA DIAGNOSTIC ===\n\n`;
            diagnosticReport += `Total documents found: ${snapshot.size}\n\n`;
            
            if (snapshot.empty) {
                diagnosticReport += "‚ùå No users found in 'users' collection!\n";
                diagnosticReport += "Possible causes:\n";
                diagnosticReport += "1. No users have been created yet\n";
                diagnosticReport += "2. Users are in a different collection\n";
                diagnosticReport += "3. Security rules are blocking access\n";
                diagnosticReport += "4. Check Firebase Console: https://console.firebase.google.com/\n";
                console.log(diagnosticReport);
                userSelect.innerHTML = '<option value="">‚ùå No users found</option>';
                alert(diagnosticReport);
                return;
            }
            
            userSelect.innerHTML = '<option value="">Select a user...</option>';
            let validUsers = 0;
            let invalidUsers = 0;
            let userDetails = [];
            
            console.log('=== RAW FIRESTORE DATA ===');
            snapshot.forEach((doc, index) => {
                const userData = doc.data();
                const docId = doc.id;
                
                console.log(`Document ${index + 1}:`, {
                    id: docId,
                    data: userData,
                    hasEmail: !!userData.email,
                    hasFirstName: !!userData.firstName,
                    hasLastName: !!userData.lastName
                });
                
                userDetails.push({
                    id: docId,
                    email: userData.email || docId,
                    firstName: userData.firstName || '',
                    lastName: userData.lastName || '',
                    rawData: userData
                });
                
                const email = userData.email || docId;
                const firstName = userData.firstName || '';
                const lastName = userData.lastName || '';
                
                if (email && firstName && lastName) {
                    const option = document.createElement('option');
                    option.value = email;
                    option.textContent = `${firstName} ${lastName} (${email})`;
                    userSelect.appendChild(option);
                    validUsers++;
                } else {
                    invalidUsers++;
                }
            });
            
            diagnosticReport += `=== DETAILED USER ANALYSIS ===\n`;
            userDetails.forEach((user, index) => {
                diagnosticReport += `\n${index + 1}. Document ID: "${user.id}"\n`;
                diagnosticReport += `   Email: "${user.email}"\n`;
                diagnosticReport += `   First Name: "${user.firstName || "‚ùå MISSING"}"\n`;
                diagnosticReport += `   Last Name: "${user.lastName || "‚ùå MISSING"}"\n`;
                diagnosticReport += `   Status: ${(user.firstName && user.lastName) ? "‚úÖ Valid" : "‚ùå Incomplete"}\n`;
                diagnosticReport += `   Raw data keys: ${Object.keys(user.rawData).join(', ')}\n`;
            });
            
            diagnosticReport += `\n=== SUMMARY ===\n`;
            diagnosticReport += `Valid users: ${validUsers}\n`;
            diagnosticReport += `Invalid users (missing data): ${invalidUsers}\n`;
            diagnosticReport += `Total documents: ${snapshot.size}\n`;
            diagnosticReport += `All document IDs: ${userDetails.map(u => `"${u.id}"`).join(', ')}\n`;
            
            console.log(diagnosticReport);
            alert(diagnosticReport);
            
            if (validUsers === 0) {
                userSelect.innerHTML = '<option value="">‚ùå No valid users found</option>';
                console.warn("All users have incomplete data - check Firestore documents");
                
                // Additional debug: suggest checking Firebase Console
                console.log("üí° TIP: Check your Firebase Console at https://console.firebase.google.com/");
                console.log("üí° Navigate to: Firestore Database > Data > users collection");
            }
            
        } catch (error) {
            console.error('Diagnostic error:', error);
            alert(`Error loading users: ${error.message}`);
            
            // Additional error debugging
            console.log("üîç Error details:", {
                error: error.message,
                stack: error.stack,
                code: error.code
            });
        }
    }
    
    // Comprehensive Firestore structure check
    async function checkFirestoreStructure() {
        try {
            console.log('=== COMPREHENSIVE FIRESTORE CHECK ===');
            
            // Check current authentication state
            const currentUser = window.firebaseAuth.currentUser;
            console.log('Current authenticated user:', currentUser?.email || 'No user logged in');
            
            // Check users collection
            const usersRef = window.firebaseFirestore.collection(window.firebaseDB, 'users');
            const usersSnapshot = await window.firebaseFirestore.getDocs(usersRef);
            
            console.log('=== USERS COLLECTION ANALYSIS ===');
            console.log('Total documents in users collection:', usersSnapshot.size);
            
            if (usersSnapshot.empty) {
                console.log('‚ùå USERS COLLECTION IS EMPTY!');
                alert('‚ùå No users found in Firestore! The users collection is completely empty.');
                return;
            }
            
            const allUsers = [];
            let validUsers = 0;
            let invalidUsers = 0;
            
            usersSnapshot.forEach(doc => {
                const userData = doc.data();
                const docId = doc.id;
                
                const userInfo = {
                    documentId: docId,
                    documentData: userData,
                    hasEmail: !!userData.email,
                    hasFirstName: !!userData.firstName,
                    hasLastName: !!userData.lastName,
                    dataKeys: Object.keys(userData || {}),
                    dataValues: Object.values(userData || {}),
                    isValid: !!(userData.email && userData.firstName && userData.lastName)
                };
                
                allUsers.push(userInfo);
                
                if (userInfo.isValid) {
                    validUsers++;
                } else {
                    invalidUsers++;
                }
                
                console.log(`Document ID: "${docId}"`);
                console.log(`  Email: ${userData.email || 'MISSING'}`);
                console.log(`  First Name: ${userData.firstName || 'MISSING'}`);
                console.log(`  Last Name: ${userData.lastName || 'MISSING'}`);
                console.log(`  Data Keys: [${Object.keys(userData || {}).join(', ')}]`);
                console.log(`  Status: ${userInfo.isValid ? '‚úÖ VALID' : '‚ùå INVALID'}`);
                console.log('---');
            });
            
            // Create detailed report
            const report = {
                totalDocuments: usersSnapshot.size,
                validUsers: validUsers,
                invalidUsers: invalidUsers,
                allUsers: allUsers
            };
            
            console.log('=== FIRESTORE SUMMARY ===');
            console.log('Total documents:', report.totalDocuments);
            console.log('Valid users:', report.validUsers);
            console.log('Invalid users:', report.invalidUsers);
            console.log('Complete data:', JSON.stringify(report, null, 2));
            
            // Display alert with findings
            let alertMessage = `üìä FIRESTORE ANALYSIS RESULTS:

üìà Collection Stats:
‚Ä¢ Total documents: ${report.totalDocuments}
‚Ä¢ Valid users: ${report.validUsers}
‚Ä¢ Invalid users: ${report.invalidUsers}

üîç Document IDs found:
`;
            
            allUsers.forEach(user => {
                alertMessage += `‚Ä¢ "${user.documentId}" (${user.isValid ? '‚úÖ Valid' : '‚ùå Invalid'})\n`;
            });
            
            if (invalidUsers > 0) {
                alertMessage += `
‚ö†Ô∏è INVALID USERS FOUND:
These documents are missing required fields (email, firstName, lastName).
Check the console for detailed information about each invalid user.
`;
            }
            
            alertMessage += `
üí° Next Steps:
1. Check the browser console for complete details
2. Verify user creation process
3. Check if new users are being created with correct field names
4. Ensure document IDs match expected format (email addresses)

üîó Firebase Console Link:
https://console.firebase.google.com/project/your-project-id/firestore/data/~2Fusers

Replace 'your-project-id' with your actual Firebase project ID.`;
            
            alert(alertMessage);
            
            // Also check if we can access the authentication data
            try {
                console.log('=== AUTHENTICATION CHECK ===');
                if (currentUser) {
                    console.log('Current user email:', currentUser.email);
                    console.log('Current user UID:', currentUser.uid);
                    
                    // Check if current user exists in the users collection
                    const currentUserDoc = allUsers.find(u => u.documentId === currentUser.email);
                    if (currentUserDoc) {
                        console.log('‚úÖ Current user found in users collection');
                    } else {
                        console.log('‚ùå Current user NOT found in users collection');
                        console.log('Available document IDs:', allUsers.map(u => u.documentId));
                    }
                } else {
                    console.log('‚ùå No user currently logged in');
                }
            } catch (authError) {
                console.error('Error checking authentication:', authError);
            }
            
            console.log('=== FIRESTORE CHECK COMPLETE ===');
            
        } catch (error) {
            console.error('Error checking Firestore structure:', error);
            alert(`‚ùå Error checking Firestore: ${error.message}\n\nCheck the browser console for details.`);
        }
    }

    // Replace the refresh button to use diagnostic function
    // Update the refresh button in the HTML to use diagnosticLoadUsers instead
    async function loadUserClassCheckboxes() {
        const userEmailSelect = document.getElementById('userEmailSelect');
        const classCheckboxes = document.getElementById('classCheckboxes');
        
        if (!userEmailSelect || !classCheckboxes) {
            console.error('Required elements not found');
            return;
        }
        
        const userEmail = userEmailSelect.value;
        
        if (!userEmail) {
            classCheckboxes.innerHTML = '<p class="text-gray-500">Select a user first</p>';
            return;
        }
        
        try {
            // Get user's current classes
            const userClassesRef = window.firebaseFirestore.doc(window.firebaseDB, 'userClasses', userEmail);
            const userClassesDoc = await window.firebaseFirestore.getDoc(userClassesRef);
            const userClasses = userClassesDoc.exists() ? userClassesDoc.data().classes || [] : [];
            
            // Create checkboxes for all classes
            classCheckboxes.innerHTML = '';
            console.log('Available classes for checkboxes:', Object.keys(adminClassPasswords));
            console.log('User has classes:', userClasses);
            Object.keys(adminClassPasswords).forEach(className => {
                const isChecked = userClasses.some(userClass => 
                    userClass.trim().toLowerCase() === className.trim().toLowerCase()
                );
                const div = document.createElement('div');
                div.className = 'flex items-center';
                div.innerHTML = `
                    <input type="checkbox" id="class-${className}" value="${className}" ${isChecked ? 'checked' : ''} class="mr-2">
                    <label for="class-${className}" class="text-sm text-gray-700">${className}</label>
                `;
                classCheckboxes.appendChild(div);
            });
        } catch (error) {
            console.error('Error loading user classes:', error);
        }
    }

    // Load user class allocations for admin display
    async function loadUserClassAllocations() {
        try {
            const userClassesRef = window.firebaseFirestore.collection(window.firebaseDB, 'userClasses');
            const snapshot = await window.firebaseFirestore.getDocs(userClassesRef);
            
            console.log(`Found ${snapshot.size} user class allocations`);
            
            // This function is mainly for logging/debugging purposes
            // The actual display happens in loadUserClassCheckboxes when a user is selected
        } catch (error) {
            console.error('Error loading user class allocations:', error);
        }
    }

    // Save user class allocation
    async function saveUserClassAllocation() {
        const userEmailSelect = document.getElementById('userEmailSelect');
        if (!userEmailSelect) {
            alert('User selection element not found');
            return;
        }
        
        const userEmail = userEmailSelect.value;
        if (!userEmail) {
            alert('Please select a user');
            return;
        }
        
        const selectedClasses = [];
            document.querySelectorAll('#classCheckboxes input[type="checkbox"]:checked').forEach(checkbox => {
                selectedClasses.push(checkbox.value.trim());
            });
            console.log('Saving classes for user:', selectedClasses);
        
        try {
            const userClassesRef = window.firebaseFirestore.doc(window.firebaseDB, 'userClasses', userEmail);
            console.log('About to save classes:', selectedClasses);
            await window.firebaseFirestore.setDoc(userClassesRef, {
                classes: selectedClasses,
                updatedAt: new Date().toISOString()
            });
            console.log('Successfully saved classes for user:', userEmail);
            
            alert('Class allocation saved successfully!');
            
            // Reload classes for the user if they're viewing
            if (userEmail === window.firebaseAuth.currentUser?.email) {
                loadClasses();
            }
        } catch (error) {
            console.error('Error saving user classes:', error);
            alert('Error saving class allocation. Please try again.');
        }
    }

    // Update classes list in admin panel
    function updateClassesList() {
        const classesList = document.getElementById('classesList');
        if (!classesList) return;

        classesList.innerHTML = '';
        
        const classes = Object.keys(adminClassPasswords);
        if (classes.length === 0) {
            classesList.innerHTML = '<p class="text-gray-500">No classes created yet. Add a class above to get started.</p>';
            return;
        }
        
        classes.forEach(className => {
            const classData = adminClassPasswords[className];
            const classItem = document.createElement('div');
            classItem.className = 'flex items-center justify-between p-4 bg-gray-50 rounded-lg';
            classItem.innerHTML = `
                <div class="flex-1">
                    <div class="flex items-center mb-2">
                        <span class="font-medium text-lg">${className}</span>
                        <span class="text-sm text-gray-500 ml-2">(Password protected)</span>
                    </div>
                    <div class="text-sm text-gray-600 mb-2">
                        <strong>Password:</strong>
                        <span class="password-display ml-2 font-mono text-xs bg-gray-200 px-2 py-1 rounded" data-password="${classData.password}">
                            ${'*'.repeat(classData.password.length)}
                        </span>
                        <button class="show-password-btn ml-2 text-blue-500 hover:text-blue-700" onclick="togglePasswordVisibility(this)">
                            <i class="fas fa-eye"></i>
                        </button>
                    </div>
                    <div class="text-sm text-gray-600">
                        <strong>Sheet URL:</strong>
                        ${classData.sheetUrl ? `
                        <a href="${classData.sheetUrl}" target="_blank" class="text-blue-600 hover:underline ml-1">
                            ${classData.sheetUrl.length > 50 ? classData.sheetUrl.substring(0, 50) + '...' : classData.sheetUrl}
                        </a>
                        ` : '<span class="text-gray-400 ml-1">No sheet URL provided</span>'}
                    </div>
                </div>
                <div class="ml-4">
                    <button class="text-red-500 hover:text-red-700 p-2" onclick="removeClass('${className}')">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            `;
            classesList.appendChild(classItem);
        });
    }

    // Add new class
    async function addNewClass() {
        const className = document.getElementById('newClassName').value.trim();
        const password = document.getElementById('newClassPassword').value.trim();
        const sheetUrl = document.getElementById('newClassSheet').value.trim();

        if (!className || !password) {
            alert('Please enter both class name and password');
            return;
        }

        if (!sheetUrl) {
            alert('Please enter a Google Sheet URL');
            return;
        }

        // Validate Google Sheets URL
        if (!sheetUrl.includes('docs.google.com/spreadsheets')) {
            alert('Please enter a valid Google Sheets URL');
            return;
        }

        try {
            // Show loading state
            const addBtn = document.getElementById('addClassBtn');
            const originalText = addBtn.innerHTML;
            addBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Adding...';
            addBtn.disabled = true;

            const classRef = window.firebaseFirestore.doc(window.firebaseDB, 'classes', className);
            await window.firebaseFirestore.setDoc(classRef, {
                password: password,
                sheetUrl: sheetUrl,
                createdAt: new Date().toISOString()
            });

            // Clear fields
            document.getElementById('newClassName').value = '';
            document.getElementById('newClassPassword').value = '';
            document.getElementById('newClassSheet').value = '';
            
            // Success prompt
            alert(`‚úÖ Class "${className}" has been successfully created!`);
            
            // Restore button state
            addBtn.innerHTML = originalText;
            addBtn.disabled = false;
            
        } catch (error) {
            console.error('Error adding class:', error);
            alert('Error adding class. Please try again.');
            
            // Restore button state on error
            const addBtn = document.getElementById('addClassBtn');
            addBtn.innerHTML = '<i class="fas fa-plus mr-2"></i>Add Class';
            addBtn.disabled = false;
        }
    }

    // Remove class
    async function removeClass(className) {
        if (!confirm(`Are you sure you want to remove ${className}?`)) return;

        try {
            await window.firebaseFirestore.deleteDoc(window.firebaseFirestore.doc(window.firebaseDB, 'classes', className));
            loadClasses(); // Reload classes
        } catch (error) {
            console.error('Error removing class:', error);
            alert('Error removing class. Please try again.');
        }
    }

    // Function to save best learner data to Firestore
    async function saveBestLearner(className) {
        try {
            const nameInput = document.getElementById(`${className}-best-learner-name`);
            const pointsInput = document.getElementById(`${className}-best-learner-points`);
            
            if (!nameInput || !pointsInput) {
                console.error('Could not find best learner input fields');
                return;
            }
            
            const name = nameInput.value.trim();
            const points = parseInt(pointsInput.value, 10);
            
            if (!name) {
                alert('Please enter a student name');
                return;
            }
            
            if (isNaN(points) || points <= 0) {
                alert('Please enter a valid number of points');
                return;
            }
            
            // Generate a unique ID for this top learner entry
            const timestamp = new Date().getTime();
            const learnerId = `${className}_${timestamp}`;
            
            // Create a document reference for this top learner
            const bestLearnerRef = window.firebaseFirestore.doc(window.firebaseDB, 'bestLearners', learnerId);
            
            // Save the data to Firestore
            await window.firebaseFirestore.setDoc(bestLearnerRef, {
                name: name,
                points: points,
                className: className,
                updatedAt: new Date().toISOString()
            });
            
            // Clear the input fields after saving
            nameInput.value = '';
            pointsInput.value = '';
            
            alert('Top learner saved successfully!');
            // No need to call loadTopLearners() here as we have real-time updates
            
        } catch (error) {
            console.error('Error saving top learner:', error);
            alert('Failed to save top learner. Please try again.');
        }
    }
    
    // Function to load top learners data for a specific class from Firestore
    async function loadBestLearner(className) {
        try {
            // We're no longer loading a single best learner since we now support multiple
            // This function now returns empty values as we'll use the form to add new top learners
            return { bestLearnerName: '', bestLearnerPoints: '' };
        } catch (error) {
            console.error('Error loading top learners:', error);
            return { bestLearnerName: '', bestLearnerPoints: '' };
        }
    }
    
    // Update tab content with dynamic classes
    function updateTabContentWithClasses() {
        // Remove old class entries from tabContent
        Object.keys(tabContent).forEach(key => {
            if (key !== 'Dashboard' && key !== 'Admin' && key !== 'Logout') {
                delete tabContent[key];
            }
        });

        // Add new classes from Firestore
        Object.keys(adminClassPasswords).forEach(className => {
            tabContent[className] = createClassContent(className);
        });

        // Update sidebar navigation
        updateSidebarNavigation();
    }

    // Create content for a specific class
    function createClassContent(className) {
        const classData = adminClassPasswords[className];
        const sheetUrl = classData?.sheetUrl || '';
        
        // Convert Google Sheets URL to embed format
        let embedUrl = '';
        if (sheetUrl) {
            const match = sheetUrl.match(/\/spreadsheets\/d\/([a-zA-Z0-9-_]+)/);
            if (match) {
                embedUrl = `https://docs.google.com/spreadsheets/d/${match[1]}/edit?usp=sharing&rm=minimal`;
            }
        }
        
        // Load best learner data if available
        let bestLearnerName = '';
        let bestLearnerPoints = '';
        
        // Load best learner data for this class
        loadBestLearner(className).then(data => {
            setTimeout(() => {
                const nameInput = document.getElementById(`${className}-best-learner-name`);
                const pointsInput = document.getElementById(`${className}-best-learner-points`);
                
                if (nameInput && data.bestLearnerName) {
                    nameInput.value = data.bestLearnerName;
                }
                
                if (pointsInput && data.bestLearnerPoints) {
                    pointsInput.value = data.bestLearnerPoints;
                }
            }, 500); // Small delay to ensure DOM is ready
        });

        return `
            <div class="bg-white rounded-xl shadow-sm p-4 md:p-6">
                <div class="flex items-center justify-between mb-4 md:mb-6">
                    <h1 class="text-xl md:text-2xl font-bold text-gray-800">${className}</h1>
                </div>

                <div class="class-content-blur" id="${className}-content">
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 md:gap-6">
                        <div class="lg:col-span-2">
                            <div class="bg-gray-50 rounded-xl p-3 md:p-4 mb-4 md:mb-6">
                                <h3 class="text-base md:text-lg font-semibold text-gray-700 mb-3 md:mb-4">Behavior Tracker</h3>
                                ${embedUrl ? `
                                <div class="border border-gray-300 rounded-lg overflow-hidden" style="height: 400px; max-height: 80vh;">
                                    <iframe 
                                        src="${embedUrl}" 
                                        width="100%" 
                                        height="100%" 
                                        frameborder="0"
                                        style="border:0;"
                                        allowfullscreen>
                                    </iframe>
                                </div>
                                ` : '<p class="text-sm md:text-base text-gray-500">No Google Sheet configured for this class.</p>'}
                            </div>
                            
                            <div class="bg-gray-50 rounded-xl p-3 md:p-4">
                                <h3 class="text-base md:text-lg font-semibold text-gray-700 mb-3 md:mb-4">Students</h3>
                                <div id="${className}-students" class="space-y-2 md:space-y-3 max-h-60 md:max-h-80 overflow-y-auto pr-2">
                                    <p class="text-sm md:text-base text-gray-500">Student list will appear here.</p>
                                </div>
                            </div>
                        </div>
                        
                        <div>
                            <div class="bg-gray-50 rounded-xl p-3 md:p-4 mb-3 md:mb-4">
                                <h3 class="text-base md:text-lg font-semibold text-gray-700 mb-3 md:mb-4">Class Stats</h3>
                                <div class="space-y-2">
                                    <div class="flex justify-between">
                                        <span class="text-xs md:text-sm text-gray-600">Total Students:</span>
                                        <span class="font-semibold text-sm md:text-base" id="${className}-count">0</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-xs md:text-sm text-gray-600">Average Points:</span>
                                        <span class="font-semibold text-sm md:text-base" id="${className}-avg">0</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="bg-gray-50 rounded-xl p-3 md:p-4 mb-3 md:mb-4">
                                <h3 class="text-base md:text-lg font-semibold text-gray-700 mb-3 md:mb-4">Add Top Learner</h3>
                                <div class="space-y-2 md:space-y-3">
                                    <div>
                                        <label class="block text-xs md:text-sm font-medium text-gray-700 mb-1">Student Name</label>
                                        <input type="text" id="${className}-best-learner-name" class="w-full px-2 md:px-3 py-1.5 md:py-2 border border-gray-300 rounded-lg text-sm md:text-base" 
                                            placeholder="Enter student name" value="${bestLearnerName}">
                                    </div>
                                    <div>
                                        <label class="block text-xs md:text-sm font-medium text-gray-700 mb-1">Points</label>
                                        <input type="number" id="${className}-best-learner-points" class="w-full px-2 md:px-3 py-1.5 md:py-2 border border-gray-300 rounded-lg text-sm md:text-base" 
                                            placeholder="Enter points" value="${bestLearnerPoints}">
                                    </div>
                                    <button onclick="saveBestLearner('${className}')" class="w-full bg-green-500 text-white py-1.5 md:py-2 rounded-lg hover:bg-green-600 mt-2 text-sm md:text-base">
                                        <i class="fas fa-plus mr-2"></i>Add Top Learner
                                    </button>
                                    <p class="text-xs text-gray-500 mt-2">You can add multiple top learners for this class. They will be ranked by points on the dashboard.</p>
                                </div>
                            </div>
                            
                            <div class="bg-gray-50 rounded-xl p-3 md:p-4">
                                <h3 class="text-base md:text-lg font-semibold text-gray-700 mb-3 md:mb-4">Performance Chart</h3>
                                <canvas id="${className}-chart" width="300" height="200"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }

    // Update sidebar navigation with dynamic classes
    function updateSidebarNavigation() {
        const classesDropdownMenu = document.getElementById('classesDropdownMenu');
        if (!classesDropdownMenu) return;

        classesDropdownMenu.innerHTML = '';
        
        Object.keys(adminClassPasswords).forEach(className => {
            const classButton = document.createElement('button');
            classButton.className = 'class-btn flex items-center gap-2 w-full px-4 py-2 text-gray-700 hover:bg-gray-100 rounded-lg text-left';
            classButton.setAttribute('data-content', className);
            classButton.innerHTML = `<i class="fas fa-book"></i> ${className}`;
            classesDropdownMenu.appendChild(classButton);
        });

        setupClassButtons();
    }

    // Setup event listeners for class buttons
    function setupClassButtons() {
        document.querySelectorAll('[data-content]').forEach(button => {
            button.addEventListener('click', (e) => {
                const content = e.currentTarget.getAttribute('data-content');
                
                if (content === 'Logout') {
                    window.firebaseAuth.signOut(window.firebaseAuth).then(() => {
                        window.location.href = 'index.html';
                    });
                } else if (content === 'Classes') {
                    document.getElementById('classesDropdownMenu').classList.toggle('hidden');
                } else {
                    loadContent(content);
                }
            });
        });
    }

    // Show password modal
    function showPasswordModal(className) {
        currentClass = className;
        document.getElementById('passwordModal').classList.remove('hidden');
        document.getElementById('passwordModal').classList.add('flex');
        document.getElementById('classPasswordInput').value = '';
        document.getElementById('passwordError').classList.add('hidden');
        document.getElementById('classPasswordInput').focus();
    }

    // Hide password modal
    function hidePasswordModal() {
        document.getElementById('passwordModal').classList.add('hidden');
        document.getElementById('passwordModal').classList.remove('flex');
    }

    // Check password
    function checkPassword() {
        const enteredPassword = document.getElementById('classPasswordInput').value;
        const correctPassword = adminClassPasswords[currentClass]?.password;
        
        if (enteredPassword === correctPassword) {
            hidePasswordModal();
            const contentDiv = document.getElementById(`${currentClass}-content`);
            if (contentDiv) {
                contentDiv.classList.remove('class-content-blur');
                contentDiv.classList.add('class-content-unblur');
            }
        } else {
            document.getElementById('passwordError').classList.remove('hidden');
        }
    }

    // Load content
    function loadContent(content) {
        const contentDiv = document.getElementById('content');
        
        if (tabContent[content]) {
            contentDiv.innerHTML = tabContent[content];
            
            if (content !== 'Dashboard' && content !== 'Admin' && content !== 'Logout') {
                showPasswordModal(content);
            } else if (content === 'Dashboard') {
                updateDashboardStats();
            } else if (content === 'Admin') {
                // Ensure classes are loaded when admin panel is opened
                setTimeout(() => {
                    console.log('Admin panel loaded, setting up...');
                    loadClasses();
                    // Attach event listener for Add Class button
                    const addClassBtn = document.getElementById('addClassBtn');
                    if (addClassBtn) {
                        // Remove any existing listener to prevent duplicates
                        addClassBtn.removeEventListener('click', addNewClass);
                        addClassBtn.addEventListener('click', addNewClass);
                        console.log('Add Class button event listener attached');
                    } else {
                        console.error('Add Class button not found');
                    }
                    
                    // Load admin list when admin panel is opened
                    loadAdminList();
                    console.log('Admin list loaded');
                    
                    // Load user data for admin panel
                    if (isAdmin) {
                        loadUsers();
                        loadUserClassAllocations();
                    }
                }, 100);
            }
        }
    }

    // Update dashboard stats and welcome message
    async function updateDashboardStats() {
        document.getElementById('totalClasses').textContent = Object.keys(adminClassPasswords).length;
        document.getElementById('totalStudents').textContent = '0';
        document.getElementById('totalPoints').textContent = '0';
        
        // Update user information
        const user = window.firebaseAuth.currentUser;
        if (user) {
            // Update welcome message with user's first name
            try {
                const userDoc = await window.firebaseFirestore.getDoc(
                    window.firebaseFirestore.doc(window.firebaseDB, 'users', user.uid)
                );
                if (userDoc.exists()) {
                    const userData = userDoc.data();
                    const welcomeElement = document.querySelector('#content h1');
                    if (welcomeElement) {
                        welcomeElement.textContent = `Welcome back, ${userData.firstName}!`;
                    }
                }
            } catch (error) {
                console.error('Error fetching user data:', error);
            }
        }
        
        // Load top learners for the dashboard
        loadTopLearners();
    }
    
    // Function to load and display top learners with real-time updates
    function loadTopLearners() {
        try {
            const bestLearnersRef = window.firebaseFirestore.collection(window.firebaseDB, 'bestLearners');
            
            // Use onSnapshot for real-time updates
            window.firebaseFirestore.onSnapshot(bestLearnersRef, (snapshot) => {
                const topLearnersContainer = document.getElementById('topLearnersContainer');
                
                if (!topLearnersContainer) {
                    console.error('Top learners container not found');
                    return;
                }
                
                // Clear the container
                topLearnersContainer.innerHTML = '';
                
                if (snapshot.empty) {
                    topLearnersContainer.innerHTML = `
                        <p class="text-gray-500 italic col-span-full text-center py-4">No top learners data available yet</p>
                    `;
                    return;
                }
                
                // Convert snapshot to array and sort by points (highest first)
                const learners = [];
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    learners.push({
                        id: doc.id,
                        className: data.className || doc.id.split('_')[0], // Fallback for older data format
                        name: data.name,
                        points: data.points,
                        updatedAt: data.updatedAt
                    });
                });
                
                // Sort by points (highest first)
                learners.sort((a, b) => b.points - a.points);
                
                // Group learners by class
                const learnersByClass = {};
                learners.forEach(learner => {
                    if (!learnersByClass[learner.className]) {
                        learnersByClass[learner.className] = [];
                    }
                    learnersByClass[learner.className].push(learner);
                });
                
                // Create a section for each class
                Object.keys(learnersByClass).forEach(className => {
                    // Create class header
                    const classHeader = document.createElement('div');
                    classHeader.className = 'col-span-full mt-4 mb-2';
                    classHeader.innerHTML = `
                        <h3 class="text-lg font-semibold text-gray-700">${className} Top Learners</h3>
                    `;
                    topLearnersContainer.appendChild(classHeader);
                    
                    // Sort learners within this class by points
                    const classLearners = learnersByClass[className];
                    
                    // Create cards for each top learner in this class
                    classLearners.forEach((learner, index) => {
                        const position = index + 1;
                        const learnerCard = document.createElement('div');
                        learnerCard.className = 'bg-gray-50 rounded-xl p-4';
                        
                        // Determine medal color based on position
                        let medalColor = 'text-gray-500 bg-gray-100';
                        let medalIcon = 'fa-medal';
                        
                        if (position === 1) {
                            medalColor = 'text-yellow-500 bg-yellow-100'; // Gold
                        } else if (position === 2) {
                            medalColor = 'text-gray-400 bg-gray-100'; // Silver
                        } else if (position === 3) {
                            medalColor = 'text-amber-600 bg-amber-100'; // Bronze
                        }
                        
                        learnerCard.innerHTML = `
                            <div class="flex items-start">
                                <div class="p-2 rounded-full ${medalColor} mr-3">
                                    <i class="fas ${medalIcon}"></i>
                                </div>
                                <div>
                                    <div class="flex items-center">
                                        <h3 class="font-semibold text-gray-800">${learner.name}</h3>
                                        <span class="ml-2 px-2 py-1 text-xs font-semibold rounded-full bg-blue-100 text-blue-800">Rank #${position}</span>
                                    </div>
                                    <div class="flex items-center mt-1">
                                        <span class="text-lg font-bold text-yellow-500">${learner.points}</span>
                                        <span class="text-xs text-gray-500 ml-1">points</span>
                                    </div>
                                </div>
                            </div>
                        `;
                        
                        topLearnersContainer.appendChild(learnerCard);
                    });
                });
            });
            
        } catch (error) {
            console.error('Error setting up top learners listener:', error);
        }
    }

    // Toggle password visibility
    function togglePasswordVisibility(button) {
        const passwordSpan = button.previousElementSibling;
        const password = passwordSpan.getAttribute('data-password');
        const icon = button.querySelector('i');
        
        if (passwordSpan.textContent.includes('*')) {
            passwordSpan.textContent = password;
            icon.className = 'fas fa-eye-slash';
        } else {
            passwordSpan.textContent = '*'.repeat(password.length);
            icon.className = 'fas fa-eye';
        }
    }
    
    // Confirm before clearing all top learners
    function confirmClearAllTopLearners() {
        if (confirm('Are you sure you want to reset ALL top learners data? This action cannot be undone.')) {
            if (confirm('FINAL WARNING: This will permanently delete all top learners records. Continue?')) {
                clearAllTopLearners();
            }
        }
    }
    
    // Clear all top learners data
    async function clearAllTopLearners() {
        try {
            // Show loading state
            const resetBtn = document.querySelector('button[onclick="confirmClearAllTopLearners()"]');
            const originalText = resetBtn.innerHTML;
            resetBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Resetting...';
            resetBtn.disabled = true;
            
            // Get all top learners documents
            const bestLearnersRef = window.firebaseFirestore.collection(window.firebaseDB, 'bestLearners');
            const snapshot = await window.firebaseFirestore.getDocs(bestLearnersRef);
            
            // Delete each document
            const deletePromises = [];
            snapshot.forEach((doc) => {
                deletePromises.push(
                    window.firebaseFirestore.deleteDoc(
                        window.firebaseFirestore.doc(window.firebaseDB, 'bestLearners', doc.id)
                    )
                );
            });
            
            // Wait for all deletions to complete
            await Promise.all(deletePromises);
            
            // Restore button state
            resetBtn.innerHTML = originalText;
            resetBtn.disabled = false;
            
            alert('All top learners data has been successfully reset!');
            
        } catch (error) {
            console.error('Error clearing top learners:', error);
            alert('Error clearing top learners data. Please try again.');
            
            // Restore button state on error
            const resetBtn = document.querySelector('button[onclick="confirmClearAllTopLearners()"]');
            resetBtn.innerHTML = '<i class="fas fa-trash mr-2"></i>Reset All Top Learners';
            resetBtn.disabled = false;
        }
    }

    // Update welcome message with user's first name
    async function updateWelcomeMessage() {
        const user = window.firebaseAuth.currentUser;
        if (user) {
            try {
                const userDoc = await window.firebaseFirestore.getDoc(
                    window.firebaseFirestore.doc(window.firebaseDB, 'users', user.uid)
                );
                if (userDoc.exists()) {
                    const userData = userDoc.data();
                    const welcomeElement = document.querySelector('#content h1');
                    if (welcomeElement) {
                        welcomeElement.textContent = `Welcome back, ${userData.firstName}!`;
                    }
                }
            } catch (error) {
                console.error('Error fetching user data:', error);
            }
        }
    }

    // Admin Management Functions
    async function grantAdminPrivileges() {
        const emailInput = document.getElementById('adminEmailInput');
        const email = emailInput.value.trim();
        
        if (!email) {
            alert('Please enter an email address');
            return;
        }
        
        if (!confirm(`Are you sure you want to grant admin privileges to ${email}?`)) {
            return;
        }
        
        try {
            // Find user by email
            const usersRef = window.firebaseFirestore.collection(window.firebaseDB, 'users');
            const usersSnapshot = await window.firebaseFirestore.getDocs(usersRef);
            let targetUser = null;
            
            usersSnapshot.forEach((doc) => {
                const userData = doc.data();
                if (userData.email === email) {
                    targetUser = { uid: doc.id, ...userData };
                }
            });
            
            if (!targetUser) {
                alert('User not found with this email address');
                return;
            }
            
            // Grant admin privileges
            await window.firebaseFirestore.setDoc(
                window.firebaseFirestore.doc(window.firebaseDB, 'admins', targetUser.uid),
                {
                    email: targetUser.email,
                    firstName: targetUser.firstName,
                    lastName: targetUser.lastName,
                    grantedBy: window.firebaseAuth.currentUser.uid,
                    grantedAt: new Date().toISOString()
                }
            );
            
            alert(`Admin privileges granted to ${targetUser.firstName} ${targetUser.lastName}`);
            emailInput.value = '';
            loadAdminList();
            
        } catch (error) {
            console.error('Error granting admin privileges:', error);
            alert('Error granting admin privileges. Please try again.');
        }
    }
    
    async function revokeAdminPrivileges(userId) {
        if (!confirm('Are you sure you want to revoke admin privileges?')) {
            return;
        }
        
        try {
            await window.firebaseFirestore.deleteDoc(
                window.firebaseFirestore.doc(window.firebaseDB, 'admins', userId)
            );
            
            alert('Admin privileges revoked successfully');
            loadAdminList();
            
        } catch (error) {
            console.error('Error revoking admin privileges:', error);
            alert('Error revoking admin privileges. Please try again.');
        }
    }
    

    
    async function initializeFirstAdmin() {
        try {
            const adminsRef = window.firebaseFirestore.collection(window.firebaseDB, 'admins');
            const adminsSnapshot = await window.firebaseFirestore.getDocs(adminsRef);
            
            if (adminsSnapshot.empty) {
                // Find the initial admin user
                const usersRef = window.firebaseFirestore.collection(window.firebaseDB, 'users');
                const usersSnapshot = await window.firebaseFirestore.getDocs(usersRef);
                let initialAdmin = null;
                
                usersSnapshot.forEach((doc) => {
                    const userData = doc.data();
                    if (userData.email === 'fobiblankson95@gmail.com') {
                        initialAdmin = { uid: doc.id, ...userData };
                    }
                });
                
                if (initialAdmin) {
                    await window.firebaseFirestore.setDoc(
                        window.firebaseFirestore.doc(window.firebaseDB, 'admins', initialAdmin.uid),
                        {
                            email: initialAdmin.email,
                            firstName: initialAdmin.firstName,
                            lastName: initialAdmin.lastName,
                            grantedBy: 'system',
                            grantedAt: new Date().toISOString(),
                            isInitialAdmin: true
                        }
                    );
                    console.log('Initial admin setup complete');
                }
            }
        } catch (error) {
            console.error('Error initializing first admin:', error);
        }
    }
    
    async function loadAdminList() {
        if (!window.isAdmin) return;
        
        try {
            const adminsRef = window.firebaseFirestore.collection(window.firebaseDB, 'admins');
            const adminsSnapshot = await window.firebaseFirestore.getDocs(adminsRef);
            
            const adminList = document.getElementById('adminList');
            if (!adminList) {
                console.error('adminList element not found');
                return;
            }
            adminList.innerHTML = '';
            
            if (adminsSnapshot.empty) {
                adminList.innerHTML = '<p class="text-gray-500">No admins found</p>';
                return;
            }
            
            adminsSnapshot.forEach((doc) => {
                const admin = doc.data();
                const adminDiv = document.createElement('div');
                adminDiv.className = 'flex justify-between items-center p-3 bg-white rounded-lg border';
                adminDiv.innerHTML = `
                    <div>
                        <p class="font-medium">${admin.firstName} ${admin.lastName}</p>
                        <p class="text-sm text-gray-600">${admin.email}</p>
                        <p class="text-xs text-gray-500">Granted: ${new Date(admin.grantedAt).toLocaleDateString()}</p>
                    </div>
                    ${doc.id !== window.firebaseAuth.currentUser.uid && !admin.isInitialAdmin ? 
                        `<button onclick="revokeAdminPrivileges('${doc.id}')" class="bg-red-500 text-white px-3 py-1 rounded text-sm hover:bg-red-600">
                            <i class="fas fa-user-times"></i> Revoke
                        </button>` :
                        '<span class="text-sm text-green-600">' + (admin.isInitialAdmin ? 'System Admin' : 'Current User') + '</span>'
                    }
                `;
                adminList.appendChild(adminDiv);
            });
            
        } catch (error) {
            console.error('Error loading admin list:', error);
        }
    }
    

    
    // Setup admin tabs functionality
    function setupAdminTabs() {
        console.log('Setting up admin tabs...');
        
        // Ensure admin elements exist
        const adminBtn = document.getElementById('adminBtn');
        if (adminBtn) {
            adminBtn.addEventListener('click', () => {
                loadContent('Admin');
            });
        }
        
        // Add event listeners for admin panel elements
        const addClassBtn = document.getElementById('addClassBtn');
        if (addClassBtn) {
            addClassBtn.addEventListener('click', addNewClass);
        }
        
        const saveAllocationBtn = document.getElementById('saveAllocationBtn');
        if (saveAllocationBtn) {
            saveAllocationBtn.addEventListener('click', saveUserClassAllocation);
        }
        
        const clearLearnersBtn = document.getElementById('clearLearnersBtn');
        if (clearLearnersBtn) {
            clearLearnersBtn.addEventListener('click', clearAllTopLearners);
        }
    }
    
    // Event listeners
    document.addEventListener('DOMContentLoaded', () => {
        // Check if user is authenticated
        const unsubscribe = window.firebaseAuth.onAuthStateChanged((user) => {
            if (!user) {
                // Redirect to login page if not authenticated
                window.location.href = 'index.html';
                return;
            }
            
            // Ensure Firebase is initialized before proceeding
            const checkFirebase = setInterval(() => {
                if (window.firebaseDB && window.firebaseFirestore) {
                    clearInterval(checkFirebase);
                    loadClasses();
                    
                    // Load dashboard by default
                loadContent('Dashboard');
                
                // Set up event listeners after ensuring elements exist
                setTimeout(() => {
                    setupClassButtons();
                    updateWelcomeMessage();
                    initializeFirstAdmin(); // Initialize first admin if needed
                    setupAdminTabs(); // Setup admin tabs functionality
                }, 100);
                }
            }, 100);
            
            // Clean up the auth listener
            setTimeout(() => unsubscribe(), 1000);
        });
        
        const submitPassword = document.getElementById('submitPassword');
        if (submitPassword) submitPassword.addEventListener('click', checkPassword);
        
        const cancelPassword = document.getElementById('cancelPassword');
        if (cancelPassword) cancelPassword.addEventListener('click', hidePasswordModal);
        
        const classPasswordInput = document.getElementById('classPasswordInput');
        if (classPasswordInput) {
            classPasswordInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') checkPassword();
            });
        }
        
        const classesDropdownBtn = document.getElementById('classesDropdownBtn');
        if (classesDropdownBtn) {
            classesDropdownBtn.addEventListener('click', () => {
                document.getElementById('classesDropdownMenu').classList.toggle('hidden');
            });
        }

        // Listen for real-time updates
        if (window.firebaseFirestore) {
            const classesRef = window.firebaseFirestore.collection(window.firebaseDB, 'classes');
            window.firebaseFirestore.onSnapshot(classesRef, (snapshot) => {
                adminClassPasswords = {};
                snapshot.forEach(doc => {
                    const classData = doc.data();
                    adminClassPasswords[doc.id] = {
                        password: classData.password,
                        sheetUrl: classData.sheetUrl
                    };
                });
                updateClassesList();
                updateTabContentWithClasses();
                
                if (document.querySelector('[data-content="Dashboard"]')) {
                    updateDashboardStats();
                }
            });
        }
    });
</script>
</body>
</html>