<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Performance Tracker</title>
    <link rel="icon" type="image/png" href="images/logo1.png">
    
    <!-- PWA Configuration -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#4CAF50">
    <meta name="description" content="Track, manage, and improve student behavior in real-time with our comprehensive PWA">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Behaviour Tracker">
    <link rel="apple-touch-icon" href="images/logo1.png">
    
    <!-- Cache version for PWA updates -->
    <meta name="version" content="3.0.0">
    
    <!-- Prevent caching to ensure auth checks work on back button -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="dashboard.css?v=3.0.1">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <script>
    window.addEventListener('error', function(e) {
        console.error('JavaScript error detected:', e.message, '\nLine:', e.lineno, '\nColumn:', e.colno, '\nFile:', e.filename);
        alert('JavaScript error: ' + e.message + ' at line ' + e.lineno);
    });
    
    // Ensure jsPDF is properly initialized
    window.addEventListener('load', function() {
        if (typeof window.jspdf === 'undefined') {
            console.warn('jsPDF not found in window object. Creating empty object.');
            window.jspdf = { jsPDF: function() { return {}; } };
        }
    });
    </script>
    
    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, getDoc, deleteDoc, onSnapshot, getDocs, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBNGdPWISw803XD8xVo0RyCGoGpNX8o_jM",
            authDomain: "dpointslogin.firebaseapp.com",
            projectId: "dpointslogin",
            storageBucket: "dpointslogin.firebasestorage.app",
            messagingSenderId: "486203348613",
            appId: "1:486203348613:web:a22083bc80b9326bc73bec"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Make Firebase services globally available
        window.firebaseApp = app;
        window.firebaseAuth = auth;
        window.firebaseDB = db;
        window.firebaseFirestore = {
            collection,
            doc,
            setDoc,
            getDoc,
            deleteDoc,
            onSnapshot,
            getDocs,
            updateDoc
        };
        
        // Create a collection reference for best learners
        window.bestLearnersCollection = collection(db, 'bestLearners');

        // Initialize admin status
        window.isAdmin = false;
        let adminListener = null;
        
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                try {
                    // Check admin status
                    const adminDoc = await getDoc(doc(db, 'admins', user.uid));
                    window.isAdmin = adminDoc.exists();
                    
                    // Show/hide admin button based on admin status
                    const adminBtn = document.getElementById('adminBtn');
                    if (adminBtn) {
                        adminBtn.style.display = window.isAdmin ? 'flex' : 'none';
                    }
                    
                    // Load admin list if current user is admin
                    if (window.isAdmin) {
                        loadAdminList();
                        
                        // Set up real-time listener for admin changes
                        if (adminListener) {
                            adminListener();
                        }
                        
                        adminListener = onSnapshot(collection(db, 'admins'), (snapshot) => {
                            // Reload admin list when changes occur
                            if (window.isAdmin) {
                                loadAdminList();
                            }
                        });
                    }
                } catch (error) {
                    console.error('Error checking admin status:', error);
                    window.isAdmin = false;
                }
            } else {
                // Clean up listener when user logs out
                if (adminListener) {
                    adminListener();
                    adminListener = null;
                }
            }
        });
    </script>
    


    <script>

    // Comprehensive Firestore structure check
    async function checkFirestoreStructure() {
        try {
            console.log('=== COMPREHENSIVE FIRESTORE CHECK ===');
            
            // Check current authentication state
            const currentUser = window.firebaseAuth.currentUser;
            console.log('Current authenticated user:', currentUser?.email || 'No user logged in');
            
            // Check users collection
            const usersRef = window.firebaseFirestore.collection(window.firebaseDB, 'users');
            const usersSnapshot = await window.firebaseFirestore.getDocs(usersRef);
            
            console.log('=== USERS COLLECTION ANALYSIS ===');
            console.log('Total documents in users collection:', usersSnapshot.size);
            
            if (usersSnapshot.empty) {
                console.log('‚ùå USERS COLLECTION IS EMPTY!');
                alert('‚ùå No users found in Firestore! The users collection is completely empty.');
                return;
            }
            
            const allUsers = [];
            let validUsers = 0;
            let invalidUsers = 0;
            
            usersSnapshot.forEach(doc => {
                const userData = doc.data();
                const docId = doc.id;
                
                const userInfo = {
                    documentId: docId,
                    documentData: userData,
                    hasEmail: !!userData.email,
                    hasFirstName: !!userData.firstName,
                    hasLastName: !!userData.lastName,
                    dataKeys: Object.keys(userData || {}),
                    dataValues: Object.values(userData || {}),
                    isValid: !!(userData.email && userData.firstName && userData.lastName)
                };
                
                allUsers.push(userInfo);
                
                if (userInfo.isValid) {
                    validUsers++;
                } else {
                    invalidUsers++;
                }
                
                console.log(`Document ID: "${docId}"`);
                console.log(`  Email: ${userData.email || 'MISSING'}`);
                console.log(`  First Name: ${userData.firstName || 'MISSING'}`);
                console.log(`  Last Name: ${userData.lastName || 'MISSING'}`);
                console.log(`  Data Keys: [${Object.keys(userData || {}).join(', ')}]`);
                console.log(`  Status: ${userInfo.isValid ? '‚úÖ VALID' : '‚ùå INVALID'}`);
                console.log('---');
            });
            
            // Create detailed report
            const report = {
                totalDocuments: usersSnapshot.size,
                validUsers: validUsers,
                invalidUsers: invalidUsers,
                allUsers: allUsers
            };
            
            console.log('=== FIRESTORE SUMMARY ===');
            console.log('Total documents:', report.totalDocuments);
            console.log('Valid users:', report.validUsers);
            console.log('Invalid users:', report.invalidUsers);
            console.log('Complete data:', JSON.stringify(report, null, 2));
            
            // Display alert with findings
            let alertMessage = `üìä FIRESTORE ANALYSIS RESULTS:

üìà Collection Stats:
‚Ä¢ Total documents: ${report.totalDocuments}
‚Ä¢ Valid users: ${report.validUsers}
‚Ä¢ Invalid users: ${report.invalidUsers}

üîç Document IDs found:
`;
            
            allUsers.forEach(user => {
                alertMessage += `‚Ä¢ "${user.documentId}" (${user.isValid ? '‚úÖ Valid' : '‚ùå Invalid'})
`;
            });
            
            if (invalidUsers > 0) {
                alertMessage += `
‚ö†Ô∏è INVALID USERS FOUND:
These documents are missing required fields (email, firstName, lastName).
Check the console for detailed information about each invalid user.
`;
            }
            
            alertMessage += `
üí° Next Steps:
1. Check the browser console for complete details
2. Verify user creation process
3. Check if new users are being created with correct field names
4. Ensure document IDs match expected format (email addresses)

üîó Firebase Console Link:
https://console.firebase.google.com/project/your-project-id/firestore/data/~2Fusers

Replace 'your-project-id' with your actual Firebase project ID.`;
            
            alert(alertMessage);
            
            // Also check if we can access the authentication data
            try {
                console.log('=== AUTHENTICATION CHECK ===');
                if (currentUser) {
                    console.log('Current user email:', currentUser.email);
                    console.log('Current user UID:', currentUser.uid);
                    
                    // Check if current user exists in the users collection
                    const currentUserDoc = allUsers.find(u => u.documentId === currentUser.email);
                    if (currentUserDoc) {
                        console.log('‚úÖ Current user found in users collection');
                    } else {
                        console.log('‚ùå Current user NOT found in users collection');
                        console.log('Available document IDs:', allUsers.map(u => u.documentId));
                    }
                } else {
                    console.log('‚ùå No user currently logged in');
                }
            } catch (authError) {
                console.error('Error checking authentication:', authError);
            }
            
            console.log('=== FIRESTORE CHECK COMPLETE ===');
            
        } catch (error) {
            console.error('Error checking Firestore structure:', error);
            alert(`‚ùå Error checking Firestore: ${error.message}\n\nCheck the browser console for details.`);
        }
    }
    </script>
    

    
    <style>
        
        /* Modern Student Card Styles */
        .student-card {
            transition: all 0.3s ease;
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            border: 1px solid #e2e8f0;
            border-radius: 1rem;
            overflow: hidden;
        }
        
        .student-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            border-color: #cbd5e0;
        }
        
        .student-avatar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-weight: bold;
            font-size: 1.25rem;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }
        
        .rank-badge {
            background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%);
            color: #92400e;
            font-weight: bold;
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
            border-radius: 9999px;
        }
        
        .points-display {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            font-weight: bold;
            font-size: 1.5rem;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            text-align: center;
            min-width: 60px;
        }
        
        .progress-bar {
            background: linear-gradient(90deg, #3b82f6 0%, #1d4ed8 100%);
            transition: width 0.3s ease;
            height: 0.375rem;
            border-radius: 9999px;
        }
        
        .progress-container {
            background-color: #e5e7eb;
            border-radius: 9999px;
            height: 0.375rem;
            overflow: hidden;
        }
        
        .quick-action-btn {
            transition: all 0.2s ease;
            border-radius: 50%;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.875rem;
        }
        
        .quick-action-btn:hover {
            transform: scale(1.1);
        }
        
        .student-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1.5rem;
            padding: 1rem;
        }
        
        @media (max-width: 768px) {
            .student-grid {
                grid-template-columns: 1fr;
                gap: 1rem;
                padding: 0.5rem;
            }
        }
        
        @media (min-width: 1200px) {
            .student-grid {
                grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            }
        }
        
        /* Animation keyframes */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .animate-fade-in-up {
            animation: fadeInUp 0.5s ease-out;
        }
        
        /* Loading skeleton animation */
        .skeleton {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
        }
        
        @keyframes loading {
            0% {
                background-position: 200% 0;
            }
            100% {
                background-position: -200% 0;
            }
        }
        
        /* Modal animations */
        .modal-enter {
            opacity: 0;
            transform: scale(0.9);
        }
        
        .modal-enter-active {
            opacity: 1;
            transform: scale(1);
            transition: opacity 0.3s, transform 0.3s;
        }
    </style>
</head>
<body class="bg-gray-50 font-sans">
<div class="flex flex-col md:flex-row min-h-screen">
    <!-- Mobile Header (visible on small screens) -->
    <div class="md:hidden bg-white shadow-sm p-4 flex items-center justify-between">
        <div class="flex items-center">
            <img src="images/logo1.png" alt="Behaviour Tracker" class="w-8 h-8 mr-2 rounded-lg">
            <h1 class="text-xl font-bold text-gray-800">Behaviour Tracker</h1>
        </div>
        <button id="mobileMenuBtn" class="text-gray-700 hover:bg-gray-100 p-2 rounded-lg">
            <i class="fas fa-bars"></i>
        </button>
    </div>

    <!-- Sidebar (hidden on mobile by default) -->
    <aside id="sidebar" class="w-full md:w-64 bg-white shadow-lg md:block hidden transition-all duration-300 ease-in-out">
        <div class="p-4 md:p-6 hidden md:block text-center">
            <img src="images/logo1.png" alt="Behaviour Tracker" class="w-16 h-16 mx-auto mb-2 rounded-lg">
            <h1 class="text-xl md:text-2xl font-bold text-gray-800">Behaviour Tracker</h1>
        </div>
        
        <nav class="px-4 py-2">
            <button class="flex items-center justify-center w-full px-4 py-3 mb-2 text-white bg-purple-500 rounded-lg hover:bg-purple-600 relative group" data-content="Dashboard">
                <i class="fas fa-home text-lg mr-2"></i>
                <span class="text-sm font-medium">Dashboard</span>
                <div class="absolute left-full ml-2 top-1/2 -translate-y-1/2 bg-gray-800 text-white text-xs px-2 py-1 rounded opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap z-10">
                    View overall stats and quick actions
                </div>
            </button>
            
            <button id="adminBtn" class="flex items-center justify-center w-full px-4 py-3 mb-2 text-white bg-green-500 rounded-lg hover:bg-green-600 relative group" style="display:none;" data-content="Admin">
                <i class="fas fa-user-shield text-lg mr-2"></i>
                <span class="text-sm font-medium">Admin</span>
                <div class="absolute left-full ml-2 top-1/2 -translate-y-1/2 bg-gray-800 text-white text-xs px-2 py-1 rounded opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap z-10">
                    Manage users and system settings
                </div>
            </button>
            
            <div class="mb-4">
                <button id="classesDropdownBtn" class="flex items-center justify-center w-full px-4 py-3 text-gray-700 hover:bg-gray-100 rounded-lg relative group">
                    <i class="fas fa-chalkboard-teacher text-lg mr-2"></i>
                    <span class="text-sm font-medium">Classes</span>
                    <i class="fas fa-chevron-down ml-auto"></i>
                    <div class="absolute left-full ml-2 top-1/2 -translate-y-1/2 bg-gray-800 text-white text-xs px-2 py-1 rounded opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap z-10">
                        Manage your classes and students
                    </div>
                </button>
                <div id="classesDropdownMenu" class="hidden mt-2 ml-4">
                    <!-- Classes will be loaded here -->
                </div>
            </div>
            

            
            <button class="flex items-center justify-center w-full px-4 py-3 text-gray-700 hover:bg-gray-100 rounded-lg relative group" data-content="Logout">
                <i class="fas fa-sign-out-alt text-lg mr-2"></i>
                <span class="text-sm font-medium">Logout</span>
                <div class="absolute left-full ml-2 top-1/2 -translate-y-1/2 bg-gray-800 text-white text-xs px-2 py-1 rounded opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap z-10">
                    Sign out of your account
                </div>
            </button>
        </nav>
    </aside>

    <!-- Mobile Menu Overlay -->
    <div class="mobile-menu-overlay" id="mobileMenuOverlay"></div>

    <!-- Main Content -->
    <main class="flex-1 p-4 md:p-6 lg:p-8">
        <div id="content" class="max-w-7xl mx-auto">
            <!-- Content will be dynamically loaded here -->
        </div>
    </main>
</div>

<!-- Password Modal -->
<div id="passwordModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
    <div class="bg-white p-8 rounded-xl max-w-md w-full mx-4">
        <h3 class="text-xl font-bold mb-4">Enter Class Password</h3>
        <div class="relative">
            <input type="password" id="classPasswordInput" class="w-full px-3 py-2 border border-gray-300 rounded-lg mb-4 pr-10" placeholder="Enter password">
            <button type="button" class="absolute right-2 top-2 text-gray-500 hover:text-gray-700" onclick="toggleClassPasswordVisibility()">
                <i class="fas fa-eye" id="passwordToggleIcon"></i>
            </button>
        </div>
        <div class="flex gap-4">
            <button id="submitPassword" class="flex-1 bg-purple-500 text-white py-2 rounded-lg hover:bg-purple-600">Submit</button>
            <button id="cancelPassword" class="flex-1 bg-gray-300 text-gray-700 py-2 rounded-lg hover:bg-gray-400">Cancel</button>
        </div>
        <p id="passwordError" class="text-red-500 mt-2 hidden">Incorrect password. Please try again.</p>
    </div>
</div>

<script>
    // Global variables
    let currentClass = '';
    let adminClassPasswords = {};
    
    // Mobile menu toggle
    document.addEventListener('DOMContentLoaded', function() {
        const mobileMenuBtn = document.getElementById('mobileMenuBtn');
        const sidebar = document.getElementById('sidebar');
        const overlay = document.getElementById('mobileMenuOverlay');
        
        if (mobileMenuBtn && sidebar && overlay) {
            function openMobileMenu() {
                sidebar.classList.remove('hidden');
                overlay.classList.add('active');
                document.body.style.overflow = 'hidden'; // Prevent body scroll
            }
            
            function closeMobileMenu() {
                sidebar.classList.add('hidden');
                overlay.classList.remove('active');
                document.body.style.overflow = ''; // Restore body scroll
            }
            
            mobileMenuBtn.addEventListener('click', function() {
                if (sidebar.classList.contains('hidden')) {
                    openMobileMenu();
                } else {
                    closeMobileMenu();
                }
            });
            
            // Close sidebar when clicking on overlay
            overlay.addEventListener('click', closeMobileMenu);
            
            // Close sidebar when clicking anywhere outside (on main content)
            document.addEventListener('click', function(event) {
                const isClickInsideSidebar = sidebar.contains(event.target);
                const isClickOnHamburger = mobileMenuBtn.contains(event.target);
                
                if (!isClickInsideSidebar && !isClickOnHamburger && !sidebar.classList.contains('hidden')) {
                    closeMobileMenu();
                }
            });
            
            // Close sidebar when clicking on a menu item (mobile only)
            const menuItems = sidebar.querySelectorAll('button[data-content]');
            menuItems.forEach(item => {
                item.addEventListener('click', function() {
                    if (window.innerWidth < 768) { // md breakpoint
                        closeMobileMenu();
                    }
                });
            });
            
            // Close menu when window is resized to desktop
            window.addEventListener('resize', function() {
                if (window.innerWidth >= 768) {
                    closeMobileMenu();
                }
            });
        }
    });
    
    // Tab content management
    const tabContent = {
        "Dashboard": `
            <div class="bg-white rounded-xl shadow-sm p-6 mb-6">
                <div class="flex items-center mb-4">
                    <img src="images/logo1.png" alt="Behaviour Tracker" class="w-12 h-12 mr-3 rounded-lg">
                    <div>
                        <h1 class="text-3xl font-bold text-gray-800 mb-1">Welcome back!</h1>
                        <p class="text-gray-600">Track student behavior and performance across different classes.</p>
                    </div>
                </div>
            </div>
            

            


            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 md:gap-6 mb-8">
                <div class="bg-gradient-to-r from-purple-500 to-pink-500 rounded-xl p-4 md:p-6 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-purple-100 text-xs sm:text-sm">Total Classes</p>
                            <p class="text-2xl md:text-3xl font-bold" id="totalClasses">0</p>
                        </div>
                        <i class="fas fa-chalkboard-teacher text-2xl md:text-3xl opacity-75"></i>
                    </div>
                </div>
                
                <div class="bg-gradient-to-r from-blue-500 to-cyan-500 rounded-xl p-4 md:p-6 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-blue-100 text-xs sm:text-sm">Active Students</p>
                            <p class="text-2xl md:text-3xl font-bold" id="totalStudents">0</p>
                        </div>
                        <i class="fas fa-users text-2xl md:text-3xl opacity-75"></i>
                    </div>
                </div>
                
                <div class="bg-gradient-to-r from-green-500 to-emerald-500 rounded-xl p-4 md:p-6 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-green-100 text-xs sm:text-sm">Positive Points</p>
                            <p class="text-2xl md:text-3xl font-bold" id="totalPoints">0</p>
                        </div>
                        <i class="fas fa-star text-2xl md:text-3xl opacity-75"></i>
                    </div>
                </div>
            </div>

            <!-- Export All Data Section -->
            <div class="bg-white rounded-xl shadow-sm p-4 md:p-6 mb-6 md:mb-8">
                <div class="flex items-center justify-between">
                    <div>
                        <h2 class="text-lg font-semibold text-gray-800 mb-1">
                            <i class="fas fa-file-excel text-green-500 mr-2"></i> Export All Data
                        </h2>
                        <p class="text-sm text-gray-600">Export all learner data from all classes to Excel format</p>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="exportAllClassesData()" class="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 flex items-center">
                            <i class="fas fa-download mr-2"></i> Export All Classes
                        </button>
                        <button onclick="location.reload()" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 flex items-center">
                            <i class="fas fa-sync-alt mr-2"></i> Refresh Page
                        </button>
                    </div>
                </div>
            </div>

            <!-- Top Learners Section -->
            <div class="bg-white rounded-xl shadow-sm p-4 md:p-6 mb-6 md:mb-8">
                <h2 class="text-lg font-semibold text-gray-800 mb-3">
                    <i class="fas fa-trophy text-yellow-500 mr-2"></i> Top Learners (>100 points)
                </h2>
                <div id="topLearnersContainer" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3 md:gap-4">
                    <p class="text-gray-700 italic col-span-full text-center py-4">Loading top learners...</p>
                </div>
            </div>

            <!-- Performance Chart Section -->
            <div class="bg-white rounded-xl shadow-sm p-4 md:p-6 mb-6 md:mb-8">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-lg font-semibold text-gray-800">
                        <i class="fas fa-chart-line text-blue-500 mr-2"></i> Class Performance Overview
                    </h2>
                    <select id="classSelector" class="px-3 py-2 border border-gray-300 rounded-lg text-sm">
                        <option value="all">All Classes</option>
                    </select>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div>
                        <canvas id="performanceChart" width="400" height="200"></canvas>
                    </div>
                    <div>
                        <h3 class="text-md font-medium text-gray-700 mb-3">Performance Summary</h3>
                        <div id="performanceSummary" class="space-y-2">
                            <div class="flex justify-between items-center p-2 bg-gray-50 rounded">
                                <span class="text-sm text-gray-600">Total Classes</span>
                                <span id="chartTotalClasses" class="font-semibold">-</span>
                            </div>
                            <div class="flex justify-between items-center p-2 bg-gray-50 rounded">
                                <span class="text-sm text-gray-600">Average Points</span>
                                <span id="chartAvgPoints" class="font-semibold">-</span>
                            </div>
                            <div class="flex justify-between items-center p-2 bg-gray-50 rounded">
                                <span class="text-sm text-gray-600">Highest Points</span>
                                <span id="chartHighestPoints" class="font-semibold">-</span>
                            </div>
                            <div class="flex justify-between items-center p-2 bg-gray-50 rounded">
                                <span class="text-sm text-gray-600">Most Active Class</span>
                                <span id="chartMostActive" class="font-semibold">-</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Class Export Instructions -->
            <div class="bg-blue-50 border border-blue-200 rounded-xl p-4 mb-6">
                <div class="flex items-center">
                    <i class="fas fa-info-circle text-blue-600 text-xl mr-3"></i>
                    <div>
                        <h3 class="text-sm font-medium text-blue-800">üìä Export Individual Class Data</h3>
                        <p class="text-xs text-blue-700 mt-1">
                            Click any class name in the sidebar ‚Üí Enter class password ‚Üí Look for the green "Export to Excel" button
                        </p>
                        <div class="mt-2 text-xs text-blue-600">
                            <strong>Available classes:</strong> <span id="availableClasses">Loading...</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Quick Actions section removed -->
        `,
        "Admin": `
            <div class="bg-white rounded-xl shadow-sm p-4 md:p-6">
                <div class="flex flex-col md:flex-row items-center md:items-start gap-6 mb-6">
                    <div class="w-32 h-32 bg-gradient-to-br from-purple-500 to-pink-500 rounded-full flex items-center justify-center overflow-hidden">
                        <i class="fas fa-user-shield text-white text-5xl"></i>
                    </div>
                    <div>
                        <h1 class="text-2xl font-bold text-gray-800 mb-2">Admin Panel</h1>
                        <p class="text-gray-600 mb-2">Manage classes, admins, and system settings</p>
                        <div class="flex gap-2">
                            <span class="bg-green-100 text-green-800 text-xs font-medium px-2.5 py-0.5 rounded-full">Admin Access</span>
                            <span class="bg-blue-100 text-blue-800 text-xs font-medium px-2.5 py-0.5 rounded-full">Full Privileges</span>
                        </div>
                    </div>
                </div>
                
                <!-- Admin Management Section -->
                <div class="bg-gray-50 rounded-lg p-4 mb-6">
                    <h3 class="text-lg font-medium text-gray-800 mb-3">Grant Admin Privileges</h3>
                    <div class="flex gap-2">
                        <input type="email" id="adminEmailInput" class="flex-1 px-3 py-2 border border-gray-300 rounded-lg" placeholder="Enter user email">
                        <button onclick="grantAdminPrivileges()" class="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600">
                            <i class="fas fa-user-plus mr-1"></i>Grant Admin
                        </button>
                    </div>
                </div>
                
                <!-- Current Admins Section -->
                <div class="bg-gray-50 rounded-lg p-4 mb-6">
                    <h3 class="text-lg font-medium text-gray-800 mb-3">Current Admins</h3>
                    <div id="adminList" class="space-y-2">
                        <!-- Admins will be loaded here -->
                    </div>
                </div>
                
                <!-- Reset Top Learners Section -->
                <div class="bg-gray-50 rounded-lg p-4 mb-6">
                    <h3 class="text-lg font-medium text-gray-800 mb-3">Reset Top Learners</h3>
                    <p class="text-gray-600 mb-4">Use this button to clear all top learners data when the term or period is over.</p>
                    <button onclick="confirmClearAllTopLearners()" class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600">
                        <i class="fas fa-trash mr-2"></i>Reset All Top Learners
                    </button>
                </div>
                
                <!-- Manage Classes Section -->
                <div class="bg-gray-50 rounded-lg p-4 mb-6">
                    <h3 class="text-lg font-medium text-gray-800 mb-3">Manage Classes</h3>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 md:gap-4 mb-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1 md:mb-2">Class Name</label>
                            <input type="text" id="newClassName" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm md:text-base" placeholder="Enter class name">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1 md:mb-2">Password</label>
                            <input type="password" id="newClassPassword" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm md:text-base" placeholder="Enter password">
                        </div>
                    </div>

                    <button id="addClassBtn" class="bg-purple-500 text-white px-3 md:px-4 py-2 rounded-lg hover:bg-purple-600 text-sm md:text-base">
                        <i class="fas fa-plus mr-2"></i>Add Class
                    </button>
                </div>

                <!-- Existing Classes Section -->
                <div class="bg-gray-50 rounded-lg p-4">
                    <h3 class="text-lg font-medium text-gray-800 mb-3">Existing Classes</h3>
                    <div id="classesList" class="space-y-3">
                        <p class="text-gray-700">Loading classes...</p>
                    </div>
                </div>

                <!-- User Class Allocation Section -->
                <div class="bg-gray-50 rounded-lg p-4">
                    <h3 class="text-lg font-medium text-gray-800 mb-3">User Class Allocation</h3>
                    <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-4">
                        <div class="flex">
                            <div class="flex-shrink-0">
                                <i class="fas fa-info-circle text-yellow-400 text-xl"></i>
                            </div>
                            <div class="ml-3">
                                <h4 class="text-sm font-medium text-yellow-800">Feature Coming Soon</h4>
                                <p class="text-sm text-yellow-700 mt-1">
                                    Currently, all new users automatically have access to all classes. 
                                    Advanced user-specific class allocation will be implemented in a future update.
                                </p>
                            </div>
                        </div>
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Select User Email</label>
                        <select id="userEmailSelect" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                            <option value="">Loading users...</option>
                        </select>
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Available Classes (Auto-Assigned)</label>
                        <div id="classCheckboxes" class="space-y-2">
                            <p class="text-gray-700 italic">All users currently have access to all classes by default</p>
                        </div>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="saveUserClassAllocation()" class="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 opacity-50 cursor-not-allowed" disabled>
                            <i class="fas fa-save mr-2"></i>Save Allocation
                        </button>
                        <button onclick="loadUsers()" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600">
                            <i class="fas fa-sync-alt mr-2"></i>Refresh Users
                        </button>
                        <button onclick="diagnosticLoadUsers()" class="bg-purple-500 text-white px-4 py-2 rounded-lg hover:bg-purple-600">
                            <i class="fas fa-search mr-2"></i>Diagnose Users
                        </button>
                        <button onclick="checkFirestoreStructure()" class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600">
                            <i class="fas fa-database mr-2"></i>Check Firestore
                        </button>
                    </div>
                </div>
            </div>
        `,
        "Logout": `
            <div class="bg-white rounded-xl shadow-sm p-6 text-center">
                <h1 class="text-2xl font-bold text-gray-800 mb-4">Logging Out...</h1>
                <p class="text-gray-600">You will be redirected to the login page.</p>
            </div>
        `
    };

    // Load classes from Firestore with user permissions


    // Real-time listener for classes
    let classesListener = null;
    
    async function loadClasses() {
        try {
            console.log('Setting up real-time listener for classes...');
            const classesRef = window.firebaseFirestore.collection(window.firebaseDB, 'classes');
            adminClassPasswords = {};
            
            // Clean up existing listener
            if (classesListener) {
                classesListener();
                classesListener = null;
            }
            
            // Set up real-time listener
            classesListener = window.firebaseFirestore.onSnapshot(classesRef, (snapshot) => {
                console.log(`Real-time update: Found ${snapshot.size} classes`);
                
                if (snapshot.empty) {
                    console.log('No classes found in Firestore');
                    adminClassPasswords = {};
                    
                    // Show "No Classes Found" message
                    setTimeout(() => {
                        const classesList = document.getElementById('classesList');
                        if (classesList) {
                            classesList.innerHTML = `
                                <div class="text-center py-8">
                                    <i class="fas fa-users-slash text-4xl text-gray-400 mb-4"></i>
                                    <h3 class="text-lg font-medium text-gray-900 mb-2">No Classes Found</h3>
                                    <p class="text-gray-600 mb-4">There are no classes in the system yet.</p>
                                    <p class="text-sm text-gray-500">New classes will appear here automatically</p>
                                </div>
                            `;
                        }
                    }, 100);
                } else {
                // Process all classes in real-time
                adminClassPasswords = {};
                
                snapshot.forEach(doc => {
                    const classData = doc.data();
                    const className = String(doc.id || '').trim();
                    
                    // All users see all classes
                    adminClassPasswords[className] = {
                        password: classData.password
                    };
                    console.log(`‚úì Real-time update: "${className}"`);
                });
            }
            
            // Update UI with new data, ensuring DOM is ready
            requestAnimationFrame(() => {
                updateClassesList();
                updateTabContentWithClasses();
            });
                
            }, (error) => {
                console.error('Error in classes real-time listener:', error);
                const classesList = document.getElementById('classesList');
                if (classesList) {
                    classesList.innerHTML = `
                        <div class="text-red-500 p-4 bg-red-50 rounded-lg">
                            <strong>Real-time sync error:</strong><br>
                            ${error.message}<br><br>
                            <button onclick="loadClasses()" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600">
                                <i class="fas fa-sync-alt mr-2"></i>Reconnect
                            </button>
                        </div>
                    `;
                }
            });
            
        } catch (error) {
            console.error('Error setting up classes listener:', error);
        }
    }

    // Real-time listener for users in admin panel
    let usersListener = null;
    
    async function loadUsers() {
        try {
            console.log('Setting up real-time user listener...');
            const usersRef = window.firebaseFirestore.collection(window.firebaseDB, 'users');
            
            // Clean up existing listener
            if (usersListener) {
                usersListener();
                usersListener = null;
            }
            
            // Wait for DOM to be ready with retry limit
            let retryCount = 0;
            const maxRetries = 50; // 5 seconds max
            const checkUserSelect = setInterval(() => {
                const userSelect = document.getElementById('userEmailSelect');
                if (userSelect) {
                    clearInterval(checkUserSelect);
                    
                    // Show loading state
                    userSelect.innerHTML = '<option value="">Loading users...</option>';
                    
                    // Set up real-time listener
            usersListener = window.firebaseFirestore.onSnapshot(usersRef, (snapshot) => {
                console.log(`Real-time users update: ${snapshot.size} users`);
                
                const userSelect = document.getElementById('userEmailSelect');
                if (!userSelect) {
                    console.warn('userEmailSelect element not found, skipping user update');
                    return;
                }
                
                userSelect.innerHTML = '<option value="">Select a user...</option>';
                        
                        if (snapshot.empty) {
                            userSelect.innerHTML = '<option value="">No users found</option>';
                            return;
                        }
                        
                        let userCount = 0;
                        
                        snapshot.forEach(doc => {
                            const userData = doc.data();
                            const userEmail = doc.id; // Document ID is the email
                            
                            // Use the data from the document, but ensure we have the required fields
                            const email = userData.email || userEmail;
                            const firstName = userData.firstName || '';
                            const lastName = userData.lastName || '';
                            
                            if (email && firstName && lastName) {
                                const option = document.createElement('option');
                                option.value = email;
                                option.textContent = `${firstName} ${lastName} (${email})`;
                                userSelect.appendChild(option);
                                userCount++;
                            }
                        });
                        
                        if (userCount === 0) {
                            userSelect.innerHTML = '<option value="">No valid users found</option>';
                        }
                        
                        // Remove existing event listener to prevent duplicates
                        userSelect.removeEventListener('change', loadUserClassCheckboxes);
                        userSelect.addEventListener('change', loadUserClassCheckboxes);
                        
                    }, (error) => {
                        console.error('Error in users listener:', error);
                        userSelect.innerHTML = '<option value="">Error loading users</option>';
                    });
                    
                } else {
                    retryCount++;
                    if (retryCount >= maxRetries) {
                        clearInterval(checkUserSelect);
                        console.warn('userEmailSelect element not found after max retries');
                    }
                }
            }, 100);
            
        } catch (error) {
            console.error('Error setting up users listener:', error);
            let retryCount = 0;
            const maxRetries = 50;
            const checkUserSelect = setInterval(() => {
                const userSelect = document.getElementById('userEmailSelect');
                if (userSelect) {
                    clearInterval(checkUserSelect);
                    userSelect.innerHTML = '<option value="">Error loading users</option>';
                } else {
                    retryCount++;
                    if (retryCount >= maxRetries) {
                        clearInterval(checkUserSelect);
                        console.warn('userEmailSelect element not found after max retries in error handler');
                    }
                }
            }, 100);
        }
    }
    
    // Diagnostic function for troubleshooting user data
    async function diagnosticLoadUsers() {
        try {
            console.log('=== DIAGNOSTIC: Checking User Data ===');
            const usersRef = window.firebaseFirestore.collection(window.firebaseDB, 'users');
            const snapshot = await window.firebaseFirestore.getDocs(usersRef);
            const userSelect = document.getElementById('userEmailSelect');
            
            if (!userSelect) {
                console.error('userEmailSelect element not found');
                return;
            }
            
            console.log(`Total documents in 'users' collection: ${snapshot.size}`);
            
            // Create diagnostic report
            let diagnosticReport = `=== USER DATA DIAGNOSTIC ===\n\n`;
            diagnosticReport += `Total documents found: ${snapshot.size}\n\n`;
            
            if (snapshot.empty) {
                diagnosticReport += "‚ùå No users found in 'users' collection!\n";
                diagnosticReport += "Possible causes:\n";
                diagnosticReport += "1. No users have been created yet\n";
                diagnosticReport += "2. Users are in a different collection\n";
                diagnosticReport += "3. Security rules are blocking access\n";
                diagnosticReport += "4. Check Firebase Console: https://console.firebase.google.com/\n";
                console.log(diagnosticReport);
                userSelect.innerHTML = '<option value="">‚ùå No users found</option>';
                alert(diagnosticReport);
                return;
            }
            
            userSelect.innerHTML = '<option value="">Select a user...</option>';
            let validUsers = 0;
            let invalidUsers = 0;
            let userDetails = [];
            
            console.log('=== RAW FIRESTORE DATA ===');
            snapshot.forEach((doc, index) => {
                const userData = doc.data();
                const docId = doc.id;
                
                console.log(`Document ${index + 1}:`, {
                    id: docId,
                    data: userData,
                    hasEmail: !!userData.email,
                    hasFirstName: !!userData.firstName,
                    hasLastName: !!userData.lastName
                });
                
                userDetails.push({
                    id: docId,
                    email: userData.email || docId,
                    firstName: userData.firstName || '',
                    lastName: userData.lastName || '',
                    rawData: userData
                });
                
                const email = userData.email || docId;
                const firstName = userData.firstName || '';
                const lastName = userData.lastName || '';
                
                if (email && firstName && lastName) {
                    const option = document.createElement('option');
                    option.value = email;
                    option.textContent = `${firstName} ${lastName} (${email})`;
                    userSelect.appendChild(option);
                    validUsers++;
                } else {
                    invalidUsers++;
                }
            });
            
            diagnosticReport += `=== DETAILED USER ANALYSIS ===\n`;
            userDetails.forEach((user, index) => {
                diagnosticReport += `\n${index + 1}. Document ID: "${user.id}"\n`;
                diagnosticReport += `   Email: "${user.email}"\n`;
                diagnosticReport += `   First Name: "${user.firstName || "‚ùå MISSING"}"\n`;
                diagnosticReport += `   Last Name: "${user.lastName || "‚ùå MISSING"}"\n`;
                diagnosticReport += `   Status: ${(user.firstName && user.lastName) ? "‚úÖ Valid" : "‚ùå Incomplete"}\n`;
                diagnosticReport += `   Raw data keys: ${Object.keys(user.rawData).join(', ')}\n`;
            });
            
            diagnosticReport += `\n=== SUMMARY ===\n`;
            diagnosticReport += `Valid users: ${validUsers}\n`;
            diagnosticReport += `Invalid users (missing data): ${invalidUsers}\n`;
            diagnosticReport += `Total documents: ${snapshot.size}\n`;
            diagnosticReport += `All document IDs: ${userDetails.map(u => `"${u.id}"`).join(', ')}\n`;
            
            console.log(diagnosticReport);
            alert(diagnosticReport);
            
            if (validUsers === 0) {
                userSelect.innerHTML = '<option value="">‚ùå No valid users found</option>';
                console.warn("All users have incomplete data - check Firestore documents");
                
                // Additional debug: suggest checking Firebase Console
                console.log("üí° TIP: Check your Firebase Console at https://console.firebase.google.com/");
                console.log("üí° Navigate to: Firestore Database > Data > users collection");
            }
            
        } catch (error) {
            console.error('Diagnostic error:', error);
            alert(`Error loading users: ${error.message}`);
            
            // Additional error debugging
            console.log("üîç Error details:", {
                error: error.message,
                stack: error.stack,
                code: error.code
            });
        }
    }
    
    // Comprehensive Firestore structure check
    async function checkFirestoreStructure() {
        try {
            console.log('=== COMPREHENSIVE FIRESTORE CHECK ===');
            
            // Check current authentication state
            const currentUser = window.firebaseAuth.currentUser;
            console.log('Current authenticated user:', currentUser?.email || 'No user logged in');
            
            // Check users collection
            const usersRef = window.firebaseFirestore.collection(window.firebaseDB, 'users');
            const usersSnapshot = await window.firebaseFirestore.getDocs(usersRef);
            
            console.log('=== USERS COLLECTION ANALYSIS ===');
            console.log('Total documents in users collection:', usersSnapshot.size);
            
            if (usersSnapshot.empty) {
                console.log('‚ùå USERS COLLECTION IS EMPTY!');
                alert('‚ùå No users found in Firestore! The users collection is completely empty.');
                return;
            }
            
            const allUsers = [];
            let validUsers = 0;
            let invalidUsers = 0;
            
            usersSnapshot.forEach(doc => {
                const userData = doc.data();
                const docId = doc.id;
                
                const userInfo = {
                    documentId: docId,
                    documentData: userData,
                    hasEmail: !!userData.email,
                    hasFirstName: !!userData.firstName,
                    hasLastName: !!userData.lastName,
                    dataKeys: Object.keys(userData || {}),
                    dataValues: Object.values(userData || {}),
                    isValid: !!(userData.email && userData.firstName && userData.lastName)
                };
                
                allUsers.push(userInfo);
                
                if (userInfo.isValid) {
                    validUsers++;
                } else {
                    invalidUsers++;
                }
                
                console.log(`Document ID: "${docId}"`);
                console.log(`  Email: ${userData.email || 'MISSING'}`);
                console.log(`  First Name: ${userData.firstName || 'MISSING'}`);
                console.log(`  Last Name: ${userData.lastName || 'MISSING'}`);
                console.log(`  Data Keys: [${Object.keys(userData || {}).join(', ')}]`);
                console.log(`  Status: ${userInfo.isValid ? '‚úÖ VALID' : '‚ùå INVALID'}`);
                console.log('---');
            });
            
            // Create detailed report
            const report = {
                totalDocuments: usersSnapshot.size,
                validUsers: validUsers,
                invalidUsers: invalidUsers,
                allUsers: allUsers
            };
            
            console.log('=== FIRESTORE SUMMARY ===');
            console.log('Total documents:', report.totalDocuments);
            console.log('Valid users:', report.validUsers);
            console.log('Invalid users:', report.invalidUsers);
            console.log('Complete data:', JSON.stringify(report, null, 2));
            
            // Display alert with findings
            let alertMessage = `üìä FIRESTORE ANALYSIS RESULTS:

üìà Collection Stats:
‚Ä¢ Total documents: ${report.totalDocuments}
‚Ä¢ Valid users: ${report.validUsers}
‚Ä¢ Invalid users: ${report.invalidUsers}

üîç Document IDs found:
`;
            
            allUsers.forEach(user => {
                alertMessage += `‚Ä¢ "${user.documentId}" (${user.isValid ? '‚úÖ Valid' : '‚ùå Invalid'})\n`;
            });
            
            if (invalidUsers > 0) {
                alertMessage += `
‚ö†Ô∏è INVALID USERS FOUND:
These documents are missing required fields (email, firstName, lastName).
Check the console for detailed information about each invalid user.
`;
            }
            
            alertMessage += `
üí° Next Steps:
1. Check the browser console for complete details
2. Verify user creation process
3. Check if new users are being created with correct field names
4. Ensure document IDs match expected format (email addresses)

üîó Firebase Console Link:
https://console.firebase.google.com/project/your-project-id/firestore/data/~2Fusers

Replace 'your-project-id' with your actual Firebase project ID.`;
            
            alert(alertMessage);
            
            // Also check if we can access the authentication data
            try {
                console.log('=== AUTHENTICATION CHECK ===');
                if (currentUser) {
                    console.log('Current user email:', currentUser.email);
                    console.log('Current user UID:', currentUser.uid);
                    
                    // Check if current user exists in the users collection
                    const currentUserDoc = allUsers.find(u => u.documentId === currentUser.email);
                    if (currentUserDoc) {
                        console.log('‚úÖ Current user found in users collection');
                    } else {
                        console.log('‚ùå Current user NOT found in users collection');
                        console.log('Available document IDs:', allUsers.map(u => u.documentId));
                    }
                } else {
                    console.log('‚ùå No user currently logged in');
                }
            } catch (authError) {
                console.error('Error checking authentication:', authError);
            }
            
            console.log('=== FIRESTORE CHECK COMPLETE ===');
            
        } catch (error) {
            console.error('Error checking Firestore structure:', error);
            alert(`‚ùå Error checking Firestore: ${error.message}\n\nCheck the browser console for details.`);
        }
    }

    // Replace the refresh button to use diagnostic function
    // Update the refresh button in the HTML to use diagnosticLoadUsers instead
    // Real-time listener for user class checkboxes
    let userClassCheckboxesListener = null;
    
    async function loadUserClassCheckboxes() {
        const userEmailSelect = document.getElementById('userEmailSelect');
        const classCheckboxes = document.getElementById('classCheckboxes');
        
        if (!userEmailSelect || !classCheckboxes) {
            console.error('Required elements not found');
            return;
        }
        
        const userEmail = userEmailSelect.value;
        
        if (!userEmail) {
            classCheckboxes.innerHTML = '<p class="text-gray-700">Select a user first</p>';
            return;
        }
        
        try {
            // Clean up existing listener
            if (userClassCheckboxesListener) {
                userClassCheckboxesListener();
                userClassCheckboxesListener = null;
            }
            
            // Show loading state
            classCheckboxes.innerHTML = '<p class="text-gray-500"><i class="fas fa-spinner fa-spin mr-2"></i>Loading user classes...</p>';
            
            // Set up real-time listener for this specific user's classes
            const userClassesRef = window.firebaseFirestore.doc(window.firebaseDB, 'userClasses', userEmail);
            
            userClassCheckboxesListener = window.firebaseFirestore.onSnapshot(userClassesRef, (doc) => {
                const userClasses = doc.exists() ? doc.data().classes || [] : [];
                
                // Create checkboxes for all classes
                classCheckboxes.innerHTML = '';
                console.log('Available classes for checkboxes:', Object.keys(adminClassPasswords));
                console.log('User has classes:', userClasses);
                
                if (Object.keys(adminClassPasswords).length === 0) {
                    classCheckboxes.innerHTML = '<p class="text-gray-500">No classes available. Please create classes first.</p>';
                    return;
                }
                
                Object.keys(adminClassPasswords).forEach(className => {
                    const isChecked = userClasses.some(userClass => 
                        userClass.trim().toLowerCase() === className.trim().toLowerCase()
                    );
                    const div = document.createElement('div');
                    div.className = 'flex items-center';
                    div.innerHTML = `
                        <input type="checkbox" id="class-${className}" value="${className}" ${isChecked ? 'checked' : ''} class="mr-2">
                        <label for="class-${className}" class="text-sm text-gray-700">${className}</label>
                    `;
                    classCheckboxes.appendChild(div);
                });
            }, (error) => {
                console.error('Error in user class checkboxes listener:', error);
                classCheckboxes.innerHTML = `<p class="text-red-500"><i class="fas fa-exclamation-triangle mr-2"></i>Error loading user classes: ${error.message}</p>`;
            });
            
        } catch (error) {
            console.error('Error setting up user class checkboxes listener:', error);
            classCheckboxes.innerHTML = `<p class="text-red-500">Error: ${error.message}</p>`;
        }
    }

    // Real-time listener for user class allocations
    let userClassesListener = null;
    
    // Load user class allocations for admin display
    async function loadUserClassAllocations() {
        try {
            const userClassesRef = window.firebaseFirestore.collection(window.firebaseDB, 'userClasses');
            
            // Clean up existing listener
            if (userClassesListener) {
                userClassesListener();
                userClassesListener = null;
            }
            
            // Set up real-time listener
            userClassesListener = window.firebaseFirestore.onSnapshot(userClassesRef, (snapshot) => {
                console.log(`Real-time user class allocations update: ${snapshot.size} allocations`);
                
                // This function is mainly for logging/debugging purposes
                // The actual display happens in loadUserClassCheckboxes when a user is selected
                
                // Also trigger a reload of user class checkboxes if a user is selected
                const userEmailSelect = document.getElementById('userEmailSelect');
                if (userEmailSelect && userEmailSelect.value) {
                    loadUserClassCheckboxes();
                }
            }, (error) => {
                console.error('Error in user class allocations listener:', error);
            });
            
        } catch (error) {
            console.error('Error setting up user class allocations listener:', error);
        }
    }

    // Save user class allocation
    async function saveUserClassAllocation() {
        const userEmailSelect = document.getElementById('userEmailSelect');
        if (!userEmailSelect) {
            alert('User selection element not found');
            return;
        }
        
        const userEmail = userEmailSelect.value;
        if (!userEmail) {
            alert('Please select a user');
            return;
        }
        
        const selectedClasses = [];
            document.querySelectorAll('#classCheckboxes input[type="checkbox"]:checked').forEach(checkbox => {
                selectedClasses.push(checkbox.value.trim());
            });
            console.log('Saving classes for user:', selectedClasses);
        
        try {
            const userClassesRef = window.firebaseFirestore.doc(window.firebaseDB, 'userClasses', userEmail);
            console.log('About to save classes:', selectedClasses);
            await window.firebaseFirestore.setDoc(userClassesRef, {
                classes: selectedClasses,
                updatedAt: new Date().toISOString()
            });
            console.log('Successfully saved classes for user:', userEmail);
            
            alert('Class allocation saved successfully!');
            
            // Reload classes for the user if they're viewing
            if (userEmail === window.firebaseAuth.currentUser?.email) {
                loadClasses();
            }
        } catch (error) {
            console.error('Error saving user classes:', error);
            alert('Error saving class allocation. Please try again.');
        }
    }

    // Toggle password visibility
    function togglePasswordVisibility(button) {
        const passwordSpan = button.previousElementSibling;
        const password = passwordSpan.getAttribute('data-password');
        const icon = button.querySelector('i');
        
        if (passwordSpan.textContent === '*'.repeat(password.length)) {
            passwordSpan.textContent = password;
            icon.className = 'fas fa-eye-slash';
        } else {
            passwordSpan.textContent = '*'.repeat(password.length);
            icon.className = 'fas fa-eye';
        }
    }

    // Update classes list in admin panel
    function updateClassesList() {
        console.log('updateClassesList called, adminClassPasswords:', adminClassPasswords);
        const classesList = document.getElementById('classesList');
        if (!classesList) {
            console.warn('classesList element not found - skipping update');
            return;
        }

        classesList.innerHTML = '';
        
        const classes = Object.keys(adminClassPasswords);
        console.log('Found classes:', classes);
        
        if (classes.length === 0) {
            classesList.innerHTML = '<p class="text-gray-500">No classes created yet. Add a class above to get started.</p>';
            console.log('No classes to display');
            return;
        }
        
        classes.forEach(className => {
            const classData = adminClassPasswords[className];
            console.log('Creating item for class:', className);
            const classItem = document.createElement('div');
            classItem.className = 'flex items-center justify-between p-4 bg-gray-50 rounded-lg';
            classItem.innerHTML = `
                <div class="flex-1">
                    <div class="flex items-center mb-2">
                        <span class="font-medium text-lg">${className}</span>
                        <span class="text-sm text-gray-500 ml-2">(Password protected)</span>
                    </div>
                    <div class="text-sm text-gray-600 mb-2">
                        <strong>Password:</strong>
                        <span class="password-display ml-2 font-mono text-xs bg-gray-200 px-2 py-1 rounded" data-password="${classData.password}">
                            ${'*'.repeat(classData.password.length)}
                        </span>
                        <button class="show-password-btn ml-2 text-blue-500 hover:text-blue-700" onclick="togglePasswordVisibility(this)">
                            <i class="fas fa-eye"></i>
                        </button>
                    </div>
                </div>
                <div class="ml-4 flex gap-2">
                    <button class="text-blue-500 hover:text-blue-700 p-2" onclick="editClassName('${className}')" title="Edit class name">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="text-green-500 hover:text-green-700 p-2" onclick="editClassPassword('${className}')" title="Change password">
                        <i class="fas fa-key"></i>
                    </button>
                    <button class="text-red-500 hover:text-red-700 p-2" onclick="removeClass('${className}')" title="Delete class">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            `;
            classesList.appendChild(classItem);
        });
        
        console.log('Updated classes list with', classes.length, 'classes');
    }

    // Add new class
    async function addNewClass() {
        const className = document.getElementById('newClassName').value.trim();
        const password = document.getElementById('newClassPassword').value.trim();

        if (!className || !password) {
            alert('Please enter both class name and password');
            return;
        }

        try {
            // Show loading state
            const addBtn = document.getElementById('addClassBtn');
            const originalText = addBtn.innerHTML;
            addBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Adding...';
            addBtn.disabled = true;

            const classRef = window.firebaseFirestore.doc(window.firebaseDB, 'classes', className);
            await window.firebaseFirestore.setDoc(classRef, {
                password: password,
                createdAt: new Date().toISOString()
            });

            // Clear fields
            document.getElementById('newClassName').value = '';
            document.getElementById('newClassPassword').value = '';
            
            // Success prompt
            alert(`‚úÖ Class "${className}" has been successfully created!`);
            
            // Restore button state
            addBtn.innerHTML = originalText;
            addBtn.disabled = false;
            
        } catch (error) {
            console.error('Error adding class:', error);
            alert('Error adding class. Please try again.');
            
            // Restore button state on error
            const addBtn = document.getElementById('addClassBtn');
            addBtn.innerHTML = '<i class="fas fa-plus mr-2"></i>Add Class';
            addBtn.disabled = false;
        }
    }

    // Remove class
    async function removeClass(className) {
        if (!confirm(`Are you sure you want to remove ${className}?`)) return;

        try {
            await window.firebaseFirestore.deleteDoc(window.firebaseFirestore.doc(window.firebaseDB, 'classes', className));
            loadClasses(); // Reload classes
        } catch (error) {
            console.error('Error removing class:', error);
            alert('Error removing class. Please try again.');
        }
    }

    // Edit class name
    async function editClassName(oldClassName) {
        const newClassName = prompt('Enter new class name:', oldClassName);
        
        if (!newClassName || newClassName.trim() === '' || newClassName === oldClassName) {
            return; // User cancelled or entered same name
        }
        
        const trimmedNewName = newClassName.trim();
        
        // Check if new name already exists
        if (adminClassPasswords[trimmedNewName]) {
            alert('A class with this name already exists. Please choose a different name.');
            return;
        }
        
        try {
            const oldClassRef = window.firebaseFirestore.doc(window.firebaseDB, 'classes', oldClassName);
            const newClassRef = window.firebaseFirestore.doc(window.firebaseDB, 'classes', trimmedNewName);
            
            // Get old class data
            const oldClassDoc = await window.firebaseFirestore.getDoc(oldClassRef);
            if (!oldClassDoc.exists()) {
                alert('Class not found. Please refresh and try again.');
                return;
            }
            
            const classData = oldClassDoc.data();
            
            // Create new class with same data
            await window.firebaseFirestore.setDoc(newClassRef, classData);
            
            // Delete old class
            await window.firebaseFirestore.deleteDoc(oldClassRef);
            
            // Also need to update all learners from the old class to the new class name
            try {
                const oldLearnersRef = window.firebaseFirestore.collection(window.firebaseDB, 'classes', oldClassName, 'learners');
                const learnersSnapshot = await window.firebaseFirestore.getDocs(oldLearnersRef);
                
                // Move all learners to new class
                const moveLearnersPromises = [];
                learnersSnapshot.forEach(doc => {
                    const learnerData = doc.data();
                    const newLearnerRef = window.firebaseFirestore.doc(window.firebaseDB, 'classes', trimmedNewName, 'learners', doc.id);
                    moveLearnersPromises.push(window.firebaseFirestore.setDoc(newLearnerRef, learnerData));
                    moveLearnersPromises.push(window.firebaseFirestore.deleteDoc(window.firebaseFirestore.doc(window.firebaseDB, 'classes', oldClassName, 'learners', doc.id)));
                });
                
                await Promise.all(moveLearnersPromises);
            } catch (learnersError) {
                console.warn('Could not migrate learners:', learnersError);
                // Continue anyway - class was renamed successfully
            }
            
            alert(`Class name changed from "${oldClassName}" to "${trimmedNewName}"`);
            loadClasses(); // Reload classes
            
        } catch (error) {
            console.error('Error editing class name:', error);
            alert('Error changing class name. Please try again.');
        }
    }

    // Edit class password
    async function editClassPassword(className) {
        const newPassword = prompt('Enter new password for ' + className + ':');
        
        if (!newPassword || newPassword.trim() === '') {
            return; // User cancelled or entered empty password
        }
        
        const trimmedPassword = newPassword.trim();
        
        try {
            const classRef = window.firebaseFirestore.doc(window.firebaseDB, 'classes', className);
            
            await window.firebaseFirestore.updateDoc(classRef, {
                password: trimmedPassword
            });
            
            alert(`Password for "${className}" has been updated successfully.`);
            loadClasses(); // Reload classes to show updated password
            
        } catch (error) {
            console.error('Error editing class password:', error);
            alert('Error changing class password. Please try again.');
        }
    }

    // Learners collection functions
    async function addLearner(className) {
        const learnerNameInput = document.getElementById(`${className}-new-learner`);
        const guardianPhoneInput = document.getElementById(`${className}-guardian-phone`);
        const learnerName = learnerNameInput.value.trim();
        const guardianPhone = guardianPhoneInput.value.trim();
        
        if (!learnerName) {
            alert('Please enter a learner name');
            return;
        }
        
        try {
            // Create a unique ID for the learner
            const learnerId = Date.now().toString();
            const currentDate = new Date();
            const currentUser = window.firebaseAuth.currentUser;
            const userName = currentUser ? (currentUser.displayName || currentUser.email) : 'Unknown User';
            
            // Add learner to Firestore with default 100 points and initial adjustment record
            await window.firebaseFirestore.setDoc(
                window.firebaseFirestore.doc(window.firebaseDB, 'classes', className, 'learners', learnerId),
                {
                    name: learnerName,
                    guardianPhone: guardianPhone || null,
                    points: 100,
                    createdAt: currentDate.toISOString(),
                    adjustments: [
                        {
                            points: 100,
                            reason: 'Initial points',
                            adjustedBy: userName,
                            date: currentDate.toISOString()
                        }
                    ],
                    lastAdjustment: {
                        points: 100,
                        reason: 'Initial points',
                        adjustedBy: userName,
                        date: currentDate.toISOString()
                    }
                }
            );
            
            // Clear input fields
            learnerNameInput.value = '';
            guardianPhoneInput.value = '';
            
            // Reload learners list and scroll to the newly added learner
            loadLearners(className, learnerId);
            
            //
        } catch (error) {
            console.error('Error adding learner:', error);
            alert('Error adding learner. Please try again.');
        }
    }
    
    // Load learners for a specific class
    // Real-time listener for learners in a class
    const learnersListeners = {};
    
    async function loadLearners(className, scrollToLearnerId = null) {
        try {
            // Check authentication first
            if (!window.firebaseAuth.currentUser) {
                console.warn('No authenticated user found');
                const studentsGrid = document.getElementById(`${className}-students-grid`);
                if (studentsGrid) {
                    studentsGrid.innerHTML = `
                        <div class="col-span-full flex flex-col items-center justify-center py-12 text-red-500">
                            <i class="fas fa-user-lock text-4xl mb-3"></i>
                            <p class="text-lg font-medium">Authentication Required</p>
                            <p class="text-sm">Please log in to view students</p>
                            <button onclick="window.location.reload()" class="mt-3 px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">
                                Refresh Page
                            </button>
                        </div>
                    `;
                }
                return;
            }

            const learnersRef = window.firebaseFirestore.collection(window.firebaseDB, 'classes', className, 'learners');
            const studentsGrid = document.getElementById(`${className}-students-grid`);
            
            if (!studentsGrid) {
                console.warn(`Students grid for ${className} not found, retrying in 500ms...`);
                setTimeout(() => loadLearners(className, scrollToLearnerId), 500);
                return;
            }
            
            // Clean up existing listener for this class
            if (learnersListeners[className]) {
                learnersListeners[className]();
                delete learnersListeners[className];
            }
            
            // Show loading state
            if (studentsGrid) {
                studentsGrid.innerHTML = `
                    <div class="col-span-full flex flex-col items-center justify-center py-12">
                        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500 mb-4"></div>
                        <p class="text-gray-500">Loading students...</p>
                    </div>
                `;
            }
            
            // Set up real-time listener
            learnersListeners[className] = window.firebaseFirestore.onSnapshot(learnersRef, (snapshot) => {
                console.log(`Real-time update for ${className}: ${snapshot.size} learners`);
                
                const studentsGrid = document.getElementById(`${className}-students-grid`);
                if (!studentsGrid) {
                    console.warn(`Students grid for ${className} not found during real-time update - skipping`);
                    return;
                }
                
                // Clear existing content
                studentsGrid.innerHTML = '';
                
                if (snapshot.empty) {
                    studentsGrid.innerHTML = `
                        <div class="col-span-full flex flex-col items-center justify-center py-12 text-gray-400">
                            <i class="fas fa-user-graduate text-4xl mb-3"></i>
                            <p class="text-lg font-medium">No students added yet</p>
                            <p class="text-sm">Add your first student to get started</p>
                        </div>
                    `;
                    
                    // Update class count
                    const countElement = document.getElementById(`${className}-count`);
                    if (countElement) {
                        countElement.textContent = '0';
                    }
                    return;
                }
                
                // Sort learners by points (highest first)
                const learners = [];
                snapshot.forEach(doc => {
                    learners.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });
                
                learners.sort((a, b) => b.points - a.points);
                
                // Create student cards
                learners.forEach((learner, index) => {
                    const card = document.createElement('div');
                    card.className = `student-card bg-white rounded-xl shadow-sm hover:shadow-lg transition-all duration-300 transform hover:-translate-y-1 border border-gray-100`;
                    card.setAttribute('data-learner-id', learner.id);
                    
                    // Get initials for avatar
                    const initials = learner.name.split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);
                    
                    // Determine rank badge
                    let rankBadge = '';
                    if (index === 0) rankBadge = '<span class="absolute -top-2 -right-2 bg-yellow-400 text-yellow-900 text-xs font-bold px-2 py-1 rounded-full">ü•á</span>';
                    else if (index === 1) rankBadge = '<span class="absolute -top-2 -right-2 bg-gray-300 text-gray-700 text-xs font-bold px-2 py-1 rounded-full">ü•à</span>';
                    else if (index === 2) rankBadge = '<span class="absolute -top-2 -right-2 bg-orange-300 text-orange-900 text-xs font-bold px-2 py-1 rounded-full">ü•â</span>';
                    
                    // Progress bar calculation
                    const maxPoints = Math.max(...learners.map(l => l.points)) || 100;
                    const progressPercent = Math.min((learner.points / maxPoints) * 100, 100);
                    
                    // Last adjustment info
                    let lastAdjustmentInfo = 'No recent activity';
                    if (learner.lastAdjustment) {
                        const adjustment = learner.lastAdjustment;
                        const date = new Date(adjustment.date);
                        const formattedDate = date.toLocaleDateString();
                        const pointsText = adjustment.points > 0 ? `+${adjustment.points}` : adjustment.points;
                        lastAdjustmentInfo = `${pointsText} pts: ${adjustment.reason}`;
                    }
                    
                    card.innerHTML = `
                        <div class="p-4">
                            <div class="flex items-center justify-between mb-3">
                                <div class="relative">
                                    <div class="w-12 h-12 rounded-full bg-gradient-to-br from-blue-400 to-purple-500 flex items-center justify-center text-white font-bold text-lg">
                                        ${initials}
                                    </div>
                                    ${rankBadge}
                                </div>
                                <div class="text-right">
                                    <div class="text-2xl font-bold ${learner.points > 100 ? 'text-green-600' : 'text-gray-800'}">${learner.points}</div>
                                    <div class="text-xs text-gray-500">points</div>
                                </div>
                            </div>
                            
                            <h4 class="font-semibold text-gray-800 mb-1 truncate">${learner.name}</h4>
                            <p class="text-xs text-gray-600 mb-3 truncate">${lastAdjustmentInfo}</p>
                            
                            <div class="mb-3">
                                <div class="bg-gray-200 rounded-full h-2">
                                    <div class="bg-gradient-to-r from-green-400 to-green-600 h-2 rounded-full transition-all duration-300" style="width: ${progressPercent}%"></div>
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-3 gap-2">
                                <button onclick="adjustPoints('${className}', '${learner.id}', 5)" 
                                    class="bg-green-100 hover:bg-green-200 text-green-700 p-2 rounded-lg text-sm font-medium transition-colors duration-200">
                                    <i class="fas fa-plus"></i>
                                </button>
                                <button onclick="adjustPoints('${className}', '${learner.id}', -5)" 
                                    class="bg-red-100 hover:bg-red-200 text-red-700 p-2 rounded-lg text-sm font-medium transition-colors duration-200">
                                    <i class="fas fa-minus"></i>
                                </button>
                                <button onclick="showStudentActions('${className}', '${learner.id}', '${learner.name}')" 
                                    class="bg-gray-100 hover:bg-gray-200 text-gray-700 p-2 rounded-lg text-sm font-medium transition-colors duration-200">
                                    <i class="fas fa-ellipsis-h"></i>
                                </button>
                            </div>
                        </div>
                    `;
                    
                    studentsGrid.appendChild(card);
                });
                
                // Update class stats
                const countElement = document.getElementById(`${className}-count`);
                if (countElement) {
                    countElement.textContent = learners.length;
                }
                
                // Scroll to the specified learner if needed
                if (scrollToLearnerId) {
                    setTimeout(() => {
                        const targetCard = studentsGrid.querySelector(`[data-learner-id="${scrollToLearnerId}"]`);
                        if (targetCard) {
                            targetCard.classList.add('ring-2', 'ring-blue-500', 'ring-offset-2');
                            targetCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
                            
                            // Remove highlight after a short delay
                            setTimeout(() => {
                                targetCard.classList.remove('ring-2', 'ring-blue-500', 'ring-offset-2');
                            }, 1500);
                        }
                    }, 100);
                }
                
            }, (error) => {
                console.error(`Error in learners listener for ${className}:`, error);
                console.error('Error code:', error.code);
                console.error('Error details:', {
                    message: error.message,
                    code: error.code,
                    className: className,
                    user: window.firebaseAuth.currentUser?.email || 'No user'
                });
                
                let detailedMessage = error.message;
                if (error.code === 'permission-denied') {
                    detailedMessage = 'Access denied. Please check your permissions or contact your administrator.';
                } else if (error.code === 'unavailable') {
                    detailedMessage = 'Service temporarily unavailable. Please try again.';
                }
                
                studentsGrid.innerHTML = `
                    <div class="col-span-full flex flex-col items-center justify-center py-12 text-red-500">
                        <i class="fas fa-exclamation-triangle text-4xl mb-3"></i>
                        <p class="text-lg font-medium">Error loading students</p>
                        <p class="text-sm">${detailedMessage}</p>
                        <button onclick="loadLearners('${className}')" class="mt-3 px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">
                            Retry
                        </button>
                    </div>
                `;
            });
            
        } catch (error) {
            console.error('Error setting up learners listener:', error);
            console.error('Error details:', {
                message: error.message,
                code: error.code,
                className: className,
                user: window.firebaseAuth.currentUser?.email || 'No user'
            });
            
            const studentsGrid = document.getElementById(`${className}-students-grid`);
            if (studentsGrid) {
                let detailedMessage = error.message;
                if (error.code === 'permission-denied') {
                    detailedMessage = 'Access denied. Please ensure you are logged in and have permission to view this class.';
                } else if (error.code === 'unavailable') {
                    detailedMessage = 'Service temporarily unavailable. Please try again.';
                } else if (!window.firebaseAuth.currentUser) {
                    detailedMessage = 'Please log in to view students.';
                }
                
                studentsGrid.innerHTML = `
                    <div class="col-span-full flex flex-col items-center justify-center py-12 text-red-500">
                        <i class="fas fa-exclamation-triangle text-4xl mb-3"></i>
                        <p class="text-lg font-medium">Error loading students</p>
                        <p class="text-sm">${detailedMessage}</p>
                        ${!window.firebaseAuth.currentUser ? 
                            '<button onclick="window.location.reload()" class="mt-3 px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">Refresh Page</button>' : 
                            '<button onclick="loadLearners(\'' + className + '\')" class="mt-3 px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">Retry</button>'
                        }
                    </div>
                `;
            }
        }
    }
    
    // Adjust points for a learner
    async function adjustPoints(className, learnerId, pointsChange) {
        try {
            // Create custom modal for reason input
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
            modal.innerHTML = `
                <div class="bg-white rounded-xl shadow-2xl max-w-md w-full mx-4">
                    <div class="p-6">
                        <h3 class="text-xl font-bold text-gray-800 mb-4">${pointsChange > 0 ? 'Add' : 'Deduct'} Points</h3>
                        <p class="text-gray-600 mb-4">Please enter a reason for ${pointsChange > 0 ? 'adding' : 'deducting'} ${Math.abs(pointsChange)} points:</p>
                        <textarea id="adjust-reason-input" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" rows="3" placeholder="Enter reason..."></textarea>
                        <div class="flex gap-3 mt-4">
                            <button id="confirm-adjust" class="flex-1 bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition-colors">Confirm</button>
                            <button id="cancel-adjust" class="flex-1 bg-gray-300 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-400 transition-colors">Cancel</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Handle modal actions
            document.getElementById('confirm-adjust').addEventListener('click', async () => {
                const reason = document.getElementById('adjust-reason-input').value.trim();
                if (!reason) {
                    alert('Please enter a reason for the adjustment');
                    return;
                }
                
                try {
                    const learnerRef = window.firebaseFirestore.doc(window.firebaseDB, 'classes', className, 'learners', learnerId);
                    const learnerDoc = await window.firebaseFirestore.getDoc(learnerRef);
                    
                    const learnerData = learnerDoc.data();
                    if (!learnerData) {
                        throw new Error('Learner data not available');
                    }
                    const currentPoints = learnerData.points;
                    const newPoints = Math.max(0, currentPoints + pointsChange);
                    
                    // Get current user info
                    const currentUser = window.firebaseAuth.currentUser;
                    const userName = currentUser ? (currentUser.displayName || currentUser.email) : 'Unknown User';
                    const currentDate = new Date();
                    
                    // Create adjustment record
                    const adjustmentRecord = {
                        points: pointsChange,
                        reason: reason,
                        adjustedBy: userName,
                        date: currentDate.toISOString()
                    };
                    
                    // Get existing adjustments or create new array
                    const adjustments = learnerData.adjustments || [];
                    adjustments.push(adjustmentRecord);
                    
                    // Update the document
                    await window.firebaseFirestore.updateDoc(learnerRef, {
                        points: newPoints,
                        adjustments: adjustments,
                        lastAdjustment: adjustmentRecord
                    });
                    
                    // Remove modal and reload learners
                    modal.remove();
                    loadLearners(className, learnerId);
                } catch (error) {
                    console.error('Error adjusting points:', error);
                    alert('Error adjusting points. Please try again.');
                }
            });
            
            document.getElementById('cancel-adjust').addEventListener('click', () => {
                modal.remove();
            });
            
        } catch (error) {
            console.error('Error adjusting points:', error);
            alert('Error adjusting points. Please try again.');
        }
    }
    
    // Show student actions modal
    function showStudentActions(className, learnerId, learnerName) {
        const actionsModal = document.createElement('div');
        actionsModal.innerHTML = `
            <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                <div class="bg-white rounded-xl shadow-2xl max-w-md w-full mx-4">
                    <div class="p-6">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl font-bold text-gray-800">${learnerName}</h3>
                            <button onclick="this.closest('.fixed').remove()" class="text-gray-400 hover:text-gray-600">
                                <i class="fas fa-times text-xl"></i>
                            </button>
                        </div>
                        
                        <div class="space-y-3">
                            <button onclick="generateLearnerPDF('${className}', '${learnerId}', '${learnerName}'); this.closest('.fixed').remove()" 
                                    class="w-full text-left px-4 py-3 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors">
                                <i class="fas fa-file-pdf mr-2"></i> Generate PDF Report
                            </button>
                            
                            <button onclick="viewAdjustmentHistory('${className}', '${learnerId}', '${learnerName}'); this.closest('.fixed').remove()" 
                                    class="w-full text-left px-4 py-3 bg-purple-500 text-white rounded-lg hover:bg-purple-600 transition-colors">
                                <i class="fas fa-history mr-2"></i> View History
                            </button>
                            
                            <button onclick="customAdjustPoints('${className}', '${learnerId}'); this.closest('.fixed').remove()" 
                                    class="w-full text-left px-4 py-3 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors">
                                <i class="fas fa-plus-minus mr-2"></i> Custom Points
                            </button>
                            
                            <button onclick="editLearner('${className}', '${learnerId}', '${learnerName}'); this.closest('.fixed').remove()" 
                                    class="w-full text-left px-4 py-3 bg-yellow-500 text-white rounded-lg hover:bg-yellow-600 transition-colors">
                                <i class="fas fa-edit mr-2"></i> Edit Student
                            </button>
                            
                            <button onclick="deleteLearner('${className}', '${learnerId}', '${learnerName}'); this.closest('.fixed').remove()" 
                                    class="w-full text-left px-4 py-3 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors">
                                <i class="fas fa-trash mr-2"></i> Delete Student
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;
        document.body.appendChild(actionsModal);
    }

    // Generate PDF report for a learner
    async function generateLearnerPDF(className, learnerId, learnerName) {
        try {
            // Alert the user that we're generating a PDF
            alert('Generating PDF for ' + learnerName + '. This may take a moment.');
            
            // Fetch the learner data from Firebase
            const learnerRef = window.firebaseFirestore.doc(window.firebaseDB, 'classes', className, 'learners', learnerId);
            const learnerDoc = await window.firebaseFirestore.getDoc(learnerRef);
            
            if (!learnerDoc.exists()) {
                throw new Error('Learner data not found');
            }
            
            const learnerData = learnerDoc.data();
            learnerData.id = learnerId;
            learnerData.name = learnerName;
            
            // Process the learner data
            const adjustments = learnerData.adjustments || [];
            
            // Check if jsPDF is available
            if (typeof window.jspdf === 'undefined') {
                throw new Error('jsPDF library not loaded');
            }
            
            // Initialize jsPDF
            try {
                // Ensure jsPDF is properly destructured
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
             
                 // Add title and header information
                 doc.setFontSize(20);
                 doc.setTextColor(0, 0, 128);
                 doc.text(`Learner Report: ${learnerName}`, 14, 20);
                    
                 doc.setFontSize(12);
                 doc.setTextColor(0, 0, 0);
                 doc.text(`Class: ${className}`, 14, 30);
                 doc.text(`Current Points: ${learnerData.points}`, 14, 37);
                 doc.text(`Total Adjustments: ${adjustments.length}`, 14, 44);
                 doc.text(`Report Generated: ${new Date().toLocaleString()}`, 14, 51);
                 
                 // Add adjustment history table
                 doc.setFontSize(16);
                 doc.setTextColor(0, 0, 128);
                 doc.text('Adjustment History', 14, 65);
                    
                 if (adjustments.length === 0) {
                     doc.setFontSize(12);
                     doc.setTextColor(100, 100, 100);
                     doc.text('No adjustment history available.', 14, 75);
                 } else {
                     // Prepare table data
                     const tableColumn = ['Date', 'Points', 'Reason', 'Adjusted By'];
                     const tableRows = [];
                     
                     adjustments.forEach(adjustment => {
                         const date = new Date(adjustment.date);
                         const formattedDate = date.toLocaleDateString() + ' ' + 
                                             date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                         const pointsText = adjustment.points > 0 ? `+${adjustment.points}` : adjustment.points;
                         
                         tableRows.push([
                             formattedDate,
                             pointsText,
                             adjustment.reason,
                             adjustment.adjustedBy
                         ]);
                     });
                     
                     // Add table to PDF
                     doc.autoTable({
                         head: [tableColumn],
                         body: tableRows,
                         startY: 70,
                         styles: { fontSize: 10 },
                         columnStyles: {
                             0: { cellWidth: 40 },
                             1: { cellWidth: 20, halign: 'center' },
                             2: { cellWidth: 70 },
                             3: { cellWidth: 40 }
                         },
                         headStyles: {
                             fillColor: [0, 51, 102],
                             textColor: 255
                         },
                         alternateRowStyles: {
                             fillColor: [240, 240, 240]
                         },
                         didDrawCell: (data) => {
                             // Color positive points green and negative points red
                             if (data.column.index === 1 && data.section === 'body') {
                                 const text = data.cell.text[0];
                                 if (text.startsWith('+')) {
                                     doc.setTextColor(0, 128, 0); // Green for positive
                                 } else if (text.startsWith('-')) {
                                     doc.setTextColor(220, 0, 0); // Red for negative
                                 }
                             }
                         }
                     });
                     
                     // Reset text color after table
                     doc.setTextColor(0, 0, 0);
                 }
                 
                 // Add summary section
                 const finalY = doc.lastAutoTable ? doc.lastAutoTable.finalY + 15 : 75;
                 doc.setFontSize(16);
                 doc.setTextColor(0, 0, 128);
                 doc.text('Summary', 14, finalY);
                 
                 // Calculate statistics
                 let positiveAdjustments = 0;
                 let negativeAdjustments = 0;
                 let totalPositivePoints = 0;
                 let totalNegativePoints = 0;
                 
                 adjustments.forEach(adj => {
                     if (adj.points > 0) {
                         positiveAdjustments++;
                         totalPositivePoints += adj.points;
                     } else if (adj.points < 0) {
                         negativeAdjustments++;
                         totalNegativePoints += Math.abs(adj.points);
                     }
                 });
                 
                 doc.setFontSize(12);
                 doc.setTextColor(0, 0, 0);
                 doc.text(`Positive Adjustments: ${positiveAdjustments} (Total: +${totalPositivePoints} points)`, 14, finalY + 10);
                 doc.text(`Negative Adjustments: ${negativeAdjustments} (Total: -${totalNegativePoints} points)`, 14, finalY + 20);
                 
                 if (adjustments.length > 0) {
                     // Most common reasons
                     const reasonCounts = {};
                     adjustments.forEach(adj => {
                         reasonCounts[adj.reason] = (reasonCounts[adj.reason] || 0) + 1;
                     });
                     
                     const sortedReasons = Object.entries(reasonCounts)
                         .sort((a, b) => b[1] - a[1])
                         .slice(0, 3);
                     
                     if (sortedReasons.length > 0) {
                         doc.setFontSize(14);
                         doc.text('Most Common Reasons:', 14, finalY + 35);
                         
                         doc.setFontSize(12);
                         sortedReasons.forEach((reason, index) => {
                             doc.text(`${index + 1}. ${reason[0]} (${reason[1]} times)`, 20, finalY + 45 + (index * 8));
                         });
                     }
                 }
                 
                 // Add footer
                 const pageCount = doc.internal.getNumberOfPages();
                 for (let i = 1; i <= pageCount; i++) {
                     doc.setPage(i);
                     doc.setFontSize(10);
                     doc.setTextColor(100, 100, 100);
                     doc.text(
                         `Behaviour Tracker - Page ${i} of ${pageCount}`,
                         doc.internal.pageSize.getWidth() / 2,
                         doc.internal.pageSize.getHeight() - 10,
                         { align: 'center' }
                     );
                 }
                 
                 // Save the PDF
                 doc.save(`${className}_${learnerName}_Report_${new Date().toISOString().split('T')[0]}.pdf`);
             } catch (jspdfError) {
                 console.error('Error creating PDF:', jspdfError);
                 alert('Error creating PDF: ' + jspdfError.message);
             }
         } catch (error) {
             console.error('Error generating PDF report:', error);
             alert('Error generating PDF report. Please try again.');
         }
     }
    
    // View full adjustment history for a learner
    async function viewAdjustmentHistory(className, learnerId, learnerName) {
        try {
            const learnerRef = window.firebaseFirestore.doc(window.firebaseDB, 'classes', className, 'learners', learnerId);
            const learnerDoc = await window.firebaseFirestore.getDoc(learnerRef);
            
            if (learnerDoc.exists()) {
                const learnerData = learnerDoc.data();
                const adjustments = learnerData.adjustments || [];
                
                // Create modal content
                let modalContent = `
                    <div class="p-4">
                        <h3 class="text-lg font-semibold mb-4">Adjustment History for ${learnerName}</h3>
                `;
                
                if (adjustments.length === 0) {
                    modalContent += `<p class="text-gray-700">No adjustment history available.</p>`;
                } else {
                    // Sort adjustments by date (newest first)
                    adjustments.sort((a, b) => new Date(b.date) - new Date(a.date));
                    
                    modalContent += `
                        <div class="max-h-96 overflow-y-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-100">
                                    <tr>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Date</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Points</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Reason</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Adjusted By</th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white divide-y divide-gray-200">
                    `;
                    
                    adjustments.forEach(adjustment => {
                        const date = new Date(adjustment.date);
                        const formattedDate = date.toLocaleDateString();
                        const formattedTime = date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                        const pointsText = adjustment.points > 0 ? `+${adjustment.points}` : adjustment.points;
                        const pointsClass = adjustment.points > 0 ? 'text-green-600' : 'text-red-600';
                        
                        modalContent += `
                            <tr>
                                <td class="px-4 py-2 text-sm">${formattedDate} ${formattedTime}</td>
                                <td class="px-4 py-2 text-sm font-medium ${pointsClass}">${pointsText}</td>
                                <td class="px-4 py-2 text-sm">${adjustment.reason}</td>
                                <td class="px-4 py-2 text-sm">${adjustment.adjustedBy}</td>
                            </tr>
                        `;
                    });
                    
                    modalContent += `
                                </tbody>
                            </table>
                        </div>
                    `;
                }
                
                modalContent += `
                        <div class="mt-4 flex justify-end">
                            <button id="closeHistoryModal" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg text-sm">
                                Close
                            </button>
                        </div>
                    </div>
                `;
                
                // Create modal container
                const modalContainer = document.createElement('div');
                modalContainer.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
                modalContainer.id = 'adjustmentHistoryModal';
                modalContainer.innerHTML = `
                    <div class="bg-white rounded-xl shadow-lg max-w-2xl w-full mx-4">
                        ${modalContent}
                    </div>
                `;
                
                // Add modal to body
                document.body.appendChild(modalContainer);
                
                // Add event listener to close button
                document.getElementById('closeHistoryModal').addEventListener('click', () => {
                    document.body.removeChild(modalContainer);
                });
                
                // Close modal when clicking outside
                modalContainer.addEventListener('click', (e) => {
                    if (e.target === modalContainer) {
                        document.body.removeChild(modalContainer);
                    }
                });
            }
        } catch (error) {
            console.error('Error viewing adjustment history:', error);
            alert('Error viewing adjustment history. Please try again.');
        }
    }
    
    // Alias for viewLearnerHistory for backward compatibility
    function viewLearnerHistory(className, learnerId, learnerName) {
        return viewAdjustmentHistory(className, learnerId, learnerName);
    }
    
    // Custom point adjustment with any value
    async function customAdjustPoints(className, learnerId) {
        try {
            const learnerRef = window.firebaseFirestore.doc(window.firebaseDB, 'classes', className, 'learners', learnerId);
            const learnerDoc = await window.firebaseFirestore.getDoc(learnerRef);
            
            if (learnerDoc.exists()) {
                const learnerData = learnerDoc.data();
                const currentPoints = learnerData.points;
                
                // Create custom points modal
                const modal = document.createElement('div');
                modal.id = 'custom-points-modal';
                modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
                modal.innerHTML = `
                    <div class="bg-white rounded-xl shadow-2xl max-w-md w-full mx-4">
                        <div class="p-6">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-xl font-bold text-gray-800">Custom Points Adjustment</h3>
                                <button onclick="document.getElementById('custom-points-modal').remove()" class="text-gray-400 hover:text-gray-600">
                                    <i class="fas fa-times text-xl"></i>
                                </button>
                            </div>
                                
                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">
                                            Current Points: <span class="font-bold text-blue-600">${currentPoints}</span>
                                        </label>
                                        <input type="number" 
                                               id="custom-points-input" 
                                               placeholder="Enter points (positive or negative)" 
                                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                               required>
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">
                                            Reason for adjustment
                                        </label>
                                        <input type="text" 
                                               id="custom-reason-input" 
                                               placeholder="Enter reason (e.g., excellent work, late submission)" 
                                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                               required>
                                    </div>
                                    
                                    <div class="flex gap-3 pt-4">
                                        <button onclick="document.getElementById('custom-points-modal').remove()" 
                                                class="flex-1 px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-colors">
                                            Cancel
                                        </button>
                                        <button onclick="submitCustomPoints('${className}', '${learnerId}', ${currentPoints})" 
                                                class="flex-1 px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors">
                                            Apply Points
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
                
                // Focus on the points input
                document.getElementById('custom-points-input').focus();
            }
        } catch (error) {
            console.error('Error adjusting points:', error);
            alert('Error adjusting points. Please try again.');
        }
    }
    
    // Submit custom points adjustment
    async function submitCustomPoints(className, learnerId, currentPoints) {
        try {
            const pointsInput = document.getElementById('custom-points-input');
            const reasonInput = document.getElementById('custom-reason-input');
            
            const pointsChange = parseInt(pointsInput.value);
            const reason = reasonInput.value.trim();
            
            if (isNaN(pointsChange)) {
                alert('Please enter a valid number');
                return;
            }
            
            if (!reason) {
                alert('Please enter a reason for the adjustment');
                return;
            }
            
            const newPoints = Math.max(0, currentPoints + pointsChange);
            
            // Get current user info
            const currentUser = window.firebaseAuth.currentUser;
            const userName = currentUser ? (currentUser.displayName || currentUser.email) : 'Unknown User';
            const currentDate = new Date();
            
            // Create adjustment record
            const adjustmentRecord = {
                points: pointsChange,
                reason: reason,
                adjustedBy: userName,
                date: currentDate.toISOString()
            };
            
            // Get learner reference
            const learnerRef = window.firebaseFirestore.doc(window.firebaseDB, 'classes', className, 'learners', learnerId);
            const learnerDoc = await window.firebaseFirestore.getDoc(learnerRef);
            
            if (learnerDoc.exists()) {
                const learnerData = learnerDoc.data();
                const adjustments = learnerData.adjustments || [];
                adjustments.push(adjustmentRecord);
                
                // Update the document
                await window.firebaseFirestore.updateDoc(learnerRef, {
                    points: newPoints,
                    adjustments: adjustments,
                    lastAdjustment: adjustmentRecord
                });
                
                // Close modal and reload learners
                const modal = document.getElementById('custom-points-modal');
                if (modal) {
                    modal.remove();
                }
                loadLearners(className, learnerId);
            }
        } catch (error) {
            console.error('Error submitting custom points:', error);
            alert('Error submitting custom points. Please try again.');
        }
    }
    
    // Delete a learner
    async function deleteLearner(className, learnerId) {
        if (!confirm('Are you sure you want to remove this learner?')) return;
        
        try {
            await window.firebaseFirestore.deleteDoc(
                window.firebaseFirestore.doc(window.firebaseDB, 'classes', className, 'learners', learnerId)
            );
            
            // Reload learners list
            loadLearners(className);
            
            //
        } catch (error) {
            console.error('Error deleting learner:', error);
            alert('Error deleting learner. Please try again.');
        }
    }
    

    
    // Function to save best learner data to Firestore
    async function saveBestLearner(className) {
        try {
            const nameInput = document.getElementById(`${className}-best-learner-name`);
            const pointsInput = document.getElementById(`${className}-best-learner-points`);
            
            if (!nameInput || !pointsInput) {
                console.error('Could not find best learner input fields');
                return;
            }
            
            const name = nameInput.value.trim();
            const points = parseInt(pointsInput.value, 10);
            
            if (!name) {
                alert('Please enter a student name');
                return;
            }
            
            if (isNaN(points) || points <= 0) {
                alert('Please enter a valid number of points');
                return;
            }
            
            // Generate a unique ID for this top learner entry
            const timestamp = new Date().getTime();
            const learnerId = `${className}_${timestamp}`;
            
            // Create a document reference for this top learner
            const bestLearnerRef = window.firebaseFirestore.doc(window.firebaseDB, 'bestLearners', learnerId);
            
            // Save the data to Firestore
            await window.firebaseFirestore.setDoc(bestLearnerRef, {
                name: name,
                points: points,
                className: className,
                updatedAt: new Date().toISOString()
            });
            
            // Clear the input fields after saving
            nameInput.value = '';
            pointsInput.value = '';
            
            alert('Top learner saved successfully!');
            // No need to call loadTopLearners() here as we have real-time updates
            
        } catch (error) {
            console.error('Error saving top learner:', error);
            alert('Failed to save top learner. Please try again.');
        }
    }
    
    // Function to load top learners data for a specific class from Firestore
    async function loadBestLearner(className) {
        try {
            // We're no longer loading a single best learner since we now support multiple
            // This function now returns empty values as we'll use the form to add new top learners
            return { bestLearnerName: '', bestLearnerPoints: '' };
        } catch (error) {
            console.error('Error loading top learners:', error);
            return { bestLearnerName: '', bestLearnerPoints: '' };
        }
    }
    
    // Update tab content with dynamic classes
    function updateTabContentWithClasses() {
        // Remove old class entries from tabContent
        Object.keys(tabContent).forEach(key => {
            if (key !== 'Dashboard' && key !== 'Admin' && key !== 'Logout') {
                delete tabContent[key];
            }
        });

        // Add new classes from Firestore
        Object.keys(adminClassPasswords).forEach(className => {
            tabContent[className] = createClassContent(className);
        });

        // Update sidebar navigation
        updateSidebarNavigation();
        
        // Load learners for each class
        Object.keys(adminClassPasswords).forEach(className => {
            setTimeout(() => loadLearners(className), 500);
        });
        

    }

    // Create content for a specific class
    function createClassContent(className) {
        const classData = adminClassPasswords[className];
        // We no longer need to convert Google Sheets URL as we're using our own table system
        
        // Load best learner data if available
        let bestLearnerName = '';
        let bestLearnerPoints = '';
        
        // Load best learner data for this class
        loadBestLearner(className).then(data => {
            setTimeout(() => {
                const nameInput = document.getElementById(`${className}-best-learner-name`);
                const pointsInput = document.getElementById(`${className}-best-learner-points`);
                
                if (nameInput && data.bestLearnerName) {
                    nameInput.value = data.bestLearnerName;
                }
                
                if (pointsInput && data.bestLearnerPoints) {
                    pointsInput.value = data.bestLearnerPoints;
                }
            }, 500); // Small delay to ensure DOM is ready
        });

        return `
            <div class="bg-white rounded-xl shadow-sm p-4 md:p-6">
                <div class="flex justify-between items-center mb-4 md:mb-6">
                    <h1 class="text-xl md:text-2xl font-bold text-gray-800">${className}</h1>
                    <button onclick="exportToExcel('${className}')" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg text-sm flex items-center">
                        <i class="fas fa-file-excel mr-2"></i>Export Class Data
                    </button>
                </div>
                <div class="class-content-blur" id="${className}-content">
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 md:gap-6">
                        <div class="lg:col-span-2">
                            <div class="bg-white rounded-xl shadow-sm p-4 md:p-6 mb-6">
                                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6">
                                    <h3 class="text-xl font-bold text-gray-800 mb-4 sm:mb-0">Student Behavior Tracker</h3>
                                    <div class="flex flex-col sm:flex-row gap-3 w-full sm:w-auto">
                                        <input type="text" id="${className}-new-learner" placeholder="Student name" class="flex-grow px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all">
                                        <input type="tel" id="${className}-guardian-phone" placeholder="Guardian phone" class="flex-grow px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all">
                                        <button onclick="addLearner('${className}')" class="bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white px-6 py-2 rounded-lg font-medium flex items-center justify-center shadow-sm hover:shadow-md transition-all duration-200">
                                            <i class="fas fa-plus mr-2"></i>Add Student
                                        </button>
                                    </div>
                                </div>
                                
                                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4" id="${className}-students-grid">
                                    <!-- Student cards will be loaded here -->
                                    <div class="col-span-full flex flex-col items-center justify-center py-12 text-gray-400">
                                        <i class="fas fa-user-graduate text-4xl mb-3"></i>
                                        <p class="text-lg font-medium">No students added yet</p>
                                        <p class="text-sm">Add your first student to get started</p>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="bg-gray-50 rounded-xl p-3 md:p-4">
                                <div id="${className}-students" class="space-y-2 md:space-y-3 max-h-60 md:max-h-80 overflow-y-auto pr-2">
                                    <!-- Student list will be populated here -->
                                </div>
                            </div>
                        </div>
                        
                        <div>
                            <div class="bg-gray-50 rounded-xl p-3 md:p-4 mb-3 md:mb-4">
                                <h3 class="text-base md:text-lg font-semibold text-gray-700 mb-3 md:mb-4">Class Stats</h3>
                                <div class="space-y-2">
                                    <div class="flex justify-between">
                                        <span class="text-xs md:text-sm text-gray-700">Total Students:</span>
                                        <span class="font-semibold text-sm md:text-base" id="${className}-count">0</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-xs md:text-sm text-gray-700">Average Points:</span>
                                        <span class="font-semibold text-sm md:text-base" id="${className}-avg">0</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="bg-gray-50 rounded-xl p-3 md:p-4 mb-3 md:mb-4">
                                <h3 class="text-base md:text-lg font-semibold text-gray-700 mb-3 md:mb-4">Add Top Learner</h3>
                                <div class="space-y-2 md:space-y-3">
                                    <div>
                                        <label class="block text-xs md:text-sm font-medium text-gray-700 mb-1">Student Name</label>
                                        <input type="text" id="${className}-best-learner-name" class="w-full px-2 md:px-3 py-1.5 md:py-2 border border-gray-300 rounded-lg text-sm md:text-base" 
                                            placeholder="Enter student name" value="${bestLearnerName}">
                                    </div>
                                    <div>
                                        <label class="block text-xs md:text-sm font-medium text-gray-700 mb-1">Points</label>
                                        <input type="number" id="${className}-best-learner-points" class="w-full px-2 md:px-3 py-1.5 md:py-2 border border-gray-300 rounded-lg text-sm md:text-base" 
                                            placeholder="Enter points" value="${bestLearnerPoints}">
                                    </div>
                                    <button onclick="saveBestLearner('${className}')" class="w-full bg-green-500 text-white py-1.5 md:py-2 rounded-lg hover:bg-green-600 mt-2 text-sm md:text-base">
                                        <i class="fas fa-plus mr-2"></i>Add Top Learner
                                    </button>
                                    <p class="text-xs text-gray-600 mt-2">You can add multiple top learners for this class. They will be ranked by points on the dashboard.</p>
                                </div>
                            </div>
                            
                            <div class="bg-gray-50 rounded-xl p-3 md:p-4">
                                <canvas id="${className}-chart" width="300" height="200"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }

    // Update sidebar navigation with dynamic classes
    function updateSidebarNavigation() {
        const classesDropdownMenu = document.getElementById('classesDropdownMenu');
        if (!classesDropdownMenu) return;

        classesDropdownMenu.innerHTML = '';
        
        Object.keys(adminClassPasswords).forEach(className => {
            const classButton = document.createElement('button');
            classButton.className = 'class-btn flex items-center w-full px-4 py-2 text-gray-700 hover:bg-gray-100 rounded-lg';
            classButton.setAttribute('data-content', className);
            classButton.innerHTML = `<i class="fas fa-book text-lg mr-2"></i><span class="text-sm font-medium">${className}</span>`;
            classButton.title = className; // Add tooltip for accessibility
            classesDropdownMenu.appendChild(classButton);
        });

        setupClassButtons();
    }

    // Setup event listeners for class buttons
    function setupClassButtons() {
        document.querySelectorAll('[data-content]').forEach(button => {
            button.addEventListener('click', (e) => {
                const content = e.currentTarget.getAttribute('data-content');
                
                if (content === 'Logout') {
                    window.firebaseAuth.signOut(window.firebaseAuth).then(() => {
                        window.location.href = 'index.html';
                    });
                } else if (content === 'Classes') {
                    document.getElementById('classesDropdownMenu').classList.toggle('hidden');
                } else {
                    loadContent(content);
                }
            });
        });
    }

    // Show password modal
    function showPasswordModal(className) {
        currentClass = className;
        document.getElementById('passwordModal').classList.remove('hidden');
        document.getElementById('passwordModal').classList.add('flex');
        document.getElementById('classPasswordInput').value = '';
        document.getElementById('passwordError').classList.add('hidden');
        document.getElementById('classPasswordInput').focus();
    }

    // Hide password modal
    function hidePasswordModal() {
        document.getElementById('passwordModal').classList.add('hidden');
        document.getElementById('passwordModal').classList.remove('flex');
    }

    // Toggle class password visibility
    function toggleClassPasswordVisibility() {
        const passwordInput = document.getElementById('classPasswordInput');
        const eyeIcon = document.getElementById('classPasswordToggle');
        
        if (passwordInput.type === 'password') {
            passwordInput.type = 'text';
            eyeIcon.classList.remove('fa-eye');
            eyeIcon.classList.add('fa-eye-slash');
        } else {
            passwordInput.type = 'password';
            eyeIcon.classList.remove('fa-eye-slash');
            eyeIcon.classList.add('fa-eye');
        }
    }

    // Check password
    function checkPassword() {
        const enteredPassword = document.getElementById('classPasswordInput').value;
        const correctPassword = adminClassPasswords[currentClass]?.password;
        
        if (enteredPassword === correctPassword) {
            hidePasswordModal();
            const contentDiv = document.getElementById(`${currentClass}-content`);
            if (contentDiv) {
                contentDiv.classList.remove('class-content-blur');
                contentDiv.classList.add('class-content-unblur');
                
                // Load learners for this class after password verification
                loadLearners(currentClass);
            }
        } else {
            document.getElementById('passwordError').classList.remove('hidden');
        }
    }

    // Load content
    function loadContent(content) {
        const contentDiv = document.getElementById('content');
        
        if (tabContent[content]) {
            contentDiv.innerHTML = tabContent[content];
            
            if (content !== 'Dashboard' && content !== 'Admin' && content !== 'Logout') {
                showPasswordModal(content);
            } else if (content === 'Dashboard') {
                updateDashboardStats();
            } else if (content === 'Admin') {
                // Ensure classes are loaded when admin panel is opened
                // Use requestAnimationFrame to ensure DOM is ready
                requestAnimationFrame(() => {
                    setTimeout(() => {
                        console.log('Admin panel loaded, setting up...');
                        loadClasses();
                        
                        // Attach event listener for Add Class button
                        const addClassBtn = document.getElementById('addClassBtn');
                        if (addClassBtn) {
                            addClassBtn.addEventListener('click', addNewClass);
                            console.log('Add Class button event listener attached');
                        } else {
                            console.error('Add Class button not found');
                        }
                        
                        // Load admin list when admin panel is opened
                        loadAdminList();
                        console.log('Admin list loaded');
                        
                        // Load user data for admin panel
                        if (isAdmin) {
                            // Ensure admin elements exist before loading data
                            const waitForElements = () => {
                                const adminList = document.getElementById('adminList');
                                const classesList = document.getElementById('classesList');
                                
                                if (adminList && classesList) {
                                    loadUsers();
                                    loadUserClassAllocations();
                                } else {
                                    requestAnimationFrame(waitForElements);
                                }
                            };
                            requestAnimationFrame(waitForElements);
                        }
                    }, 50); // Reduced delay for faster loading
                });
            }
        }
    }

    // Update dashboard stats and welcome message
    async function updateDashboardStats() {
        const classes = Object.keys(adminClassPasswords);
        document.getElementById('totalClasses').textContent = classes.length;
        document.getElementById('totalStudents').textContent = '0';
        document.getElementById('totalPoints').textContent = '0';
        
        // Update available classes list in instructions
        const classesListElement = document.getElementById('availableClasses');
        if (classesListElement) {
            classesListElement.textContent = classes.length > 0 ? classes.join(', ') : 'No classes configured';
        }
        
        // Update user information
        const user = window.firebaseAuth.currentUser;
        if (user) {
            // Update welcome message with user's first name
            try {
                const userDoc = await window.firebaseFirestore.getDoc(
                    window.firebaseFirestore.doc(window.firebaseDB, 'users', user.uid)
                );
                if (userDoc.exists()) {
                    const userData = userDoc.data();
                    const welcomeElement = document.querySelector('#content h1');
                    if (welcomeElement) {
                        welcomeElement.textContent = `Welcome back, ${userData.firstName}!`;
                    }
                }
            } catch (error) {
                console.error('Error fetching user data:', error);
            }
        }
        
        // Load top learners for the dashboard
        loadTopLearners();
    }
    
    // Function to load and display top learners with real-time updates
    function loadTopLearners() {
        console.log('loadTopLearners function called');
        
        // Ensure Firestore is initialized
        if (!window.firebaseDB || !window.firebaseFirestore) {
            console.error('Firestore not initialized');
            const topLearnersContainer = document.getElementById('topLearnersContainer');
            if (topLearnersContainer) {
                topLearnersContainer.innerHTML = `
                    <div class="col-span-full text-center py-8">
                        <i class="fas fa-exclamation-triangle text-red-500 text-4xl mb-4"></i>
                        <p class="text-red-500 font-medium">Database Connection Error</p>
                        <p class="text-sm text-gray-500 mt-2">Firestore is not properly initialized</p>
                    </div>
                `;
            }
            return;
        }
        
        try {
            const bestLearnersRef = window.firebaseFirestore.collection(window.firebaseDB, 'bestLearners');
            
            console.log('Setting up top learners listener...');
            console.log('bestLearners collection reference:', bestLearnersRef);
            
            // Show loading state
            const topLearnersContainer = document.getElementById('topLearnersContainer');
            if (topLearnersContainer) {
                topLearnersContainer.innerHTML = `
                    <div class="col-span-full text-center py-8">
                        <i class="fas fa-spinner fa-spin text-blue-500 text-2xl mb-4"></i>
                        <p class="text-gray-700">Loading top learners...</p>
                        <p class="text-sm text-gray-600 mt-2">Connecting to database...</p>
                    </div>
                `;
            }
            
            // Use onSnapshot for real-time updates with offline handling
            window.firebaseFirestore.onSnapshot(bestLearnersRef, (snapshot) => {
                console.log('Snapshot received from bestLearners:', snapshot);
                console.log('Snapshot empty:', snapshot.empty);
                console.log('Snapshot size:', snapshot.size);
                console.log('Snapshot docs:', snapshot.docs.map(doc => ({id: doc.id, data: doc.data()})));
                const topLearnersContainer = document.getElementById('topLearnersContainer');
                
                if (!topLearnersContainer) {
                    console.error('Top learners container not found');
                    return;
                }
                
                // Clear the container
                topLearnersContainer.innerHTML = '';
                
                if (snapshot.empty) {
                    topLearnersContainer.innerHTML = `
                        <div class="col-span-full text-center py-8">
                            <i class="fas fa-trophy text-gray-300 text-4xl mb-4"></i>
                            <p class="text-gray-700 italic">No top learners added yet</p>
                            <p class="text-sm text-gray-600 mt-2">Add learners with 100+ points from each class to see them here</p>
                            <p class="text-sm text-gray-600 mt-1">Tip: Go to a class, find a learner with 100+ points, and click "Add to Top Learners"</p>
                        </div>
                    `;
                    return;
                }
                
                // Convert snapshot to array and sort by points (highest first)
                const learners = [];
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    learners.push({
                        id: doc.id,
                        className: data.className || doc.id.split('_')[0], // Fallback for older data format
                        name: data.name,
                        points: data.points,
                        updatedAt: data.updatedAt
                    });
                });
                
                // Sort by points (highest first)
                learners.sort((a, b) => b.points - a.points);
                
                // Group learners by class
                const learnersByClass = {};
                learners.forEach(learner => {
                    if (!learnersByClass[learner.className]) {
                        learnersByClass[learner.className] = [];
                    }
                    learnersByClass[learner.className].push(learner);
                });
                
                // Create a section for each class
                Object.keys(learnersByClass).forEach(className => {
                    // Create class header
                    const classHeader = document.createElement('div');
                    classHeader.className = 'col-span-full mt-4 mb-2';
                    classHeader.innerHTML = `
                        <h3 class="text-lg font-semibold text-gray-700">${className} Top Learners</h3>
                    `;
                    topLearnersContainer.appendChild(classHeader);
                    
                    // Sort learners within this class by points
                    const classLearners = learnersByClass[className];
                    
                    // Create cards for each top learner in this class
                    classLearners.forEach((learner, index) => {
                        const position = index + 1;
                        const learnerCard = document.createElement('div');
                        learnerCard.className = 'bg-gray-50 rounded-xl p-4';
                        
                        // Determine medal color based on position
                        let medalColor = 'text-gray-500 bg-gray-100';
                        let medalIcon = 'fa-medal';
                        
                        if (position === 1) {
                            medalColor = 'text-yellow-500 bg-yellow-100'; // Gold
                        } else if (position === 2) {
                            medalColor = 'text-gray-400 bg-gray-100'; // Silver
                        } else if (position === 3) {
                            medalColor = 'text-amber-600 bg-amber-100'; // Bronze
                        }
                        
                        learnerCard.innerHTML = `
                            <div class="flex items-start">
                                <div class="p-2 rounded-full ${medalColor} mr-3">
                                    <i class="fas ${medalIcon}"></i>
                                </div>
                                <div>
                                    <div class="flex items-center">
                                        <h3 class="font-semibold text-gray-800">${learner.name}</h3>
                                        <span class="ml-2 px-2 py-1 text-xs font-semibold rounded-full bg-blue-100 text-blue-800">Rank #${position}</span>
                                    </div>
                                    <div class="flex items-center mt-1">
                                        <span class="text-lg font-bold text-yellow-500">${learner.points}</span>
                                        <span class="text-xs text-gray-600 ml-1">points</span>
                                    </div>
                                </div>
                            </div>
                        `;
                        
                        topLearnersContainer.appendChild(learnerCard);
                    });
                });
            }, (error) => {
                console.error('Error in top learners listener:', error);
                const topLearnersContainer = document.getElementById('topLearnersContainer');
                if (topLearnersContainer) {
                    topLearnersContainer.innerHTML = `
                        <div class="col-span-full text-center py-8">
                            <i class="fas fa-exclamation-triangle text-red-500 text-4xl mb-4"></i>
                            <p class="text-red-500 font-medium">Error loading top learners</p>
                            <p class="text-sm text-gray-500 mt-2">${error.message}</p>
                            <p class="text-sm text-gray-500 mt-1">Error: ${error.code || 'Permission denied'}</p>
                            <p class="text-sm text-gray-500 mt-1">Check Firestore security rules for bestLearners collection</p>
                        </div>
                    `;
                }
            });
            
        } catch (error) {
                console.error('Error setting up top learners listener:', error);
                const topLearnersContainer = document.getElementById('topLearnersContainer');
                if (topLearnersContainer) {
                    const isOffline = !navigator.onLine;
                    const errorMessage = isOffline ? 
                        'You appear to be offline. Data will sync when connection is restored.' : 
                        error.message;
                    topLearnersContainer.innerHTML = `
                        <div class="col-span-full text-center py-8">
                            <i class="fas fa-exclamation-triangle text-red-500 text-4xl mb-4"></i>
                            <p class="text-red-500 font-medium">${isOffline ? 'Offline Mode' : 'Error loading top learners'}</p>
                            <p class="text-sm text-gray-500 mt-2">${errorMessage}</p>
                            ${isOffline ? '<p class="text-sm text-gray-500 mt-1">Connection will automatically restore when network is available</p>' : ''}
                            <p class="text-sm text-gray-500 mt-1">Error: ${error.code || 'Network error'}</p>
                            <button onclick="loadTopLearners()" class="mt-4 px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">
                                <i class="fas fa-sync mr-2"></i>Retry
                            </button>
                        </div>
                    `;
                }
            }
    }

    // Function to check if the bestLearners collection exists and has data
    async function checkBestLearnersCollection() {
        try {
            const bestLearnersRef = window.firebaseFirestore.collection(window.firebaseDB, 'bestLearners');
            const snapshot = await window.firebaseFirestore.getDocs(bestLearnersRef);
            console.log('Best learners collection check:', {
                exists: true,
                size: snapshot.size,
                empty: snapshot.empty,
                docs: snapshot.docs.map(doc => ({id: doc.id, data: doc.data()}))
            });
            return snapshot;
        } catch (error) {
            console.error('Error checking bestLearners collection:', error);
            return null;
        }
    }

    // Toggle password visibility
    function togglePasswordVisibility(button) {
        const passwordSpan = button.previousElementSibling;
        const password = passwordSpan.getAttribute('data-password');
        const icon = button.querySelector('i');
        
        if (passwordSpan.textContent.includes('*')) {
            passwordSpan.textContent = password;
            icon.className = 'fas fa-eye-slash';
        } else {
            passwordSpan.textContent = '*'.repeat(password.length);
            icon.className = 'fas fa-eye';
        }
    }
    
    // Confirm before clearing all top learners
    function confirmClearAllTopLearners() {
        if (confirm('Are you sure you want to reset ALL top learners data? This action cannot be undone.')) {
            if (confirm('FINAL WARNING: This will permanently delete all top learners records. Continue?')) {
                clearAllTopLearners();
            }
        }
    }
    
    // Clear all top learners data
    async function clearAllTopLearners() {
        try {
            // Show loading state
            const resetBtn = document.querySelector('button[onclick="confirmClearAllTopLearners()"]');
            const originalText = resetBtn.innerHTML;
            resetBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Resetting...';
            resetBtn.disabled = true;
            
            // Get all top learners documents
            const bestLearnersRef = window.firebaseFirestore.collection(window.firebaseDB, 'bestLearners');
            const snapshot = await window.firebaseFirestore.getDocs(bestLearnersRef);
            
            // Delete each document
            const deletePromises = [];
            snapshot.forEach((doc) => {
                deletePromises.push(
                    window.firebaseFirestore.deleteDoc(
                        window.firebaseFirestore.doc(window.firebaseDB, 'bestLearners', doc.id)
                    )
                );
            });
            
            // Wait for all deletions to complete
            await Promise.all(deletePromises);
            
            // Restore button state
            resetBtn.innerHTML = originalText;
            resetBtn.disabled = false;
            
            alert('All top learners data has been successfully reset!');
            
        } catch (error) {
            console.error('Error clearing top learners:', error);
            alert('Error clearing top learners data. Please try again.');
            
            // Restore button state on error
            const resetBtn = document.querySelector('button[onclick="confirmClearAllTopLearners()"]');
            resetBtn.innerHTML = '<i class="fas fa-trash mr-2"></i>Reset All Top Learners';
            resetBtn.disabled = false;
        }
    }

    // Update welcome message with user's first name
    async function updateWelcomeMessage() {
        const user = window.firebaseAuth.currentUser;
        if (user) {
            try {
                const userDoc = await window.firebaseFirestore.getDoc(
                    window.firebaseFirestore.doc(window.firebaseDB, 'users', user.uid)
                );
                if (userDoc.exists()) {
                    const userData = userDoc.data();
                    const welcomeElement = document.querySelector('#content h1');
                    if (welcomeElement) {
                        welcomeElement.textContent = `Welcome back, ${userData.firstName}!`;
                    }
                }
            } catch (error) {
                console.error('Error fetching user data:', error);
            }
        }
    }

    // Admin Management Functions
    async function grantAdminPrivileges() {
        const emailInput = document.getElementById('adminEmailInput');
        const email = emailInput.value.trim();
        
        if (!email) {
            alert('Please enter an email address');
            return;
        }
        
        if (!confirm(`Are you sure you want to grant admin privileges to ${email}?`)) {
            return;
        }
        
        try {
            // Find user by email
            const usersRef = window.firebaseFirestore.collection(window.firebaseDB, 'users');
            const usersSnapshot = await window.firebaseFirestore.getDocs(usersRef);
            let targetUser = null;
            
            usersSnapshot.forEach((doc) => {
                const userData = doc.data();
                if (userData.email === email) {
                    targetUser = { uid: doc.id, ...userData };
                }
            });
            
            if (!targetUser) {
                alert('User not found with this email address');
                return;
            }
            
            // Grant admin privileges
            await window.firebaseFirestore.setDoc(
                window.firebaseFirestore.doc(window.firebaseDB, 'admins', targetUser.uid),
                {
                    email: targetUser.email,
                    firstName: targetUser.firstName,
                    lastName: targetUser.lastName,
                    grantedBy: window.firebaseAuth.currentUser.uid,
                    grantedAt: new Date().toISOString()
                }
            );
            
            alert(`Admin privileges granted to ${targetUser.firstName} ${targetUser.lastName}`);
            emailInput.value = '';
            loadAdminList();
            
        } catch (error) {
            console.error('Error granting admin privileges:', error);
            alert('Error granting admin privileges. Please try again.');
        }
    }
    
    async function revokeAdminPrivileges(userId) {
        if (!confirm('Are you sure you want to revoke admin privileges?')) {
            return;
        }
        
        try {
            await window.firebaseFirestore.deleteDoc(
                window.firebaseFirestore.doc(window.firebaseDB, 'admins', userId)
            );
            
            alert('Admin privileges revoked successfully');
            loadAdminList();
            
        } catch (error) {
            console.error('Error revoking admin privileges:', error);
            alert('Error revoking admin privileges. Please try again.');
        }
    }
    

    
    async function initializeFirstAdmin() {
        try {
            const adminsRef = window.firebaseFirestore.collection(window.firebaseDB, 'admins');
            const adminsSnapshot = await window.firebaseFirestore.getDocs(adminsRef);
            
            if (adminsSnapshot.empty) {
                // Find the initial admin user
                const usersRef = window.firebaseFirestore.collection(window.firebaseDB, 'users');
                const usersSnapshot = await window.firebaseFirestore.getDocs(usersRef);
                let initialAdmin = null;
                
                usersSnapshot.forEach((doc) => {
                    const userData = doc.data();
                    if (userData.email === 'fobiblankson95@gmail.com') {
                        initialAdmin = { uid: doc.id, ...userData };
                    }
                });
                
                if (initialAdmin) {
                    await window.firebaseFirestore.setDoc(
                        window.firebaseFirestore.doc(window.firebaseDB, 'admins', initialAdmin.uid),
                        {
                            email: initialAdmin.email,
                            firstName: initialAdmin.firstName,
                            lastName: initialAdmin.lastName,
                            grantedBy: 'system',
                            grantedAt: new Date().toISOString(),
                            isInitialAdmin: true
                        }
                    );
                    console.log('Initial admin setup complete');
                }
            }
        } catch (error) {
            console.error('Error initializing first admin:', error);
        }
    }
    
    // Real-time listener for admin list
    let adminListListener = null;
    
    async function loadAdminList() {
        if (!window.isAdmin) return;
        
        try {
            const adminsRef = window.firebaseFirestore.collection(window.firebaseDB, 'admins');
            
            // Clean up existing listener
            if (adminListListener) {
                adminListListener();
                adminListListener = null;
            }
            
            // Wait for DOM to be ready with retry limit
            let retryCount = 0;
            const maxRetries = 50; // 5 seconds max
            const checkAdminList = setInterval(() => {
                const adminList = document.getElementById('adminList');
                if (adminList) {
                    clearInterval(checkAdminList);
                    
                    // Show loading state
                    adminList.innerHTML = '<p class="text-gray-500"><i class="fas fa-spinner fa-spin mr-2"></i>Loading admins...</p>';
                    
                    // Set up real-time listener
                    adminListListener = window.firebaseFirestore.onSnapshot(adminsRef, (snapshot) => {
                        console.log(`Real-time admin update: ${snapshot.size} admins`);
                        
                        adminList.innerHTML = '';
                        
                        if (snapshot.empty) {
                            adminList.innerHTML = '<p class="text-gray-500">No admins found</p>';
                            return;
                        }
                        
                        snapshot.forEach((doc) => {
                            const admin = doc.data();
                            const adminDiv = document.createElement('div');
                            adminDiv.className = 'flex justify-between items-center p-3 bg-white rounded-lg border';
                            adminDiv.innerHTML = `
                                <div>
                                    <p class="font-medium">${admin.firstName} ${admin.lastName}</p>
                                    <p class="text-sm text-gray-600">${admin.email}</p>
                                    <p class="text-xs text-gray-500">Granted: ${new Date(admin.grantedAt).toLocaleDateString()}</p>
                                </div>
                                ${doc.id !== window.firebaseAuth.currentUser.uid && !admin.isInitialAdmin ? 
                                    `<button onclick="revokeAdminPrivileges('${doc.id}')" class="bg-red-500 text-white px-3 py-1 rounded text-sm hover:bg-red-600">
                                        <i class="fas fa-user-times"></i> Revoke
                                    </button>` :
                                    '<span class="text-sm text-green-600">' + (admin.isInitialAdmin ? 'System Admin' : 'Current User') + '</span>'
                                }
                            `;
                            adminList.appendChild(adminDiv);
                        });
                    }, (error) => {
                        console.error('Error in admin list listener:', error);
                        adminList.innerHTML = `<p class="text-red-500"><i class="fas fa-exclamation-triangle mr-2"></i>Error loading admins: ${error.message}</p>`;
                    });
                    
                } else {
                    retryCount++;
                    if (retryCount >= maxRetries) {
                        clearInterval(checkAdminList);
                        console.warn('adminList element not found after max retries');
                    }
                }
            }, 100);
            
        } catch (error) {
            console.error('Error setting up admin list listener:', error);
        }
    }
    

    
    // Setup admin tabs functionality
    function setupAdminTabs() {
        console.log('Setting up admin tabs...');
        
        // Ensure admin elements exist
        const adminBtn = document.getElementById('adminBtn');
        if (adminBtn) {
            adminBtn.addEventListener('click', () => {
                loadContent('Admin');
            });
        }
        
        // Add event listeners for admin panel elements
        const addClassBtn = document.getElementById('addClassBtn');
        if (addClassBtn) {
            addClassBtn.addEventListener('click', addNewClass);
        }
        
        const saveAllocationBtn = document.getElementById('saveAllocationBtn');
        if (saveAllocationBtn) {
            saveAllocationBtn.addEventListener('click', saveUserClassAllocation);
        }
        
        const clearLearnersBtn = document.getElementById('clearLearnersBtn');
        if (clearLearnersBtn) {
            clearLearnersBtn.addEventListener('click', clearAllTopLearners);
        }
    }
    
    // Event listeners
    document.addEventListener('DOMContentLoaded', () => {
        // Check if user is authenticated
        const unsubscribe = window.firebaseAuth.onAuthStateChanged((user) => {
            if (!user) {
                // Redirect to login page if not authenticated
                window.location.href = 'index.html';
                return;
            }
            
            // Ensure Firebase is initialized before proceeding
            const checkFirebase = setInterval(() => {
                if (window.firebaseDB && window.firebaseFirestore) {
                    clearInterval(checkFirebase);
                    loadClasses();
                    
                    // Load dashboard by default
                loadContent('Dashboard');
                
                // Set up event listeners after ensuring elements exist
                setTimeout(() => {
                    setupClassButtons();
                    updateWelcomeMessage();
                    initializeFirstAdmin(); // Initialize first admin if needed
                    setupAdminTabs(); // Setup admin tabs functionality
                }, 100);
                }
            }, 100);
            
            // Clean up the auth listener
            setTimeout(() => unsubscribe(), 1000);
        });
        
        const submitPassword = document.getElementById('submitPassword');
        if (submitPassword) submitPassword.addEventListener('click', checkPassword);
        
        const cancelPassword = document.getElementById('cancelPassword');
        if (cancelPassword) cancelPassword.addEventListener('click', hidePasswordModal);
        
        const classPasswordInput = document.getElementById('classPasswordInput');
        if (classPasswordInput) {
            classPasswordInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') checkPassword();
            });
        }
        
        const classesDropdownBtn = document.getElementById('classesDropdownBtn');
        if (classesDropdownBtn) {
            classesDropdownBtn.addEventListener('click', () => {
                document.getElementById('classesDropdownMenu').classList.toggle('hidden');
            });
        }

        // Listen for real-time updates
        if (window.firebaseFirestore) {
            const classesRef = window.firebaseFirestore.collection(window.firebaseDB, 'classes');
            window.firebaseFirestore.onSnapshot(classesRef, (snapshot) => {
                adminClassPasswords = {};
                snapshot.forEach(doc => {
                    const classData = doc.data();
                    adminClassPasswords[doc.id] = {
                    password: classData.password
                };
                });
                updateClassesList();
                updateTabContentWithClasses();
                
                if (document.querySelector('[data-content="Dashboard"]')) {
                    updateDashboardStats();
                }
            });
        }
    });

    // Performance Chart Functions
    let performanceChart = null;
    let performanceChartListener = null;

    async function updatePerformanceChart(selectedClass = 'all') {
        try {
            const ctx = document.getElementById('performanceChart');
            if (!ctx) return;

            // Clean up existing listener
            if (performanceChartListener) {
                performanceChartListener();
                performanceChartListener = null;
            }

            const classesRef = window.firebaseFirestore.collection(window.firebaseDB, 'classes');
            
            // Set up real-time listener for classes
            performanceChartListener = window.firebaseFirestore.onSnapshot(classesRef, async (classesSnapshot) => {
                if (classesSnapshot.empty) {
                    updateChartSummary(0, 0, 0, 'No classes');
                    createOrUpdateChart([]);
                    return;
                }

                let chartData = [];
                let totalLearners = 0;
                let totalPoints = 0;
                let highestPoints = 0;
                let mostActiveClass = { name: 'None', learnerCount: 0 };

                // Process each class with real-time learners data
                const classPromises = classesSnapshot.docs.map(async (classDoc) => {
                    const className = classDoc.id;
                    const learnersRef = window.firebaseFirestore.collection(window.firebaseDB, 'classes', className, 'learners');
                    
                    return new Promise((resolve) => {
                        const learnerListener = window.firebaseFirestore.onSnapshot(learnersRef, (learnersSnapshot) => {
                            let classTotalPoints = 0;
                            let classLearnerCount = 0;

                            learnersSnapshot.forEach(doc => {
                                const learner = doc.data();
                                classTotalPoints += learner.points || 0;
                                classLearnerCount++;
                            });

                            const avgPoints = classLearnerCount > 0 ? Math.round(classTotalPoints / classLearnerCount) : 0;
                            
                            resolve({
                                className: className,
                                learnerCount: classLearnerCount,
                                totalPoints: classTotalPoints,
                                avgPoints: avgPoints
                            });
                        }, (error) => {
                            console.error(`Error loading learners for ${className}:`, error);
                            resolve({
                                className: className,
                                learnerCount: 0,
                                totalPoints: 0,
                                avgPoints: 0
                            });
                        });
                    });
                });

                // Wait for all class data
                const allClassData = await Promise.all(classPromises);

                // Filter and process data
                const filteredData = selectedClass !== 'all' 
                    ? allClassData.filter(item => item.className === selectedClass)
                    : allClassData;

                chartData = filteredData.filter(item => item.learnerCount > 0);

                // Calculate totals
                chartData.forEach(item => {
                    totalLearners += item.learnerCount;
                    totalPoints += item.totalPoints;
                    highestPoints = Math.max(highestPoints, item.totalPoints);
                    
                    if (item.learnerCount > mostActiveClass.learnerCount) {
                        mostActiveClass = { name: item.className, learnerCount: item.learnerCount };
                    }
                });

                // Update summary
                const avgPointsOverall = totalLearners > 0 ? Math.round(totalPoints / totalLearners) : 0;
                updateChartSummary(
                    classesSnapshot.size,
                    avgPointsOverall,
                    highestPoints,
                    mostActiveClass.name
                );

                // Create or update chart
                createOrUpdateChart(chartData);
            }, (error) => {
                console.error('Error in performance chart listener:', error);
                const chartContainer = document.getElementById('performanceChart');
                if (chartContainer) {
                    const isOffline = !navigator.onLine;
                    const ctx = chartContainer.getContext('2d');
                    if (ctx) {
                        ctx.clearRect(0, 0, chartContainer.width, chartContainer.height);
                        ctx.font = '14px Arial';
                        ctx.fillStyle = isOffline ? '#ef4444' : '#666';
                        ctx.textAlign = 'center';
                        ctx.fillText(isOffline ? 'Offline - Check connection' : 'Error loading chart', chartContainer.width / 2, chartContainer.height / 2);
                    }
                }
            });

        } catch (error) {
            console.error('Error setting up performance chart listener:', error);
            const chartContainer = document.getElementById('performanceChart');
            if (chartContainer) {
                const isOffline = !navigator.onLine;
                const ctx = chartContainer.getContext('2d');
                if (ctx) {
                    ctx.clearRect(0, 0, chartContainer.width, chartContainer.height);
                    ctx.font = '14px Arial';
                    ctx.fillStyle = isOffline ? '#ef4444' : '#666';
                    ctx.textAlign = 'center';
                    ctx.fillText(isOffline ? 'Offline - Check connection' : 'Error loading chart', chartContainer.width / 2, chartContainer.height / 2);
                }
            }
        }
    }

    function createOrUpdateChart(chartData) {
        const ctx = document.getElementById('performanceChart');
        if (!ctx) return;

        // Destroy existing chart if it exists
        if (performanceChart) {
            performanceChart.destroy();
        }

        if (chartData.length === 0) {
            const context = ctx.getContext('2d');
            context.clearRect(0, 0, ctx.width, ctx.height);
            context.font = '14px Arial';
            context.fillStyle = '#666';
            context.textAlign = 'center';
            context.fillText('No data available', ctx.width / 2, ctx.height / 2);
            return;
        }

        const labels = chartData.map(item => item.className);
        const data = chartData.map(item => item.avgPoints);
        const backgroundColors = [
            '#FF6384',
            '#36A2EB',
            '#FFCE56',
            '#4BC0C0',
            '#9966FF',
            '#FF9F40',
            '#FF6384',
            '#C9CBCF'
        ];

        performanceChart = new Chart(ctx.getContext('2d'), {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Average Points per Learner',
                    data: data,
                    backgroundColor: backgroundColors.slice(0, labels.length),
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Average Points'
                        }
                    },
                    x: {
                        title: {
                            display: true,
                            text: 'Class Name'
                        }
                    }
                }
            }
        });
    }

    function updateChartSummary(totalClasses, avgPoints, highestPoints, mostActiveClass) {
        const chartTotalClassesEl = document.getElementById('chartTotalClasses');
        const chartAvgPointsEl = document.getElementById('chartAvgPoints');
        const chartHighestPointsEl = document.getElementById('chartHighestPoints');
        const chartMostActiveEl = document.getElementById('chartMostActive');

        if (chartTotalClassesEl) chartTotalClassesEl.textContent = totalClasses;
        if (chartAvgPointsEl) chartAvgPointsEl.textContent = avgPoints;
        if (chartHighestPointsEl) chartHighestPointsEl.textContent = highestPoints;
        if (chartMostActiveEl) chartMostActiveEl.textContent = mostActiveClass;
    }

    // Populate class selector with real-time updates
    let classSelectorListener = null;
    
    async function populateClassSelector() {
        const classSelector = document.getElementById('classSelector');
        if (!classSelector) return;

        try {
            // Clean up existing listener
            if (classSelectorListener) {
                classSelectorListener();
                classSelectorListener = null;
            }

            const classesRef = window.firebaseFirestore.collection(window.firebaseDB, 'classes');
            
            // Set up real-time listener for classes
            classSelectorListener = window.firebaseFirestore.onSnapshot(classesRef, (classesSnapshot) => {
                // Clear existing options except 'all'
                classSelector.innerHTML = '<option value="all">All Classes</option>';

                if (classesSnapshot.empty) {
                    return;
                }

                classesSnapshot.forEach(doc => {
                    const className = doc.id;
                    const option = document.createElement('option');
                    option.value = className;
                    option.textContent = className;
                    classSelector.appendChild(option);
                });

                // Trigger chart update with current selection
                const currentSelection = classSelector.value;
                updatePerformanceChart(currentSelection);
            }, (error) => {
                console.error('Error in class selector listener:', error);
            });

            // Add event listener for manual changes
            classSelector.addEventListener('change', (e) => {
                updatePerformanceChart(e.target.value);
            });
            
        } catch (error) {
            console.error('Error setting up class selector listener:', error);
        }
    }

    // Update dashboard stats
    // Dashboard stats with real-time updates
    let dashboardStatsListener = null;
    
    async function updateDashboardStats() {
        try {
            // Clean up existing listener
            if (dashboardStatsListener) {
                dashboardStatsListener();
                dashboardStatsListener = null;
            }

            const classesRef = window.firebaseFirestore.collection(window.firebaseDB, 'classes');
            
            // Set up real-time listener for classes and learners
            dashboardStatsListener = window.firebaseFirestore.onSnapshot(classesRef, (classesSnapshot) => {
                if (classesSnapshot.empty) {
                    const totalClassesEl = document.getElementById('totalClasses');
                    const totalStudentsEl = document.getElementById('totalStudents');
                    const totalPointsEl = document.getElementById('totalPoints');

                    if (totalClassesEl) totalClassesEl.textContent = '0';
                    if (totalStudentsEl) totalStudentsEl.textContent = '0';
                    if (totalPointsEl) totalPointsEl.textContent = '0';
                    return;
                }

                let totalStudents = 0;
                let totalPoints = 0;
                let classesProcessed = 0;

                // Set up listeners for each class's learners
                const classListeners = [];
                
                classesSnapshot.docs.forEach((classDoc) => {
                    const className = classDoc.id;
                    const learnersRef = window.firebaseFirestore.collection(window.firebaseDB, 'classes', className, 'learners');
                    
                    const learnerListener = window.firebaseFirestore.onSnapshot(learnersRef, (learnersSnapshot) => {
                        // Calculate stats for this class
                        let classStudents = 0;
                        let classPoints = 0;
                        
                        learnersSnapshot.forEach(doc => {
                            const learner = doc.data();
                            classStudents++;
                            classPoints += learner.points || 0;
                        });
                        
                        // Update totals
                        totalStudents += classStudents;
                        totalPoints += classPoints;
                        
                        // Update display
                        const totalClassesEl = document.getElementById('totalClasses');
                        const totalStudentsEl = document.getElementById('totalStudents');
                        const totalPointsEl = document.getElementById('totalPoints');

                        if (totalClassesEl) totalClassesEl.textContent = classesSnapshot.size;
                        if (totalStudentsEl) totalStudentsEl.textContent = totalStudents;
                        if (totalPointsEl) totalPointsEl.textContent = totalPoints;
                        
                    }, (error) => {
                        console.error(`Error in stats listener for ${className}:`, error);
                    });
                    
                    classListeners.push(learnerListener);
                });
                
                // Store listeners for cleanup
                window.dashboardStatsListeners = classListeners;
                
            }, (error) => {
                console.error('Error in dashboard stats listener:', error);
            });

        } catch (error) {
            console.error('Error setting up dashboard stats listener:', error);
        }
    }

    // Enhanced loadClasses to include chart updates
    window.loadClasses = async function() {
        populateClassSelector();
        updatePerformanceChart();
        updateDashboardStats();
    };

    // Enhanced updateTopLearnersOnDashboard to include stats update
    window.updateTopLearnersOnDashboard = async function() {
        updateDashboardStats();
    };

    // Cleanup function for all real-time listeners
    function cleanupDashboardListeners() {
        if (performanceChartListener) {
            performanceChartListener();
            performanceChartListener = null;
        }
        
        if (classSelectorListener) {
            classSelectorListener();
            classSelectorListener = null;
        }
        
        if (dashboardStatsListener) {
            dashboardStatsListener();
            dashboardStatsListener = null;
        }
        
        if (window.dashboardStatsListeners) {
            window.dashboardStatsListeners.forEach(listener => listener());
            window.dashboardStatsListeners = [];
        }
        
        if (userClassCheckboxesListener) {
            userClassCheckboxesListener();
            userClassCheckboxesListener = null;
        }
        
        if (window.adminListListener) {
            window.adminListListener();
            window.adminListListener = null;
        }
        
        if (window.userClassAllocationsListener) {
            window.userClassAllocationsListener();
            window.userClassAllocationsListener = null;
        }
    }

    // Initialize dashboard components
    const checkChartInterval = setInterval(() => {
        if (document.getElementById('performanceChart')) {
            clearInterval(checkChartInterval);
            populateClassSelector();
            updatePerformanceChart();
            updateDashboardStats();
            loadTopLearners(); // Initialize top learners display
        }
    }, 500);

    // Add cleanup when page is unloaded
    window.addEventListener('beforeunload', cleanupDashboardListeners);
    
    // Also cleanup when switching between dashboard sections
    document.addEventListener('DOMContentLoaded', function() {
        // Store original loadContent function for cleanup
        const originalLoadContent = window.loadContent;
        if (originalLoadContent) {
            window.loadContent = function(section) {
                cleanupDashboardListeners();
                return originalLoadContent(section);
            };
        }
    });

    // Network status indicator
    function updateNetworkStatus(online) {
        const statusIndicator = document.getElementById('networkStatus') || createNetworkStatusIndicator();
        if (online) {
            statusIndicator.className = 'fixed top-4 right-4 bg-green-500 text-white px-3 py-1 rounded-full text-sm';
            statusIndicator.innerHTML = '<i class="fas fa-wifi mr-1"></i> Online';
            setTimeout(() => statusIndicator.style.display = 'none', 3000);
        } else {
            statusIndicator.className = 'fixed top-4 right-4 bg-red-500 text-white px-3 py-1 rounded-full text-sm';
            statusIndicator.innerHTML = '<i class="fas fa-exclamation-triangle mr-1"></i> Offline';
            statusIndicator.style.display = 'block';
        }
    }

    function createNetworkStatusIndicator() {
        const indicator = document.createElement('div');
        indicator.id = 'networkStatus';
        indicator.className = 'fixed top-4 right-4 bg-green-500 text-white px-3 py-1 rounded-full text-sm';
        indicator.style.display = 'none';
        document.body.appendChild(indicator);
        return indicator;
    }

    // Monitor network status
    window.addEventListener('online', () => updateNetworkStatus(true));
    window.addEventListener('offline', () => updateNetworkStatus(false));
    
    // Initial network check
    setTimeout(() => {
        updateNetworkStatus(navigator.onLine);
    }, 1000);
    
    // Export learner data to Excel
    async function exportToExcel(className) {
        try {
            const learnersRef = window.firebaseFirestore.collection(window.firebaseDB, 'classes', className, 'learners');
            const learnersSnapshot = await window.firebaseFirestore.getDocs(learnersRef);
            
            if (learnersSnapshot.empty) {
                alert('No learners to export');
                return;
            }
            
            // Collect all learner data
            const learners = [];
            learnersSnapshot.forEach(doc => {
                const learnerData = doc.data();
                
                // Calculate total adjustments
                const totalAdjustments = learnerData.adjustments ? learnerData.adjustments.length : 0;
                
                // Get last adjustment details
                let lastAdjustmentDate = '';
                let lastAdjustmentReason = '';
                let lastAdjustmentBy = '';
                let lastAdjustmentPoints = '';
                
                if (learnerData.lastAdjustment) {
                    const lastAdj = learnerData.lastAdjustment;
                    lastAdjustmentDate = new Date(lastAdj.date).toLocaleDateString();
                    lastAdjustmentReason = lastAdj.reason;
                    lastAdjustmentBy = lastAdj.adjustedBy;
                    lastAdjustmentPoints = lastAdj.points;
                }
                
                // Create detailed adjustment history
                let adjustmentHistory = '';
                if (learnerData.adjustments && learnerData.adjustments.length > 0) {
                    adjustmentHistory = learnerData.adjustments.map(adj => {
                        const adjDate = new Date(adj.date).toLocaleDateString();
                        const adjTime = new Date(adj.date).toLocaleTimeString();
                        return `${adjDate} ${adjTime}: ${adj.points > 0 ? '+' : ''}${adj.points} points - ${adj.reason} (by ${adj.adjustedBy})`;
                    }).join('; ');
                }
                
                learners.push({
                    'Learner Name': learnerData.name,
                    'Current Points': learnerData.points,
                    'Total Adjustments': totalAdjustments,
                    'Last Adjustment Date': lastAdjustmentDate,
                    'Last Adjustment Reason': lastAdjustmentReason,
                    'Last Adjustment By': lastAdjustmentBy,
                    'Last Adjustment Points': lastAdjustmentPoints,
                    'Adjustment History': adjustmentHistory,
                    'Learner ID': doc.id
                });
            });
            
            // Sort by points (highest first)
            learners.sort((a, b) => b['Current Points'] - a['Current Points']);
            
            // Create workbook and worksheet
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.json_to_sheet(learners);
            
            // Set column widths
            const colWidths = [
                { wch: 20 }, // Learner Name
                { wch: 12 }, // Current Points
                { wch: 15 }, // Total Adjustments
                { wch: 15 }, // Last Adjustment Date
                { wch: 25 }, // Last Adjustment Reason
                { wch: 20 }, // Last Adjustment By
                { wch: 15 }, // Last Adjustment Points
                { wch: 50 }, // Adjustment History
                { wch: 20 }  // Learner ID
            ];
            ws['!cols'] = colWidths;
            
            // Add worksheet to workbook
            XLSX.utils.book_append_sheet(wb, ws, 'Learners');
            
            // Generate filename with class name and date
            const date = new Date().toISOString().split('T')[0];
            const filename = `${className}_Learners_${date}.xlsx`;
            
            // Save file
            XLSX.writeFile(wb, filename);
            
            console.log(`Successfully exported ${learners.length} learners to Excel`);
            
        } catch (error) {
            console.error('Error exporting to Excel:', error);
            alert('Error exporting data to Excel. Please try again.');
        }
    }

    // Export all classes data to Excel
    async function exportAllClassesData() {
        try {
            const classesRef = window.firebaseFirestore.collection(window.firebaseDB, 'classes');
            const classesSnapshot = await window.firebaseFirestore.getDocs(classesRef);
            
            if (classesSnapshot.empty) {
                alert('No classes found to export');
                return;
            }
            
            const allLearners = [];
            let totalLearners = 0;
            
            // Process each class
            for (const classDoc of classesSnapshot.docs) {
                const className = classDoc.id;
                const learnersRef = window.firebaseFirestore.collection(window.firebaseDB, 'classes', className, 'learners');
                const learnersSnapshot = await window.firebaseFirestore.getDocs(learnersRef);
                
                if (!learnersSnapshot.empty) {
                    learnersSnapshot.forEach(doc => {
                        const learnerData = doc.data();
                        
                        // Calculate total adjustments
                        const totalAdjustments = learnerData.adjustments ? learnerData.adjustments.length : 0;
                        
                        // Get last adjustment details
                        let lastAdjustmentDate = '';
                        let lastAdjustmentReason = '';
                        let lastAdjustmentBy = '';
                        let lastAdjustmentPoints = '';
                        
                        if (learnerData.lastAdjustment) {
                            const lastAdj = learnerData.lastAdjustment;
                            lastAdjustmentDate = new Date(lastAdj.date).toLocaleDateString();
                            lastAdjustmentReason = lastAdj.reason;
                            lastAdjustmentBy = lastAdj.adjustedBy;
                            lastAdjustmentPoints = lastAdj.points;
                        }
                        
                        // Create detailed adjustment history
                        let adjustmentHistory = '';
                        if (learnerData.adjustments && learnerData.adjustments.length > 0) {
                            adjustmentHistory = learnerData.adjustments.map(adj => {
                                const adjDate = new Date(adj.date).toLocaleDateString();
                                const adjTime = new Date(adj.date).toLocaleTimeString();
                                return `${adjDate} ${adjTime}: ${adj.points > 0 ? '+' : ''}${adj.points} points - ${adj.reason} (by ${adj.adjustedBy})`;
                            }).join('; ');
                        }
                        
                        allLearners.push({
                            'Class': className,
                            'Learner Name': learnerData.name,
                            'Current Points': learnerData.points,
                            'Total Adjustments': totalAdjustments,
                            'Last Adjustment Date': lastAdjustmentDate,
                            'Last Adjustment Reason': lastAdjustmentReason,
                            'Last Adjustment By': lastAdjustmentBy,
                            'Last Adjustment Points': lastAdjustmentPoints,
                            'Adjustment History': adjustmentHistory,
                            'Learner ID': doc.id
                        });
                        
                        totalLearners++;
                    });
                }
            }
            
            if (totalLearners === 0) {
                alert('No learners found in any class');
                return;
            }
            
            // Sort by class name, then by points (highest first)
            allLearners.sort((a, b) => {
                if (a.Class === b.Class) {
                    return b['Current Points'] - a['Current Points'];
                }
                return a.Class.localeCompare(b.Class);
            });
            
            // Create workbook and worksheet
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.json_to_sheet(allLearners);
            
            // Set column widths
            const colWidths = [
                { wch: 15 }, // Class
                { wch: 20 }, // Learner Name
                { wch: 12 }, // Current Points
                { wch: 15 }, // Total Adjustments
                { wch: 15 }, // Last Adjustment Date
                { wch: 25 }, // Last Adjustment Reason
                { wch: 20 }, // Last Adjustment By
                { wch: 15 }, // Last Adjustment Points
                { wch: 50 }, // Adjustment History
                { wch: 20 }  // Learner ID
            ];
            ws['!cols'] = colWidths;
            
            // Add worksheet to workbook
            XLSX.utils.book_append_sheet(wb, ws, 'All Classes Data');
            
            // Generate filename with date
            const date = new Date().toISOString().split('T')[0];
            const filename = `All_Classes_Learners_${date}.xlsx`;
            
            // Save file
            XLSX.writeFile(wb, filename);
            
            console.log(`Successfully exported ${totalLearners} learners from ${classesSnapshot.size} classes to Excel`);
            
        } catch (error) {
            console.error('Error exporting all classes data to Excel:', error);
            alert('Error exporting data to Excel. Please try again.');
        }
    }

</script>

  <!-- PWA Service Worker Registration -->
  <script>
    // Register service worker for PWA functionality
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', function() {
        navigator.serviceWorker.register('/service-worker.js')
          .then(function(registration) {
            console.log('ServiceWorker registration successful with scope: ', registration.scope);
            
            // Handle service worker updates
            registration.addEventListener('updatefound', function() {
              const newWorker = registration.installing;
              newWorker.addEventListener('statechange', function() {
                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                  // New service worker available
                  console.log('New version available');
                  if (confirm('A new version is available. Refresh to update?')) {
                    newWorker.postMessage({ type: 'SKIP_WAITING' });
                    window.location.reload();
                  }
                }
              });
            });
          })
          .catch(function(error) {
            console.log('ServiceWorker registration failed: ', error);
          });
      });
    }
  </script>

</body>
</html>