<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Parent Portal - Student Behaviour Tracker</title>
    <meta name="description" content="Monitor your child's academic progress and behavior points">
    <meta name="theme-color" content="#2563eb">
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/png" href="images/icon-192.png">
    
    <!-- Local Parent Styles -->
    <link rel="stylesheet" href="parent-styles.css">
    
    <!-- Firebase -->
    <script type="module" src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js"></script>
    <script type="module" src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js"></script>
    <script type="module" src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    

</head>
<body>
    <!-- Header Navigation -->
    <header id="mainHeader">
        <div class="header-container">
            <div class="header-content">
                <div class="header-brand">
                    <i class="fas fa-user-shield"></i>
                    <h1>Parent Portal</h1>
                </div>
                <div id="authButtons" class="auth-buttons">
                    <button onclick="showLogin()" class="btn btn-primary">
                        <i class="fas fa-sign-in-alt"></i>Login
                    </button>
                    <button onclick="showRegistration()" class="btn btn-success">
                        <i class="fas fa-user-plus"></i>Register
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Authentication Container -->
    <div id="authContainer" class="auth-container">
        <div class="auth-card">
            <div class="auth-header">
                <i class="fas fa-user-shield"></i>
                <h1>Parent Portal</h1>
                <p>Monitor your child's academic journey</p>
            </div>
            
            <!-- Login Form -->
            <div id="loginForm" class="space-y-6">
                <div class="form-group">
                    <label class="form-label">Phone Number (include country code)</label>
                    <div class="input-group">
                        <i class="fas fa-phone input-icon"></i>
                        <input type="tel" id="phoneNumber" placeholder="+1234567890" class="form-input">
                    </div>
                    <p class="form-help">Format: +[country code][number] (e.g., +1234567890)</p>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Password</label>
                    <div class="input-group">
                        <i class="fas fa-lock input-icon"></i>
                        <input type="password" id="loginPassword" placeholder="Enter your password" class="form-input">
                    </div>
                </div>
                
                <button onclick="loginWithPassword()" class="btn btn-primary w-full">
                    <i class="fas fa-sign-in-alt"></i>Login
                </button>
                
                <!-- OTP section removed as we now use password-based authentication -->
                
                <div class="text-center">
                    <p class="text-sm">
                        New parent? <button onclick="showRegistration()" class="text-purple-600 font-semibold">Register here</button>
                    </p>
                </div>
            </div>
            
            <!-- Registration Form -->
            <div id="registrationForm" class="hidden">
                <div class="form-group">
                    <label class="form-label">Your Name</label>
                    <div class="input-group">
                        <i class="fas fa-user input-icon"></i>
                        <input type="text" id="parentName" placeholder="Your full name" class="form-input">
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Phone Number (include country code)</label>
                    <div class="input-group">
                        <i class="fas fa-phone input-icon"></i>
                        <input type="tel" id="regPhoneNumber" placeholder="+1234567890" class="form-input">
                    </div>
                    <p class="form-help">Format: +[country code][number] (e.g., +1234567890)</p>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Child's Phone or Guardian Phone (as registered by teacher)</label>
                    <div class="input-group">
                        <i class="fas fa-child input-icon"></i>
                        <input type="tel" id="childGuardianPhone" placeholder="+1234567890" class="form-input">
                    </div>
                    <p class="form-help">Format: +[country code][number] (e.g., +1234567890)</p>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Create Password</label>
                    <div class="input-group">
                        <i class="fas fa-lock input-icon"></i>
                        <input type="password" id="regPassword" placeholder="Create a secure password" class="form-input">
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Confirm Password</label>
                    <div class="input-group">
                        <i class="fas fa-lock input-icon"></i>
                        <input type="password" id="confirmPassword" placeholder="Confirm your password" class="form-input">
                    </div>
                </div>
                
                <button onclick="registerParent()" class="btn btn-primary w-full">
                    <i class="fas fa-user-plus"></i>Register
                </button>
                
                <div class="text-center">
                    <p class="text-sm">
                        Already registered? <button onclick="showLogin()" class="text-purple-600 font-semibold">Login here</button>
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Dashboard Container -->
    <div id="dashboardContainer" class="hidden">
        <!-- Header -->
        <header class="dashboard-header">
            <div class="dashboard-header-content">
                <div class="header-brand">
                    <i class="fas fa-home"></i>
                    <h1>Parent Dashboard</h1>
                </div>
                <button onclick="logout()" class="btn btn-primary">
                    <i class="fas fa-sign-out-alt"></i>Logout
                </button>
            </div>
        </header>

        <!-- Main Content -->
        <main class="dashboard-main">
            <!-- Welcome Section -->
            <div class="welcome-card">
                <h2>Welcome, <span id="parentNameDisplay">Parent</span>!</h2>
                <p>Track your child's academic progress and behavior in real-time</p>
            </div>

            <!-- Children Cards -->
            <div id="childrenContainer" class="children-grid">
                <!-- Children will be loaded here -->
            </div>

            <!-- No Children Message -->
            <div id="noChildrenMessage" class="no-children hidden">
                <i class="fas fa-exclamation-triangle"></i>
                <h3>No children found</h3>
                <p>Your phone number is not linked to any students. Please ensure your number matches either the guardian phone or the learner's phone registered by your child's teacher.</p>
            </div>
        </main>
    </div>

    <!-- Child Detail Modal -->
    <div id="childModal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="childModalName">Child Details</h3>
                <button onclick="closeChildModal()" class="modal-close">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <div class="modal-grid">
                <!-- Child Info -->
                <div class="child-card">
                    <h4>Child Information</h4>
                    <div class="child-info">
                        <p class="label">Name</p>
                        <p class="value" id="childName">-</p>
                        <p class="label">Class</p>
                        <p class="value" id="childClass">-</p>
                        <p class="label">Current Points</p>
                        <p class="points" id="childPoints">-</p>
                    </div>
                </div>

                <!-- Recent Activity -->
                <div>
                    <h4>Recent Activity</h4>
                    <div id="recentActivity">
                        <!-- Activity will be loaded here -->
                    </div>
                </div>
            </div>

            <!-- Full History -->
            <div>
                <h4>Complete History</h4>
                <div class="table-container">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Points</th>
                                <th>Reason</th>
                                <th>Teacher</th>
                            </tr>
                        </thead>
                        <tbody id="historyTable">
                            <!-- History will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase Configuration -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        // We're not using Firebase Auth anymore, so we don't need to import it
        // import { getAuth, signInWithPhoneNumber, RecaptchaVerifier } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, collection, query, where, getDocs, doc, getDoc, setDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBNGdPWISw803XD8xVo0RyCGoGpNX8o_jM",
            authDomain: "dpointslogin.firebaseapp.com",
            projectId: "dpointslogin",
            storageBucket: "dpointslogin.firebasestorage.app",
            messagingSenderId: "486203348613",
            appId: "1:486203348613:web:a22083bc80b9326bc73bec"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        // We're not using Firebase Auth anymore
        // const auth = getAuth(app);
        const db = getFirestore(app);

        // Global variables
        window.firebaseFirestore = {
            db,
            collection,
            query,
            where,
            getDocs,
            doc,
            getDoc,
            setDoc
        };

        // Authentication functions
        window.loginWithPassword = async function() {
            let phoneNumber = document.getElementById('phoneNumber').value.trim();
            const password = document.getElementById('loginPassword').value;
            
            if (!phoneNumber || !password) {
                alert('Please enter both phone number and password');
                return;
            }

            // Show loading state
            const loginBtn = document.querySelector('#loginForm .btn-primary');
            const originalText = loginBtn.innerHTML;
            loginBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Logging in...';
            loginBtn.disabled = true;

            // Ensure phone number is in E.164 format (e.g., +1234567890)
            if (!phoneNumber.startsWith('+')) {
                phoneNumber = '+' + phoneNumber;
            }

            try {
                // Simulate delay for better UX
                await new Promise(resolve => setTimeout(resolve, 1500));

                // Create a user ID based on the phone number - this must match the format used in registration
                const userId = 'user_' + phoneNumber.replace(/[^0-9]/g, '');
                
                // Check if user exists
                const userDoc = await getDoc(doc(db, 'parents', userId));
                
                if (!userDoc.exists()) {
                    loginBtn.innerHTML = originalText;
                    loginBtn.disabled = false;
                    alert('No account found with this phone number. Please register first.');
                    return;
                }
                
                const userData = userDoc.data();
                
                // Verify password (in a real app, you would hash and compare passwords)
                if (userData.password !== password) {
                    loginBtn.innerHTML = originalText;
                    loginBtn.disabled = false;
                    alert('Invalid password. Please try again.');
                    return;
                }
                
                // Normalize phone number for consistent comparison
                    const normalizedPhone = phoneNumber.replace(/[^0-9+]/g, '');
                    
                    // Check if this phone number is linked to any children
                    try {
                        let hasChildren = false;
                        const classesSnapshot = await getDocs(collection(db, 'classes'));
                        
                        for (const classDoc of classesSnapshot.docs) {
                            const className = classDoc.id;
                            const learnersRef = collection(db, 'classes', className, 'learners');
                            
                            try {
                                // Check guardian phone (using normalized format)
                                const guardianQuery = query(learnersRef, where('guardianPhone', '==', normalizedPhone));
                                const guardianSnapshot = await getDocs(guardianQuery);
                                
                                if (!guardianSnapshot.empty) {
                                    hasChildren = true;
                                    break;
                                }
                                
                                // Check learner's direct phone (using normalized format)
                                const phoneQuery = query(learnersRef, where('phone', '==', normalizedPhone));
                                const phoneSnapshot = await getDocs(phoneQuery);
                                
                                if (!phoneSnapshot.empty) {
                                    hasChildren = true;
                                    break;
                                }
                        } catch (error) {
                            console.error('Error checking learners:', error);
                            if (error.code === 'permission-denied') {
                                loginBtn.innerHTML = originalText;
                                loginBtn.disabled = false;
                                alert('Error: Firebase permission denied when checking learners. Please contact the administrator to update the security rules.');
                                return;
                            }
                        }
                    }

                    if (!hasChildren) {
                        loginBtn.innerHTML = originalText;
                        loginBtn.disabled = false;
                        const proceed = confirm('No children found with this phone number. This might be because:\n\n• Your child hasn\'t been added to the system yet\n• The phone number doesn\'t match what the teacher registered\n\nWould you like to proceed with login? Your children will appear here when they are added to the system.');
                        if (!proceed) {
                            return;
                        }
                    }
                } catch (error) {
                    console.error('Error checking classes:', error);
                    if (error.code === 'permission-denied') {
                        loginBtn.innerHTML = originalText;
                        loginBtn.disabled = false;
                        alert('Error: Firebase permission denied when checking classes. Please contact the administrator to update the security rules.');
                        return;
                    }
                }

                // Store the phone number for later use
                localStorage.setItem('parentPhone', phoneNumber);
                
                // Show success message briefly before dashboard loads
                loginBtn.innerHTML = '<i class="fas fa-check"></i> Success!';
                setTimeout(async () => {
                    await loadParentDashboard({ phoneNumber: phoneNumber });
                }, 500);
                
            } catch (error) {
                console.error('Error logging in:', error);
                loginBtn.innerHTML = originalText;
                loginBtn.disabled = false;
                alert('Error: ' + error.message);
            }
        };
        
        // We'll keep this function for backward compatibility but it's no longer used
        function clearRecaptchaContainer() {
            // This function is kept for compatibility but does nothing now
        }

        // This function is kept for backward compatibility but is no longer used
        window.sendOTP = function() {
            alert('This authentication method is no longer supported. Please use your password to login.');
        };
        
        // This function is kept for backward compatibility but is no longer used
        window.verifyOTP = function() {
            alert('This authentication method is no longer supported. Please use your password to login.');
        };

        window.registerParent = async function() {
            const parentName = document.getElementById('parentName').value.trim();
            let phoneNumber = document.getElementById('regPhoneNumber').value.trim();
            let childGuardianPhone = document.getElementById('childGuardianPhone').value.trim();
            const password = document.getElementById('regPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;

            if (!parentName || !phoneNumber || !childGuardianPhone || !password || !confirmPassword) {
                alert('Please fill in all fields');
                return;
            }
            
            // Validate password
            if (password !== confirmPassword) {
                alert('Passwords do not match');
                return;
            }
            
            if (password.length < 6) {
                alert('Password must be at least 6 characters long');
                return;
            }
            
            // Show loading state
            const registerBtn = document.querySelector('#registrationForm .btn-primary');
            const originalText = registerBtn.innerHTML;
            registerBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Creating Account...';
            registerBtn.disabled = true;
            
            // Ensure phone numbers are in E.164 format (e.g., +1234567890)
            if (!phoneNumber.startsWith('+')) {
                phoneNumber = '+' + phoneNumber;
            }
            
            if (!childGuardianPhone.startsWith('+')) {
                childGuardianPhone = '+' + childGuardianPhone;
            }
            
            // Create a consistent user ID format
            const userId = 'user_' + phoneNumber.replace(/[^0-9]/g, '');

            try {
                // Simulate delay for better UX
                await new Promise(resolve => setTimeout(resolve, 2000));
                
                // Normalize phone number for consistent comparison
                const normalizedPhone = phoneNumber.replace(/[^0-9+]/g, '');
                
                // Check if any child has this guardian phone or direct phone
            let hasChildren = false;
            try {
                const classesSnapshot = await getDocs(collection(db, 'classes'));
                
                for (const classDoc of classesSnapshot.docs) {
                    const className = classDoc.id;
                    const learnersRef = collection(db, 'classes', className, 'learners');
                    
                    try {
                        // Check guardian phone (using normalized format)
                        const guardianQuery = query(learnersRef, where('guardianPhone', '==', normalizedPhone));
                        const guardianSnapshot = await getDocs(guardianQuery);
                        
                        if (!guardianSnapshot.empty) {
                            hasChildren = true;
                            break;
                        }
                        
                        // Check learner's direct phone (using normalized format)
                        const phoneQuery = query(learnersRef, where('phone', '==', normalizedPhone));
                        const phoneSnapshot = await getDocs(phoneQuery);
                        
                        if (!phoneSnapshot.empty) {
                            hasChildren = true;
                            break;
                        }
                        } catch (error) {
                            console.error('Error checking learners:', error);
                            if (error.code === 'permission-denied') {
                                alert('Error: Firebase permission denied when checking learners. Please contact the administrator to update the security rules.');
                                return;
                            }
                            throw error;
                        }
                    }
                } catch (error) {
                    console.error('Error checking classes:', error);
                    if (error.code === 'permission-denied') {
                        alert('Error: Firebase permission denied when checking classes. Please contact the administrator to update the security rules.');
                        return;
                    }
                    throw error;
                }

                if (!hasChildren) {
                    registerBtn.innerHTML = originalText;
                    registerBtn.disabled = false;
                    const proceed = confirm('No children found with this guardian phone number. This might be because:\n\n• Your child hasn\'t been added to the system yet\n• The phone number doesn\'t match what the teacher registered\n\nWould you like to proceed with registration? You can link your children later when they are added to the system.');
                    if (!proceed) {
                        return;
                    }
                    
                    // Re-enable loading state after confirmation
                    registerBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Creating Account...';
                    registerBtn.disabled = true;
                    await new Promise(resolve => setTimeout(resolve, 500));
                }
                
                // Check if user already exists
                try {
                    const userId = 'user_' + phoneNumber.replace(/[^0-9]/g, '');
                    const userDoc = await getDoc(doc(db, 'parents', userId));
                    
                    if (userDoc.exists()) {
                        registerBtn.innerHTML = originalText;
                        registerBtn.disabled = false;
                        alert('An account with this phone number already exists. Please login instead.');
                        showLogin();
                        return;
                    }

                    // Create parent profile with password (in a real app, you would hash this password)
                    await setDoc(doc(db, 'parents', userId), {
                        name: parentName,
                        phoneNumber: phoneNumber,
                        guardianPhone: childGuardianPhone,
                        password: password, // In a real app, NEVER store plain text passwords
                        createdAt: new Date().toISOString(),
                        children: []
                    });
                    
                    // Show success message
                    registerBtn.innerHTML = '<i class="fas fa-check"></i> Account Created!';
                    setTimeout(async () => {
                        alert('Registration successful! You are now logged in.');
                        localStorage.setItem('parentPhone', phoneNumber);
                        await loadParentDashboard({ phoneNumber: phoneNumber });
                    }, 1000);
                    
                } catch (error) {
                    console.error('Firebase write error:', error);
                    registerBtn.innerHTML = originalText;
                    registerBtn.disabled = false;
                    if (error.code === 'permission-denied') {
                        alert('Error: Firebase permission denied. Please contact the administrator to update the security rules.');
                    } else {
                        alert('Error creating account: ' + error.message);
                    }
                }
            } catch (error) {
                console.error('Error registering parent:', error);
                registerBtn.innerHTML = originalText;
                registerBtn.disabled = false;
                alert('Error: ' + error.message);
            }
        };

        window.loadParentDashboard = async function(user) {
            // Show loading state
            document.getElementById('authContainer').classList.add('hidden');
            document.getElementById('dashboardContainer').classList.remove('hidden');
            
            // Show loading indicator
            const childrenContainer = document.getElementById('childrenContainer');
            const noChildrenMsg = document.getElementById('noChildrenMessage');
            noChildrenMsg.classList.add('hidden');
            childrenContainer.innerHTML = '<div class="text-center py-8"><div class="spinner"></div><p class="text-gray-600 mt-2">Loading dashboard...</p></div>';
            
            try {
                // Simulate loading delay for better UX
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                // Format the user ID consistently
                const userId = user.uid || ('user_' + (user.phoneNumber || '').replace(/[^0-9]/g, ''));
                
                // Load parent information from Firestore
                const parentDoc = await getDoc(doc(db, 'parents', userId));
                if (parentDoc.exists()) {
                    const parentData = parentDoc.data();
                    document.getElementById('parentNameDisplay').textContent = parentData.name;
                    await loadChildren(parentData.guardianPhone);
                } else {
                    // Fallback to phone number
                    document.getElementById('parentNameDisplay').textContent = 'Parent';
                    await loadChildren(user.phoneNumber);
                }
            } catch (error) {
                console.error('Error loading parent dashboard:', error);
                document.getElementById('parentNameDisplay').textContent = 'Parent';
                await loadChildren(user.phoneNumber);
            }
        };

        window.loadChildren = async function(parentPhone) {
            try {
                const children = [];
                
                // Show loading indicator
                const childrenContainer = document.getElementById('childrenContainer');
                childrenContainer.innerHTML = '<div class="text-center py-8"><div class="spinner"></div><p class="text-gray-600 mt-2">Loading children data...</p></div>';
                
                // Normalize phone number - remove all non-digits except +
                if (parentPhone) {
                    parentPhone = parentPhone.replace(/[^0-9+]/g, '');
                    // Ensure it starts with + if it doesn't already
                    if (!parentPhone.startsWith('+') && parentPhone.length > 0) {
                        parentPhone = '+' + parentPhone;
                    }
                }
                
                // Simulate loading delay for better UX
                await new Promise(resolve => setTimeout(resolve, 800));
                
                // Get all classes
                const classesSnapshot = await getDocs(collection(db, 'classes'));
                
                for (const classDoc of classesSnapshot.docs) {
                    const className = classDoc.id;
                    
                    // Get learners in this class with matching guardian phone
                    const learnersRef = collection(db, 'classes', className, 'learners');
                    
                    // First query: Check for guardianPhone match
                    const guardianQuery = query(learnersRef, where('guardianPhone', '==', parentPhone));
                    const guardianSnapshot = await getDocs(guardianQuery);
                    
                    guardianSnapshot.forEach(learnerDoc => {
                        children.push({
                            id: learnerDoc.id,
                            className: className,
                            ...learnerDoc.data()
                        });
                    });
                    
                    // Second query: Check for phone match directly with learner's phone
                    const phoneQuery = query(learnersRef, where('phone', '==', parentPhone));
                    const phoneSnapshot = await getDocs(phoneQuery);
                    
                    phoneSnapshot.forEach(learnerDoc => {
                        // Check if this learner is already added (to avoid duplicates)
                        const alreadyAdded = children.some(child => child.id === learnerDoc.id);
                        if (!alreadyAdded) {
                            children.push({
                                id: learnerDoc.id,
                                className: className,
                                ...learnerDoc.data()
                            });
                        }
                    });
                }
                
                // Simulate final processing delay
                await new Promise(resolve => setTimeout(resolve, 200));
                
                displayChildren(children);
            } catch (error) {
                console.error('Error loading children:', error);
                alert('Error loading children data');
                
                // Reset container on error
                const childrenContainer = document.getElementById('childrenContainer');
                childrenContainer.innerHTML = '';
                document.getElementById('noChildrenMessage').classList.remove('hidden');
            }
        };

        window.displayChildren = function(children) {
            const container = document.getElementById('childrenContainer');
            const noChildrenMsg = document.getElementById('noChildrenMessage');
            
            if (children.length === 0) {
                noChildrenMsg.classList.remove('hidden');
                container.innerHTML = '';
                return;
            }
            
            noChildrenMsg.classList.add('hidden');
            container.innerHTML = '';
            
            children.forEach(child => {
                const childCard = document.createElement('div');
                childCard.className = 'child-card rounded-2xl p-6 text-white cursor-pointer transform hover:scale-105 transition-transform';
                childCard.onclick = () => showChildDetails(child);
                
                childCard.innerHTML = `
                    <div class="flex items-center justify-between mb-4">
                        <div>
                            <h3 class="text-xl font-bold">${child.name}</h3>
                            <p class="text-purple-100 text-sm">${child.className}</p>
                        </div>
                        <i class="fas fa-graduation-cap text-3xl text-white opacity-80"></i>
                    </div>
                    <div class="text-center">
                        <p class="text-3xl font-bold">${child.points}</p>
                        <p class="text-sm text-purple-100">Current Points</p>
                    </div>
                `;
                
                container.appendChild(childCard);
            });
        };

        window.showChildDetails = function(child) {
            document.getElementById('childModalName').textContent = child.name;
            document.getElementById('childName').textContent = child.name;
            document.getElementById('childClass').textContent = child.className;
            document.getElementById('childPoints').textContent = child.points;
            
            // Display recent activity
            const recentActivity = document.getElementById('recentActivity');
            recentActivity.innerHTML = '';
            
            if (child.adjustments && child.adjustments.length > 0) {
                const recent = child.adjustments.slice(-3).reverse();
                recent.forEach(adjustment => {
                    const date = new Date(adjustment.date).toLocaleDateString();
                    const pointsClass = adjustment.points > 0 ? 'text-green-600' : 'text-red-600';
                    const pointsText = adjustment.points > 0 ? `+${adjustment.points}` : adjustment.points;
                    
                    recentActivity.innerHTML += `
                        <div class="flex justify-between items-center p-3 bg-white rounded-lg">
                            <div>
                                <p class="text-sm font-medium">${adjustment.reason}</p>
                                <p class="text-xs text-gray-500">${date}</p>
                            </div>
                            <span class="font-bold ${pointsClass}">${pointsText}</span>
                        </div>
                    `;
                });
            } else {
                recentActivity.innerHTML = '<p class="text-gray-500 text-center">No activity yet</p>';
            }
            
            // Display full history
            const historyTable = document.getElementById('historyTable');
            historyTable.innerHTML = '';
            
            if (child.adjustments && child.adjustments.length > 0) {
                child.adjustments.reverse().forEach(adjustment => {
                    const date = new Date(adjustment.date).toLocaleDateString();
                    const time = new Date(adjustment.date).toLocaleTimeString();
                    const pointsClass = adjustment.points > 0 ? 'text-green-600' : 'text-red-600';
                    const pointsText = adjustment.points > 0 ? `+${adjustment.points}` : adjustment.points;
                    
                    historyTable.innerHTML += `
                        <tr>
                            <td class="px-4 py-2 text-sm">${date} ${time}</td>
                            <td class="px-4 py-2 text-sm font-medium ${pointsClass}">${pointsText}</td>
                            <td class="px-4 py-2 text-sm">${adjustment.reason}</td>
                            <td class="px-4 py-2 text-sm">${adjustment.adjustedBy}</td>
                        </tr>
                    `;
                });
            }
            
            document.getElementById('childModal').classList.remove('hidden');
        };

        window.closeChildModal = function() {
            document.getElementById('childModal').classList.add('hidden');
        };

        window.logout = function() {
            document.getElementById('dashboardContainer').classList.add('hidden');
            document.getElementById('authContainer').classList.remove('hidden');
            // Clear input fields
            document.getElementById('phoneNumber').value = '';
            document.getElementById('loginPassword').value = '';
            // Clear localStorage
            localStorage.removeItem('parentPhone');
            updateHeaderVisibility();
            showLogin();
        };

        window.showRegistration = function() {
            document.getElementById('loginForm').classList.add('hidden');
            document.getElementById('registrationForm').classList.remove('hidden');
            // Clear input fields
            document.getElementById('phoneNumber').value = '';
            document.getElementById('loginPassword').value = '';
        };

        window.showLogin = function() {
            document.getElementById('registrationForm').classList.add('hidden');
            document.getElementById('loginForm').classList.remove('hidden');
            // Clear input fields
            document.getElementById('parentName').value = '';
            document.getElementById('regPhoneNumber').value = '';
            document.getElementById('childGuardianPhone').value = '';
            document.getElementById('regPassword').value = '';
            document.getElementById('confirmPassword').value = '';
        };

        // Show/hide header based on auth state
        function updateHeaderVisibility() {
            const savedPhone = localStorage.getItem('parentPhone');
            if (savedPhone) {
                document.getElementById('mainHeader').style.display = 'none';
            } else {
                document.getElementById('mainHeader').style.display = 'block';
            }
        }

        // Check if user is already logged in (using localStorage)
        const savedPhone = localStorage.getItem('parentPhone');
        if (savedPhone) {
            loadParentDashboard({ phoneNumber: savedPhone });
        }
        updateHeaderVisibility();

        // We no longer need the recaptcha container since we're not using Firebase Phone Auth
        // But we'll keep the clearRecaptchaContainer function for compatibility
    </script>
</body>
</html>